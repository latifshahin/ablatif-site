<!DOCTYPE html>

<html lang="bn">
<head>
<meta charset="utf-8"/>
  <!-- Google Analytics (keep your existing ID) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X4YNW0E3XG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-X4YNW0E3XG');
  </script>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Transfer Audit Tool v1.1</title>
<style>
:root{
  --bg: #f6f8fb;
  --surface: #ffffff;
  --surface-2:#fbfcfe;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e2e8f0;
  --border-2:#cbd5e1;
  --shadow: 0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.08);
  --shadow-sm: 0 1px 2px rgba(15,23,42,.06);
  --radius: 14px;
  --radius-sm: 10px;

  --primary:#0b57d0;
  --primary-2:#0949ae;
  --danger:#b00020;
  --success:#137333;

  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
}

*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  padding:20px;
  font-family: var(--sans);
  color:var(--text);
  background: radial-gradient(1200px 600px at 10% 0%, #eef4ff 0%, transparent 60%),
              radial-gradient(900px 500px at 90% 10%, #f2f7ff 0%, transparent 55%),
              var(--bg);
  line-height:1.4;
  font-size:14px;
}

/* Layout */
.row{display:flex; gap:16px; flex-wrap:wrap; align-items:stretch;}
.w50{flex:1 1 520px;}
.w100{flex:1 1 100%;}
.grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
.grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;}
@media (max-width: 1100px){ .grid3{grid-template-columns:1fr;} }
@media (max-width: 900px){ .grid2{grid-template-columns:1fr;} body{padding:14px;} }

/* Headings */
h2{margin:0 0 6px; font-size:22px; letter-spacing:.2px;}
h3{margin:0 0 10px; font-size:16px;}
h4{margin:0 0 6px; font-size:14px;}
.muted{color:var(--muted);}
.small{font-size:14px; color:var(--muted);}

/* Cards */
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding:14px;
  box-shadow: var(--shadow-sm);
}
.card.section{scroll-margin-top:88px;}
.card:hover{border-color:#d7deea;}
.divider{height:1px; background:var(--border); margin:14px 0;}

.sectionTitle{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
  flex-wrap:wrap;
}

/* Help / Instruction (collapsible) */
.helpBox{
  margin-top:10px;
  padding:10px 12px;
  border:1px dashed var(--border);
  border-radius:12px;
  background: linear-gradient(180deg, #ffffff 0%, #f9fbff 100%);
}
.helpBox > summary{
  cursor:pointer;
  font-weight:700;
  color: var(--text);
  list-style:none;
  display:flex;
  align-items:center;
  gap:8px;
}
.helpBox > summary::-webkit-details-marker{display:none;}
.helpBox[open]{border-style:solid;}
.helpBody{margin-top:8px; color:var(--muted); font-size:12px; line-height:1.45;}
.helpBody code{font-family:var(--mono); font-size:12px; background:#f1f5f9; padding:1px 6px; border-radius:8px; border:1px solid var(--border);}

/* One-page Summary layout */
.summaryGrid{
  display:grid;
  grid-template-columns:repeat(3, minmax(0, 1fr));
  gap:12px;
  align-items:stretch;
}
@media (max-width: 980px){
  .summaryGrid{grid-template-columns:repeat(2, minmax(0, 1fr));}
}
@media (max-width: 620px){
  .summaryGrid{grid-template-columns:1fr;}
}
.summaryCard{
  border:1px solid var(--border);
  background:var(--surface);
  box-shadow:none;
}
@media print{
  .helpBox{display:none !important;}
  #summaryPageOnly .summaryGrid{grid-template-columns:repeat(2, minmax(0,1fr)) !important;}
}
.tag{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--surface-2);
  font-size:12px;
  color:var(--muted);
}

/* Inputs */
input, select, textarea{
  font:inherit;
  color:var(--text);
}
input[type=file]{margin:6px 0; width:100%;}
input[type=text], input[type=number], select{
  width:100%;
  padding:9px 10px;
  border-radius:12px;
  border:1px solid var(--border-2);
  background: #fff;
  outline:none;
  transition: box-shadow .15s, border-color .15s, transform .02s;
}
input[type=text]:focus, input[type=number]:focus, select:focus{
  border-color: #97b9ff;
  box-shadow: 0 0 0 4px rgba(11,87,208,.12);
}

/* Buttons */
.btnRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center;}
button{
  appearance:none;
  border-radius: 12px;
  border:1px solid var(--border-2);
  background: linear-gradient(180deg, #ffffff 0%, #f7f9fc 100%);
  padding:9px 12px;
  cursor:pointer;
  font-weight:600;
  font-size:12px;
  color: var(--text);
  box-shadow: 0 1px 0 rgba(15,23,42,.04);
  transition: transform .05s, box-shadow .15s, border-color .15s, background .15s;
}
button:hover{border-color:#b7c5da; box-shadow: var(--shadow-sm);}
button:active{transform: translateY(1px);}
button:disabled{opacity:.6; cursor:not-allowed;}

.pillBtn{border-radius:999px;}
.ghost{background:#fff;}
.primary{
  color:#fff;
  border-color: var(--primary);
  background: linear-gradient(180deg, var(--primary) 0%, #0a4fc1 100%);
}
.primary:hover{background: linear-gradient(180deg, var(--primary-2) 0%, #083f9b 100%); border-color: var(--primary-2);}
.danger{
  color:#fff;
  border-color: var(--danger);
  background: linear-gradient(180deg, var(--danger) 0%, #8f0019 100%);
}
.danger:hover{filter:brightness(.96);}

/* Pills in lists */
.pill{
  display:inline-flex;
  align-items:center;
  padding:2px 8px;
  border:1px solid var(--border);
  border-radius:999px;
  margin:2px 6px 2px 0;
  background:var(--surface-2);
  color:var(--muted);
  font-size:12px;
}

/* Lists */
.list{
  max-height:240px;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  background: #fff;
}
.list.twoCol{column-count:2; column-gap:14px;}
.list.twoCol > div{break-inside:avoid; -webkit-column-break-inside:avoid; page-break-inside:avoid; margin-bottom:6px;}
@media (max-width: 900px){ .list.twoCol{column-count:1;} }

/* KPI */
.kpis{display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap:10px; margin-top:10px;}
.kpi{
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  background: linear-gradient(180deg, #ffffff 0%, #fbfcfe 100%);
  box-shadow: var(--shadow-sm);
}
.kpi .label{font-size:12px; color:var(--muted);}
.kpi .value{font-size:18px; font-weight:800; margin-top:6px; letter-spacing:.2px;}
.kpi .sub{font-size:12px; color:var(--muted); margin-top:2px;}
@media (max-width: 1050px){ .kpis{grid-template-columns: repeat(2, minmax(180px, 1fr));} }

/* Table */
.scrollTable{max-height:420px; overflow:auto; border:1px solid var(--border); border-radius:14px; background:#fff;}
table{border-collapse:separate; border-spacing:0; width:100%; margin-top:10px;}
th,td{
  border-bottom:1px solid var(--border);
  padding:8px 10px;
  font-size:12px;
  vertical-align:top;
  background:#fff;
}
th{
  position:sticky; top:0;
  background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
  color:#0f172a;
  text-align:left;
  font-weight:800;
  z-index:2;
  border-bottom:1px solid #dbe3ee;
}
tbody tr:hover td{background:#f8fbff;}
td.num{text-align:right; font-variant-numeric: tabular-nums;}
code{font-family:var(--mono); font-size:12px;}

/* Navbar (no bootstrap needed) */
.navbar{
  position:sticky;
  top:0;
  z-index:50;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
  border:1px solid var(--border);
  border-radius: 16px;
  box-shadow: var(--shadow);
  margin-bottom:12px;
  padding:8px 10px;
}
.navbar .container-fluid{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
.navbar-nav{display:flex; gap:8px; flex-wrap:wrap; list-style:none; padding:0; margin:0;}
.nav-link{
  display:inline-flex;
  align-items:center;
  gap:6px;
  text-decoration:none;
  font-size:12px;
  font-weight:700;
  color: var(--primary);
  padding:7px 10px;
  border:1px solid #d7e3ff;
  border-radius:999px;
  background:#f5f9ff;
}
.nav-link:hover{background:#eaf2ff;}
.badge{
  display:inline-flex;
  align-items:center;
  height:26px;
  padding:0 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background: var(--surface-2);
  color: var(--muted);
  font-weight:800;
  font-size:12px;
}
.navbar-toggler{display:none;} /* keep simple */
.collapse.navbar-collapse{display:block;}

/* Credit modal */
.modalOverlay{position:fixed; inset:0; background:rgba(15,23,42,.55); display:none; align-items:center; justify-content:center; z-index:9999; padding:16px;}
.modal{
  background:var(--surface);
  border-radius:18px;
  max-width:560px;
  width:100%;
  box-shadow: var(--shadow);
  border:1px solid var(--border);
  overflow:hidden;
}
.modalHeader{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:10px;}
.modalHeader h3{margin:0; font-size:15px;}
.modalBody{padding:12px 14px; font-size:13px; color:var(--text); line-height:1.45;}
.modalFooter{padding:12px 14px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px;}
.modalClose{border-radius:12px; padding:9px 12px;}

/* Print / PDF */
#printArea{display:none;}
body.printing #printArea{display:block;}
body.printing > *:not(#printArea){display:none !important;}
.pagebreak{display:none;}
@media print{
  body{padding:0; background:#fff;}
  .no-print{display:none !important;}
  .card{border:none; box-shadow:none; padding:0;}
  .navbar{display:none !important;}
  .scrollTable{max-height:none; overflow:visible; border:none;}
  .list{max-height:none; overflow:visible; border:none;}
  th{position:static;}
  .pagebreak{display:block; break-before:page; page-break-before:always;}
  #summary .grid2{grid-template-columns:1fr !important;}
}

/* Summary frame */
.printFrame{background:#fff; padding:12px; border:1px dashed var(--border); border-radius:14px;}
@media print{ .printFrame{border:none; padding:0;} }

/* One-page summary static header */
.sumHeader{
  text-align:center;
  margin-bottom:12px;
  padding:10px 10px 6px;
  border-bottom:1px solid var(--border);
}
.sumBankStatic{
  font-size:20px;
  font-weight:900;
  letter-spacing:.4px;
  margin-bottom:10px;
}
.sumManualGap{
  margin:0 auto 10px;
  max-width:520px;
  padding:10px 14px;
  border:1.5px dashed var(--border);
  border-radius:14px;
  background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.6));
}
.sumLine{
  height:16px;
  border-bottom:1px dotted var(--border);
}
.sumAuditStatic{
  font-size:14px;
  font-weight:800;
  letter-spacing:.6px;
  text-transform:none;
  margin-top:6px;
}

/* Footnote credit / prepared-by */
.sumFootnote{
  margin-top:12px;
  padding-top:10px;
  border-top:1px solid var(--border);
  font-size:12px;
  color:var(--muted);
}
.sumPreparedTitle{font-weight:800; color:var(--text); margin-bottom:4px;}
.sumPreparedBody{line-height:1.35;}
.sumPreparedNote{margin-top:6px; font-weight:800; letter-spacing:.3px;}

@media print{
  .sumManualGap{border-color:#999;}
  .sumFootnote{color:#000000;}
}

/* Disable credit popup overlay (credit is shown as footnote in summary) */
#creditOverlay{display:none !important;}

</style>

<style>
/* ===== One-page Summary: make Observation full width ===== */
#onePageSummary .sumFootnote{
  grid-column: 1 / -1 !important;
  width: 100% !important;
  max-width: none !important;
}
#onePageSummary #sumObservation{
  font-size: 1.20rem !important;
  line-height: 1.35 !important;
  word-break: break-word;
}

/* Status colors */
#onePageSummary #sumObservation .status-matched{ color:#0aa13a; font-weight:800; }
#onePageSummary #sumObservation .status-not-matched{ color:#8c041d; font-weight:900; }

/* Delta colors (GREEN only when BOTH debit+credit deltas are zero) */
#onePageSummary #sumObservation .delta-good{ color:#1b7f3b; font-weight:900; }
#onePageSummary #sumObservation .delta-bad{ color:#b00020; font-weight:900; }

/* Tables */
#onePageSummary #sumObservation table{
  width:100%;
  border-collapse:collapse;
  margin:8px 0 6px 0;
  font-size:0.98em;
}
#onePageSummary #sumObservation th,
#onePageSummary #sumObservation td{
  border:1px solid #d9d9d9;
  padding:7px 10px;
  text-align:center;
  vertical-align:middle;
}
#onePageSummary #sumObservation th{ background:#f5f7fa; font-weight:800; }
#onePageSummary #sumObservation td.rowhdr{ text-align:left; font-weight:800; background:#fbfbfc; }
</style>

</head>
<body>
<div aria-modal="true" class="modalOverlay" id="creditOverlay" role="dialog">
<div class="modal">
<div class="modalHeader">
<h3>Credit / ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</h3>
<button class="modalClose" onclick="hideCredit()">‚úï</button>
</div>
<div class="modalBody">
<div><b>‡¶Ö‡¶ó‡ßç‡¶∞‡¶£‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶™‡¶ø‡¶è‡¶≤‡¶∏‡¶ø</b></div>
<div style="margin-top:6px;"><b>‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤ ‡¶≤‡¶§‡¶ø‡¶´ (‡¶è‡¶∏‡¶™‡¶ø‡¶ì)</b></div>
<div>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ‡ß¶‡ßß‡ß´‡ß´‡ß®-‡ß©‡ß´‡ßÆ‡ß≠‡ßØ‡ß¨</div>
<div>‡¶á‡¶Æ‡ßá‡¶á‡¶≤: latifshahin@gmail.com</div>
<div class="muted small" style="margin-top:8px;">‡¶è‡¶á ‡¶ü‡ßÅ‡¶≤‡¶ü‡¶ø ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ (Before COB HTML File) ‡¶¨‡¶®‡¶æ‡¶Æ COB report (After COB TXT File) ‡¶Æ‡¶ø‡¶≤‡¶ø‡ßü‡ßá ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø/‡¶Ö‡¶°‡¶ø‡¶ü ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§</div>
</div>
<div class="modalFooter">
<button class="modalClose" onclick="hideCredit()">OK</button>
</div>
</div>
</div>
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom sticky-top d-print-none">
<div class="container-fluid">
<span class="badge bg-secondary me-2">Quick jump</span>
<button class="navbar-toggler" data-bs-target="#quickJumpNav" data-bs-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="quickJumpNav">
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item"><a class="nav-link" href="#upload">Upload</a></li>
<li class="nav-item"><a class="nav-link" href="#auditHtml">HTML missing</a></li>
<li class="nav-item"><a class="nav-link" href="#auditTxt">TXT missing</a></li>
<li class="nav-item"><a class="nav-link" href="#summary">Category summary</a></li>
<li class="nav-item"><a class="nav-link" href="#txTools">Tx tools</a></li>
</ul>
</div>
</div>
</nav>
<h2>Transfer Audit Tool v1.1</h2>
<div class="small muted">
  ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø: ‡¶¶‡ßÅ‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá <b>Missing FT ref</b> ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ, ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø missing FT-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ú‡ßú‡¶ø‡¶§ <b>Inputter, Amount, Dr/Cr Category</b> ‡¶∏‡¶π <b>‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</b> ‡¶¶‡ßá‡¶ñ‡¶æ/‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡•§<br/>
  ‚úÖ <b>HTML missing in TXT</b> ‡¶è‡¶¨‡¶Ç ‚úÖ <b>TXT missing in HTML</b> ‚Äî ‡¶¶‡ßÅ‡¶ü‡ßã‡¶á <b>‡¶≠‡¶ø‡¶â ‡¶Æ‡ßÅ‡¶°‡ßá</b> ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¶‡ßÅ‡¶¶‡¶ø‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø <b>‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ filter</b> ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
</div>
<div class="row" style="margin-top:12px;">
<div class="card w50 section" id="upload">
<div class="sectionTitle"><h3>Step 1 ‚Äî ‡¶´‡¶æ‡¶á‡¶≤ Upload</h3><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('upload')">PDF Preview</button></div></div>
<div><b>Before COB (HTML register): Daily transfer register saved as .html</b> <input accept=".html,.htm,text/html" id="htmlFile" type="file"/></div>
<div><b>After COB (TXT register): After COB transfer register saved as .txt</b> <input accept=".txt,text/plain" id="txtFile" type="file"/></div>
<div class="btnRow">
<button onclick="loadAll()">Load &amp; Compare</button>
<span class="small muted" id="status"></span>
</div>
<div class="small muted" style="margin-top:8px;">
      Debug: ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ï‡ßç‡¶∏‡ßá parse/compare counts ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‚Äî‡¶Ø‡¶¶‡¶ø ref 0 ‡¶π‡ßü ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßã‡¶ù‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá TXT/HTML ‡¶•‡ßá‡¶ï‡ßá ref ‡¶™‡ßú‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§
    </div>
</div>
<div class="card w50 section" id="debugBox">
<div class="sectionTitle"><h3>Debug / Counts</h3><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('debugBox')">PDF Preview</button></div></div>
<div class="small" id="debug" style="white-space:pre-wrap;"></div>
</div>
<div class="card w100 section" id="kpis">
<div class="sectionTitle">
<h3>üìå At-a-glance</h3>
<div class="right no-print">
<button class="pillBtn ghost" onclick="printSection('kpis')">PDF Preview</button>
</div>
</div>
<div class="kpis">
<div class="kpi">
<div class="label">HTML ‚Äî Rows / Unique FT</div>
<div class="value" id="kpiHtmlRows">0</div>
<div class="sub">Unique: <span id="kpiHtmlRefs">0</span></div>
</div>
<div class="kpi">
<div class="label">TXT ‚Äî Rows / Unique FT</div>
<div class="value" id="kpiTxtRows">0</div>
<div class="sub">Unique: <span id="kpiTxtRefs">0</span></div>
</div>
<div class="kpi">
<div class="label">Missing counts</div>
<div class="value"><span id="kpiHtmlMissing">0</span> / <span id="kpiTxtMissing">0</span></div>
<div class="sub">HTML-in-TXT / TXT-in-HTML</div>
</div>
<div class="kpi">
<div class="label">Cross-file totals (Summary filters)</div>
<div class="value">ŒîDebit: <span id="kpiDebitDelta">0.00</span></div>
<div class="sub">ŒîCredit: <span id="kpiCreditDelta">0.00</span></div>
</div>
</div>
</div>
<div class="card w100 section" id="summaryOnePage">
<div class="sectionTitle">
<h3>üßæ One-page Audit Summary (Print / Save as PDF)</h3>
<div class="right no-print">
<button class="pillBtn" onclick="printSummaryPage()">Print / Save PDF</button>
<button class="pillBtn ghost" onclick="downloadFindingsCSV()">Export Findings (CSV)</button>
</div>
</div>
<div class="printFrame" id="summaryPageOnly">
<div class="sumHeader">
<div class="sumBankStatic">AGRANI BANK PLC</div>
<div aria-label="Manual notes area" class="sumManualGap">
<div class="sumLine"></div>
</div>
<div class="sumAuditStatic">Auditing Daily Transfer Register</div>
</div>
<div class="summaryGrid">
<div class="card summaryCard">
<div class="small muted">Files</div>
<div class="small">Before COB (HTML): <span id="sumHtmlFile">‚Äî</span></div>
<div class="small">After COB (TXT): <span id="sumTxtFile">‚Äî</span></div>
</div>
<div class="card summaryCard">
<div class="small muted">Key Metrics</div>
<div class="small">HTML unique FT refs: <b><span id="sumHtmlRefs">0</span></b></div>
<div class="small">TXT unique FT refs: <b><span id="sumTxtRefs">0</span></b></div>
<div class="small">Matched refs: <b><span id="sumMatched">0</span></b></div>
</div>
<div class="card summaryCard">
<div class="small muted">Findings</div>
<div class="small">HTML missing in TXT: <b><span id="sumMissInTxt">0</span></b></div>
<div class="small">TXT missing in HTML: <b><span id="sumMissInHtml">0</span></b></div>
<div class="small">Amount mismatch: <b><span id="sumAmtMismatch">0</span></b></div>
</div>
<div class="card summaryCard">
<div class="small muted">Totals (per file)</div>
<div class="small">HTML Debit Total: <b><span id="sumHtmlDebitTotal">0.00</span></b></div>
<div class="small">HTML Credit Total: <b><span id="sumHtmlCreditTotal">0.00</span></b></div>
<div class="small">TXT Debit Total: <b><span id="sumTxtDebitTotal">0.00</span></b></div>
<div class="small">TXT Credit Total: <b><span id="sumTxtCreditTotal">0.00</span></b></div>
</div>
<div class="card summaryCard">
<div class="small muted">Largest Transactions</div>
<div class="small">Max Debit: <b><span id="sumMaxDebitAmt">0.00</span></b> ¬† | ¬† Ref: <span id="sumMaxDebitRef">‚Äî</span> ¬† | ¬† Source: <span id="sumMaxDebitSrc">‚Äî</span></div>
<div class="small">Max Credit: <b><span id="sumMaxCreditAmt">0.00</span></b> ¬† | ¬† Ref: <span id="sumMaxCreditRef">‚Äî</span> ¬† | ¬† Source: <span id="sumMaxCreditSrc">‚Äî</span></div>
</div>
<div class="card summaryCard">
<div class="small muted">Data quality</div>
<div class="small">HTML duplicate FT refs: <b><span id="sumDupHtml">0</span></b></div>
<div class="small">TXT duplicate FT refs: <b><span id="sumDupTxt">0</span></b></div>
<div class="small">Blank/invalid refs: <b><span id="sumBlankRefs">0</span></b></div>
</div>

</div>
<div class="grid2" style="gap:12px; margin-top:12px;">
<div class="card summaryCard">
<div class="small muted">Inputter Summary (HTML)</div>
<div class="small muted">Count + Total Amount</div>
<div class="small" id="sumHtmlInputterTable" style="margin-top:6px;"></div>
</div>
<div class="card summaryCard">
<div class="small muted">Inputter Summary (TXT)</div>
<div class="small muted">Count + Total Amount</div>
<div class="small" id="sumTxtInputterTable" style="margin-top:6px;"></div>
</div>
</div>
<div class="sumFootnote">
<div class="small muted">Observation</div>
<div class="small" id="sumObservation">‚Äî</div>
</div>
<div class="sumFootnote">
<div class="sumPreparedTitle">Prepared by</div>
<div class="sumPreparedBody">
      Abdul Latif (SPO)<br/>
      Agrani Bank PLC, Jamalpur Branch<br/>
      Contact: 01552358796 ¬† | ¬† Email: latifshahin@gmail.com
    </div>
<div class="sumPreparedNote">For Internal Audit &amp; Control Purpose Only</div>
</div>
</div>
</div>
<div class="card w100 section" id="auditHtml">
<div class="sectionTitle"><h3>‚úÖ Audit Result 1: HTML-‡¶è ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ TXT-‡¶è ‡¶®‡ßá‡¶á (Full Details)</h3><div class="right no-print"><label class="small muted" style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input id="htmlCompact" onchange="applyMissing(\'html\')" type="checkbox"/> Compact view</label><button class="pillBtn ghost" onclick="printSection('auditHtml')">PDF Preview</button></div></div>
<div class="small muted" id="htmlMissCount"></div>
<div class="card" style="background:#fbfbfb;">
<div class="grid2">
<div>
<div class="small muted"><b>Search (HTML missing)</b></div>
<input id="htmlMissSearch" placeholder="FT / Account / Title / Inputter / Category" style="width:100%; padding:8px; border-radius:8px; border:1px solid #bbb;" type="text"/>
</div>
<div>
<div class="small muted"><b>Amount range (optional)</b></div>
<div class="btnRow">
<input id="htmlMinAmt" placeholder="Min (any)" step="0.01" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;" type="number"/>
<input id="htmlMaxAmt" placeholder="Max (any)" step="0.01" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;" type="number"/>
</div>
</div>
</div>
<div class="grid3" style="margin-top:10px;">
<div>
<div class="small muted"><b>Inputter Select/Deselect</b></div>
<div class="list twoCol" id="htmlMissInputters"></div>
<div class="btnRow">
<button onclick="checkAll('htmlMissInputters', true)">Select all</button>
<button onclick="checkAll('htmlMissInputters', false)">Clear</button>
</div>
</div>
<div>
<div class="small muted"><b>Dr.Category Select/Deselect</b></div>
<div class="list twoCol" id="htmlMissDrCats"></div>
<div class="btnRow">
<button onclick="checkAll('htmlMissDrCats', true)">Select all</button>
<button onclick="checkAll('htmlMissDrCats', false)">Clear</button>
</div>
</div>
<div>
<div class="small muted"><b>Cr.Category Select/Deselect</b></div>
<div class="list twoCol" id="htmlMissCrCats"></div>
<div class="btnRow">
<button onclick="checkAll('htmlMissCrCats', true)">Select all</button>
<button onclick="checkAll('htmlMissCrCats', false)">Clear</button>
</div>
</div>
</div>
<div class="btnRow">
<button onclick="applyMissing('html')">Apply</button>
<button onclick="resetMissing('html')">Reset</button>
<button onclick="copyRefs('html')">Copy FT list</button>
<button onclick="downloadCSV('html')">Download CSV</button>
</div>
</div>
<div class="scrollTable" style="margin-top:10px;">
<table id="htmlMissTable">
<thead><tr id="htmlMissHead"></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="card w100 section" id="auditTxt">
<div class="sectionTitle"><h3>‚úÖ Audit Result 2: TXT-‡¶è ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ HTML-‡¶è ‡¶®‡ßá‡¶á (Full Details)</h3><div class="right no-print"><label class="small muted" style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input id="txtCompact" onchange="applyMissing(\'txt\')" type="checkbox"/> Compact view</label><button class="pillBtn ghost" onclick="printSection('auditTxt')">PDF Preview</button></div></div>
<div class="small muted" id="txtMissCount"></div>
<div class="card" style="background:#fbfbfb;">
<div class="grid2">
<div>
<div class="small muted"><b>Search (TXT missing)</b></div>
<input id="txtMissSearch" placeholder="FT / Account / Title / Inputter / Category" style="width:100%; padding:8px; border-radius:8px; border:1px solid #bbb;" type="text"/>
</div>
<div>
<div class="small muted"><b>Amount range (optional)</b></div>
<div class="btnRow">
<input id="txtMinAmt" placeholder="Min (any)" step="0.01" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;" type="number"/>
<input id="txtMaxAmt" placeholder="Max (any)" step="0.01" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;" type="number"/>
</div>
</div>
</div>
<div class="grid3" style="margin-top:10px;">
<div>
<div class="small muted"><b>Inputter Select/Deselect</b></div>
<div class="list twoCol" id="txtMissInputters"></div>
<div class="btnRow">
<button onclick="checkAll('txtMissInputters', true)">Select all</button>
<button onclick="checkAll('txtMissInputters', false)">Clear</button>
</div>
</div>
<div>
<div class="small muted"><b>Dr.Category Select/Deselect</b></div>
<div class="list twoCol" id="txtMissDrCats"></div>
<div class="btnRow">
<button onclick="checkAll('txtMissDrCats', true)">Select all</button>
<button onclick="checkAll('txtMissDrCats', false)">Clear</button>
</div>
</div>
<div>
<div class="small muted"><b>Cr.Category Select/Deselect</b></div>
<div class="list twoCol" id="txtMissCrCats"></div>
<div class="btnRow">
<button onclick="checkAll('txtMissCrCats', true)">Select all</button>
<button onclick="checkAll('txtMissCrCats', false)">Clear</button>
</div>
</div>
</div>
<div class="btnRow">
<button onclick="applyMissing('txt')">Apply</button>
<button onclick="resetMissing('txt')">Reset</button>
<button onclick="copyRefs('txt')">Copy FT list</button>
<button onclick="downloadCSV('txt')">Download CSV</button>
</div>
</div>
<div class="scrollTable" style="margin-top:10px;">
<table id="txtMissTable">
<thead><tr id="txtMissHead"></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="card w100 section" id="summary">
<div class="sectionTitle"><h3>Category Summary (Filtered) ‚Äî Important</h3><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('summary')">PDF Preview</button></div></div>
<div class="small muted">
      HTML ‡¶è‡¶¨‡¶Ç TXT‚Äî‡¶¶‡ßÅ‡¶á ‡¶™‡¶æ‡¶∂‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ Inputter Select/Deselect ‡¶Ü‡¶õ‡ßá‡•§ ‡¶ü‡¶ø‡¶ï/‡¶Ü‡¶®‡¶ü‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá Category-wise Total Debit/Credit ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§
    </div>
<div class="grid2" style="margin-top:10px;">
<div class="card section" id="summaryHtml" style="background:#fbfbfb;">
<div class="sectionTitle"><h4 style="margin:0 0 6px;">HTML Summary ‚Äî Inputter Filter</h4><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('summaryHtml')">PDF (HTML Summary)</button></div></div>
<div class="small muted">HTML Debit/Credit difference: <b id="htmlSumDiff">0.00</b></div>
<div class="list twoCol" id="htmlSumInputters"></div>
<div class="btnRow">
<button onclick="checkAll('htmlSumInputters', true)">Select all</button>
<button onclick="checkAll('htmlSumInputters', false)">Clear</button>
<button onclick="generateSummary('html')">Generate</button>
<button onclick="downloadSummaryCSV('html')">Download CSV</button>
</div>
<div class="grid2" style="margin-top:10px;">
<div>
<div class="small muted"><b>Debit by Dr.Category</b></div>
<table id="htmlSumDrTable">
<thead><tr><th>Dr.Category</th><th class="num">Total Debit</th></tr></thead>
<tbody></tbody>
<tfoot><tr><th>Total</th><th class="num" id="htmlSumDrTotal">0.00</th></tr></tfoot>
</table>
</div>
<div>
<div class="small muted"><b>Credit by Cr.Category</b></div>
<table id="htmlSumCrTable">
<thead><tr><th>Cr.Category</th><th class="num">Total Credit</th></tr></thead>
<tbody></tbody>
<tfoot><tr><th>Total</th><th class="num" id="htmlSumCrTotal">0.00</th></tr></tfoot>
</table>
</div>
</div>
</div>
<div class="pagebreak"></div>
<div class="card section" id="summaryTxt" style="background:#fbfbfb;">
<div class="sectionTitle"><h4 style="margin:0 0 6px;">TXT Summary ‚Äî Inputter Filter</h4><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('summaryTxt')">PDF (TXT Summary)</button></div></div>
<div class="small muted" style="margin:6px 0 8px;">
      <label style="display:inline-flex; align-items:center; gap:6px;">
        <input type="checkbox" id="txtHideSystem" checked onchange="renderSummaryInputters(); refreshOnePageObservation();"/>
        Exclude system-generated inputters (recommended)
      </label>
      <span class="muted">‚Äî System examples: SMARTBANK, EFTHO01, etc.</span>
    </div>
    <div class="list twoCol" id="txtSumInputters"></div>
<div class="btnRow">
<button onclick="checkAll('txtSumInputters', true)">Select all</button>
<button onclick="checkAll('txtSumInputters', false)">Clear</button>
<button onclick="generateSummary('txt')">Generate</button>
<button onclick="downloadSummaryCSV('txt')">Download CSV</button>
</div>
<div class="grid2" style="margin-top:10px;">
<div>
<div class="small muted"><b>Debit by Dr.Category</b></div>
<table id="txtSumDrTable">
<thead><tr><th>Dr.Category</th><th class="num">Total Debit</th></tr></thead>
<tbody></tbody>
<tfoot><tr><th>Total</th><th class="num" id="txtSumDrTotal">0.00</th></tr></tfoot>
</table>
</div>
<div>
<div class="small muted"><b>Credit by Cr.Category</b></div>
<table id="txtSumCrTable">
<thead><tr><th>Cr.Category</th><th class="num">Total Credit</th></tr></thead>
<tbody></tbody>
<tfoot><tr><th>Total</th><th class="num" id="txtSumCrTotal">0.00</th></tr></tfoot>
</table>
</div>
</div>
<div class="small muted" style="margin-top:8px;">
          TXT Debit/Credit difference: <b id="txtSumDiff">0.00</b>
<div class="divider"></div>
<div class="small muted"><b>HTML vs TXT Difference (Summary filters applied)</b><br/>
          ŒîDebit (HTML - TXT): <b id="sumDebitDelta">0.00</b><br/>
          ŒîCredit (HTML - TXT): <b id="sumCreditDelta">0.00</b>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="card w100 section" id="txTools">
  <div class="sectionTitle">
    <h3>üîé Transaction Finder &amp; User Activity</h3>
    <div class="right no-print">
      <button class="pillBtn ghost" onclick="printSection('txTools')">PDF Preview</button>
      <button class="pillBtn" onclick="downloadTxFinder('csv')">Download CSV</button>
      <button class="pillBtn ghost" onclick="downloadTxFinder('txt')">Download TXT</button>
      <button class="pillBtn ghost" onclick="downloadTxFinder('html')">Download HTML</button>
    </div>
  </div>
  <div class="small muted">
    ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã <b>FT ref / Account / Title / Inputter</b> ‡¶¶‡¶ø‡ßü‡ßá ‡¶¶‡ßÅ‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡ßá transaction ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®, ‡¶è‡¶¨‡¶Ç
    ‡¶™‡ßç‡¶∞‡¶§‡¶ø Inputter-‡¶è‡¶∞ <b>total / highest transaction</b> ‡¶∏‡¶π quick audit view ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§
  </div>

  <div class="grid3" style="margin-top:10px;">
    <div class="card" style="background:#fbfbfb;">
      <div class="small muted"><b>Search query</b></div>
      <input id="txQuery" type="text" placeholder="FT26033... / Account / Name / Inputter" />
      <div class="btnRow">
        <select id="txSource">
          <option value="both">Source: Both</option>
          <option value="html">Source: HTML only</option>
          <option value="txt">Source: TXT only</option>
        </select>
        <select id="txField">
          <option value="any">Match: Any field</option>
          <option value="ref">Match: FT ref</option>
          <option value="account">Match: Account</option>
          <option value="title">Match: Title</option>
          <option value="inputter">Match: Inputter</option>
        </select>
      </div>
      <div class="btnRow">
        <button class="primary" onclick="runTxFinder()">Search</button>
        <button onclick="resetTxFinder()">Reset</button>
        <button class="ghost" onclick="setTxFinderMissing('html')">HTML missing in TXT</button>
        <button class="ghost" onclick="setTxFinderMissing('txt')">TXT missing in HTML</button>
      </div>
      <div class="small muted" style="margin-top:8px;">
        Tip: "HTML missing in TXT" ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶ì‡¶á missing list auto-load ‡¶π‡¶¨‡ßá‡•§
      </div>
    </div>

    <div class="card" style="background:#fbfbfb;">
      <div class="small muted"><b>Inputter quick select</b></div>
      <select id="txInputterSelect"></select>
      <div class="btnRow">
        <button onclick="applyTxInputter()">Apply Inputter</button>
        <button class="ghost" onclick="clearTxInputter()">Clear</button>
      </div>
      <div class="divider"></div>
      <div class="small muted"><b>Quick stats (current results)</b></div>
      <div class="small">Rows: <b id="txStatRows">0</b></div>
      <div class="small">Total Debit: <b id="txStatDebit">0.00</b></div>
      <div class="small">Total Credit: <b id="txStatCredit">0.00</b></div>
      <div class="small">Highest amount: <b id="txStatMaxAmt">0.00</b> (Ref: <span id="txStatMaxRef">‚Äî</span>, Source: <span id="txStatMaxSrc">‚Äî</span>)</div>
    </div>

    <div class="card" style="background:#fbfbfb;">
      <div class="small muted"><b>Data quality checks</b></div>
      <div class="small">Blank/invalid FT refs: <b id="txDQBlankRefs">0</b></div>
      <div class="small">Blank debit/credit amount rows: <b id="txDQBlankAmt">0</b></div>
      <div class="small">Blank account/title rows: <b id="txDQBlankAcTitle">0</b></div>
      <div class="divider"></div>
      <div class="small muted">
        Missing refs summary (all):
        HTML missing in TXT = <b id="txDQMissHtml">0</b> ,
        TXT missing in HTML = <b id="txDQMissTxt">0</b>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <div class="grid2" style="margin-top:10px;">
    <div class="card" style="background:#fbfbfb;">
      <div class="sectionTitle">
        <h4 style="margin:0;">Inputter Summary (Both files)</h4>
        <div class="right no-print">
          <button class="pillBtn ghost" onclick="downloadInputterSummaryCSV()">Download CSV</button>
        </div>
      </div>
      <div class="small muted">Count + Total (Debit/Credit) + Highest amount (click an inputter to load into finder)</div>
      <div class="scrollTable" style="margin-top:8px;">
        <table id="txUserTable">
          <thead>
            <tr>
              <th>Inputter</th>
              <th class="num">Rows</th>
              <th class="num">Total Debit</th>
              <th class="num">Total Credit</th>
              <th class="num">Highest Amt</th>
              <th>Ref</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="background:#fbfbfb;">
      <div class="sectionTitle">
        <h4 style="margin:0;">Transaction Results</h4>
        <div class="right no-print">
          <span class="tag" id="txResultTag">‚Äî</span>
        </div>
      </div>
      <div class="small muted" id="txResultInfo">Search to view results‚Ä¶</div>
      <div class="scrollTable" style="margin-top:8px;">
        <table id="txResultTable">
          <thead>
            <tr>
              <th>Source</th>
              <th>FT ref</th>
              <th>Debit Ac</th>
              <th>Debit Title</th>
              <th class="num">Debit Amt</th>
              <th>Credit Ac</th>
              <th>Credit Title</th>
              <th class="num">Credit Amt</th>
              <th>Inputter</th>
              <th>Authoriser</th>
              <th>Time</th>
              <th>Dr.Cat</th>
              <th>Cr.Cat</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<script>
let htmlRows = [];
let txtRows = [];
let htmlMeta = {bank:'‚Äî', branch:'‚Äî', register:'‚Äî', date:'‚Äî'};
let missingHtmlAll = [];
let missingTxtAll = [];
let missingHtmlFiltered = [];
let missingTxtFiltered = [];

const HTML_COLS = [
  {k:'tr_debit', label:'TR(Debit)'},
  {k:'debit_ac', label:'Debit.Ac.no'},
  {k:'debit_legacy', label:'Debit Legacy'},
  {k:'debit_title', label:'Debit Acct.Title'},
  {k:'debit_amt', label:'Debit.Amt'},
  {k:'cheque', label:'Chq'},
  {k:'dr_cat', label:'Dr.Category'},
  {k:'tr_credit', label:'TR(Credit)'},
  {k:'credit_ac', label:'Credit.Ac.no'},
  {k:'credit_legacy', label:'Credit Legacy'},
  {k:'credit_title', label:'Credit Acct.Title'},
  {k:'credit_amt', label:'Credit.Amt'},
  {k:'cr_cat', label:'Cr.Category'},
  {k:'type', label:'Type'},
  {k:'ref', label:'Trans.Rf.No'},
  {k:'bulk_ref', label:'Bulk.Rf.No'},
  {k:'inputter', label:'Inputter'},
  {k:'authoriser', label:'Authoriser'},
  {k:'time', label:'Time'},
  {k:'debit_branch', label:'Debit Branch'},
  {k:'credit_branch', label:'Credit Branch'}
];

const TXT_COLS = [
  {k:'tr_debit', label:'Tr'},
  {k:'debit_ac', label:'Debit Ac no'},
  {k:'debit_legacy', label:'Legacy no'},
  {k:'debit_title', label:'Debit Account Title'},
  {k:'debit_amt', label:'Debit Amount'},
  {k:'cheque', label:'Cheque'},
  {k:'dr_cat', label:'Dr.Category'},
  {k:'tr_credit', label:'Tr'},
  {k:'credit_ac', label:'Credit Ac no'},
  {k:'credit_legacy', label:'Legacy no'},
  {k:'credit_title', label:'Credit Account Title'},
  {k:'credit_amt', label:'Credit Amount'},
  {k:'cr_cat', label:'Cr.Category'},
  {k:'type', label:'Type'},
  {k:'ref', label:'Trans ref no'},
  {k:'inputter', label:'Inputter'},
  {k:'authoriser', label:'Authoriser'},
  {k:'time', label:'Time'}
];

// Compact columns (requested)
const HTML_COLS_COMPACT = [
  {k:'debit_ac', label:'Debit.Ac.no'},
  {k:'debit_legacy', label:'Debit Legacy'},
  {k:'debit_title', label:'Debit Acct.Title'},
  {k:'debit_amt', label:'Debit.Amt'},
  {k:'credit_ac', label:'Credit.Ac.no'},
  {k:'credit_legacy', label:'Credit Legacy'},
  {k:'credit_title', label:'Credit Acct.Title'},
  {k:'credit_amt', label:'Credit.Amt'},
  {k:'ref', label:'Trans.Rf.No'},
];

const TXT_COLS_COMPACT = [
  {k:'debit_ac', label:'Debit.Ac.no'},
  {k:'debit_legacy', label:'Debit Legacy'},
  {k:'debit_title', label:'Debit Acct.Title'},
  {k:'debit_amt', label:'Debit.Amt'},
  {k:'credit_ac', label:'Credit.Ac.no'},
  {k:'credit_legacy', label:'Credit Legacy'},
  {k:'credit_title', label:'Credit Acct.Title'},
  {k:'credit_amt', label:'Credit.Amt'},
  {k:'ref', label:'Trans.Rf.No'},
];



function setStatus(msg){ document.getElementById('status').textContent = msg; }
function debug(msg){ document.getElementById('debug').textContent = msg; }

function readFile(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsText(file);
  });
}

function toNum(s){
  if(s === null || s === undefined) return NaN;
  const t = String(s).replace(/,/g,'').trim();
  if(!t) return NaN;
  const n = Number(t);
  return isFinite(n) ? n : NaN;
}

function fmt(n){
  const x = Number(n);
  return (isFinite(x) ? x : 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}

function uniq(arr){
  return [...new Set(arr.filter(x => x !== null && x !== undefined && String(x).trim() !== '').map(x=>String(x)))];
}

function normalizeFT(val){
  if(!val) return '';
  const m = String(val).match(/\bFT[0-9A-Z]+\b/);
  return m ? m[0].trim() : String(val).trim();
}

function rowText(row){
  return Object.values(row).map(v => (v ?? '').toString().toLowerCase()).join(' | ');
}

/* TXT parsing */
function findHeaderLine(lines){
  const want = ['Debit Amount', 'Dr.Category', 'Credit Amount', 'Cr.Category', 'Trans ref no', 'Inputter', 'Authoriser', 'Time'];
  for (let i=0; i<lines.length; i++){
    const L = lines[i];
    let ok = true;
    for (const w of want){
      if (!L.includes(w)) { ok = false; break; }
    }
    if (ok) return {index: i, line: L};
  }
  return null;
}

function nthIndexOf(str, sub, n){
  let idx = -1, from = 0;
  for (let i = 0; i < n; i++){
    idx = str.indexOf(sub, from);
    if (idx < 0) return -1;
    from = idx + sub.length;
  }
  return idx;
}

function buildRangesFromHeader(headerLine){
  const cols = [
    {key:'Tr', name:'tr_debit', occ:1},
    {key:'Debit Ac no', name:'debit_ac', occ:1},
    {key:'Legacy no', name:'debit_legacy', occ:1},
    {key:'Debit Account Title', name:'debit_title', occ:1},
    {key:'Debit Amount', name:'debit_amt', occ:1},
    {key:'Cheque', name:'cheque', occ:1},
    {key:'Dr.Category', name:'dr_cat', occ:1},
    {key:'Tr', name:'tr_credit', occ:2},
    {key:'Credit Ac no', name:'credit_ac', occ:1},
    {key:'Legacy no', name:'credit_legacy', occ:2},
    {key:'Credit Account Title', name:'credit_title', occ:1},
    {key:'Credit Amount', name:'credit_amt', occ:1},
    {key:'Cr.Category', name:'cr_cat', occ:1},
    {key:'Type', name:'type', occ:1},
    {key:'Trans ref no', name:'ref', occ:1},
    {key:'Inputter', name:'inputter', occ:1},
    {key:'Authoriser', name:'authoriser', occ:1},
    {key:'Time', name:'time', occ:1},
  ];

  const starts = [];
  for (const c of cols){
    const s = nthIndexOf(headerLine, c.key, c.occ || 1);
    if (s >= 0) starts.push({name:c.name, start:s});
  }
  starts.sort((a,b)=>a.start-b.start);

  const ranges = [];
  for (let i=0; i<starts.length; i++){
    const cur = starts[i];
    const end = (i < starts.length-1) ? starts[i+1].start : headerLine.length + 120;
    ranges.push({name: cur.name, start: cur.start, end});
  }
  return ranges;
}

function sliceByRange(line, ranges, name){
  const r = ranges.find(x=>x.name===name);
  if(!r) return '';
  return line.substring(r.start, Math.min(r.end, line.length)).trim();
}

function parseTXTFixedWidth(tText){
  const lines = tText.split(/\r?\n/);
  const hdr = findHeaderLine(lines);
  if(!hdr) return {rows:[], refCount:0, note:"Header not found"};

  // --- meta: bank/branch/date (best-effort) ---
  const headText = lines.slice(0, Math.min(hdr.index+1, 40)).join(" ").replace(/\s+/g," ").trim();
  const bankMatch = headText.match(/([A-Z][A-Z\s\.]+BANK\s+P\.?L\.?C\.?|[A-Z][A-Z\s\.]+BANK\s+LIMITED)/i);
  const branchMatch = headText.match(/([A-Z][A-Z\s]+BRANCH)/i);
  const dateMatch = headText.match(/(\b[0-9]{4}[-\/][0-9]{2}[-\/][0-9]{2}\b|\b[0-9]{1,2}\s+[A-Z]{3}\s+[0-9]{4}\b)/i);
  const bank = bankMatch ? bankMatch[1].toUpperCase().replace(/\s+/g," ").trim() : "‚Äî";
  const branch = branchMatch ? branchMatch[1].toUpperCase().replace(/\s+/g," ").trim() : "‚Äî";
  const date = dateMatch ? dateMatch[1].toUpperCase().trim() : "‚Äî";

  let ranges = buildRangesFromHeader(hdr.line);
  const rows = [];

  for (let i = hdr.index + 1; i < lines.length; i++){
    const L = lines[i];
    if (!L || !L.trim()) continue;

    if (L.includes('Debit Amount') && L.includes('Trans ref no') && L.includes('Inputter')){
      ranges = buildRangesFromHeader(L);
      continue;
    }

    if (!/\bFT[0-9A-Z]+\b/.test(L)) continue;

    let ref = sliceByRange(L, ranges, 'ref');
    ref = normalizeFT(ref);

    rows.push({
      tr_debit: sliceByRange(L, ranges, 'tr_debit'),
      debit_ac: sliceByRange(L, ranges, 'debit_ac'),
      debit_legacy: sliceByRange(L, ranges, 'debit_legacy'),
      debit_title: sliceByRange(L, ranges, 'debit_title'),
      debit_amt: toNum(sliceByRange(L, ranges, 'debit_amt')),
      cheque: sliceByRange(L, ranges, 'cheque'),
      dr_cat: sliceByRange(L, ranges, 'dr_cat') || '(Blank)',
      tr_credit: sliceByRange(L, ranges, 'tr_credit'),
      credit_ac: sliceByRange(L, ranges, 'credit_ac'),
      credit_legacy: sliceByRange(L, ranges, 'credit_legacy'),
      credit_title: sliceByRange(L, ranges, 'credit_title'),
      credit_amt: toNum(sliceByRange(L, ranges, 'credit_amt')),
      cr_cat: sliceByRange(L, ranges, 'cr_cat') || '(Blank)',
      type: sliceByRange(L, ranges, 'type'),
      ref,
      inputter: sliceByRange(L, ranges, 'inputter') || '(Blank)',
      authoriser: sliceByRange(L, ranges, 'authoriser'),
      time: sliceByRange(L, ranges, 'time')
    });
  }

  const refCount = new Set(rows.map(r=>r.ref).filter(Boolean)).size;
  return {rows, refCount, note:"OK", meta:{bank, branch, date}};
}

/* HTML parsing */
function parseHTML(hText){
  const dom = new DOMParser().parseFromString(hText, 'text/html');

  // Collect visible lines from top (before table header), to avoid grabbing "DEBIT BRANCH / CREDIT BRANCH" etc.
  const rawLines = (dom.body ? (dom.body.innerText || dom.body.textContent || '') : '')
    .replace(/\u00a0/g,' ')
    .split(/\n+/)
    .map(l => l.trim())
    .filter(Boolean);

  const headerLines = [];
  for(const line of rawLines){
    const L = line.toUpperCase();
    if(/TR\(DEBIT\)|DEBIT\.AC|CREDIT\.AC|INPUTTER|AUTHORISER|DEBIT\s+BRANCH|CREDIT\s+BRANCH/.test(L)) break;
    headerLines.push(line);
    if(headerLines.length >= 18) break;
  }
  const headerText = headerLines.join(' ').replace(/\s+/g,' ').trim();
  const pageText = (dom.body ? (dom.body.textContent || '') : '').replace(/\u00a0/g,' ').replace(/\s+/g,' ').trim();

  // BANK
  const bankMatch =
    headerText.match(/\b([A-Z][A-Z\s\.]+BANK\s+(?:LIMITED|PLC))\b/i) ||
    pageText.match(/\b([A-Z][A-Z\s\.]+BANK\s+(?:LIMITED|PLC))\b/i);

  // REGISTER
  const regMatch =
    headerText.match(/\b(DAILY\s+TRANSFER\s+REGISTER)\b/i) ||
    pageText.match(/\b(DAILY\s+TRANSFER\s+REGISTER)\b/i);

  // BRANCH (prefer header), remove trailing digits like "BRANCH2836"
  const branchMatch =
    headerText.match(/\b([A-Z][A-Z\s\-]*BRANCH)\s*\d*\b/i) ||
    pageText.match(/\b([A-Z][A-Z\s\-]*BRANCH)\s*\d*\b/i);

  // BN branch, if present (e.g., "‡¶ú‡¶æ‡¶Æ‡¶æ‡¶≤‡¶™‡ßÅ‡¶∞ ‡¶∂‡¶æ‡¶ñ‡¶æ")
  const branchMatchBn =
    headerText.match(/([‡¶Ö-‡¶πA-Za-z\s\-]+?)\s*‡¶∂‡¶æ‡¶ñ‡¶æ/) ||
    pageText.match(/([‡¶Ö-‡¶πA-Za-z\s\-]+?)\s*‡¶∂‡¶æ‡¶ñ‡¶æ/);

  // DATE
  const dateMatch =
    headerText.match(/Transaction\s*Date\s*[:\-]?\s*([0-9]{1,2}\s+[A-Z]{3}\s+[0-9]{4})/i) ||
    headerText.match(/Transaction\s*Date\s*[:\-]?\s*([0-9]{1,2}[\/\-][0-9]{1,2}[\/\-][0-9]{2,4})/i) ||
    headerText.match(/Transaction\s*Date\s*[:\-]?\s*([0-9]{4}[\/\-][0-9]{1,2}[\/\-][0-9]{1,2})/i) ||
    pageText.match(/Transaction\s*Date\s*[:\-]?\s*([0-9]{1,2}\s+[A-Z]{3}\s+[0-9]{4})/i) ||
    pageText.match(/Transaction\s*Date\s*[:\-]?\s*([0-9]{1,2}[\/\-][0-9]{1,2}[\/\-][0-9]{2,4})/i) ||
    pageText.match(/Transaction\s*Date\s*[:\-]?\s*([0-9]{4}[\/\-][0-9]{1,2}[\/\-][0-9]{1,2})/i);

  const bank = bankMatch ? bankMatch[1].toUpperCase().replace(/\s+/g,' ').trim() : '';
  const register = regMatch ? regMatch[1].toUpperCase().replace(/\s+/g,' ').trim() : '';
  let branch = '';
  if(branchMatchBn){
    branch = (branchMatchBn[1] || '').trim() + ' ‡¶∂‡¶æ‡¶ñ‡¶æ';
  } else if(branchMatch){
    branch = branchMatch[1].toUpperCase().replace(/\s+/g,' ').trim();
  }

  const date = (dateMatch?.[1] || '').toString().trim();

  const trs = dom.querySelectorAll('tr');
  const rows = [];
  trs.forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if (tds.length >= 21){
      const c = Array.from(tds).map(td => td.textContent.replace(/\u00a0/g,' ').trim());
      const ref = normalizeFT(c[14] || '');
      if (ref.startsWith('FT')){
        rows.push({
          tr_debit: c[0] || '',
          debit_ac: c[1] || '',
          debit_legacy: c[2] || '',
          debit_title: c[3] || '',
          debit_amt: toNum(c[4]),
          cheque: c[5] || '',
          dr_cat: (c[6] || '').trim() || '(Blank)',
          tr_credit: c[7] || '',
          credit_ac: c[8] || '',
          credit_legacy: c[9] || '',
          credit_title: c[10] || '',
          credit_amt: toNum(c[11]),
          cr_cat: (c[12] || '').trim() || '(Blank)',
          type: c[13] || '',
          ref,
          bulk_ref: c[15] || '',
          inputter: (c[16] || '').trim() || '(Blank)',
          authoriser: (c[17] || '').trim(),
          time: (c[18] || '').trim(),
          debit_branch: (c[19] || '').trim(),
          credit_branch: (c[20] || '').trim()
        });
      }
    }
  });
  const refCount = new Set(rows.map(r=>r.ref).filter(Boolean)).size;
  return { rows, refCount, note:"OK", meta:{ bank, branch, register, date } };
}


/* checkbox helpers */
function renderCheckboxList(boxId, items, opts){
  const box = document.getElementById(boxId);
  if(!box) return;
  const o = opts || {};
  const hide = o.hide || (()=>false);
  const disabled = o.disabled || (()=>false);
  const checked = o.checked || (()=>true);
  const label = o.label || ((v)=>v);

  const visible = items.filter(v=>!hide(v));
  if(!visible.length){
    box.innerHTML = '<div class="muted small">No items</div>';
    return;
  }

  box.innerHTML = visible.map(v=>{
    const id = boxId + '_' + v.replace(/[^a-zA-Z0-9]/g,'_');
    const dis = disabled(v) ? 'disabled' : '';
    const chk = checked(v) ? 'checked' : '';
    const extra = disabled(v) ? ' <span class="tag">system</span>' : '';
    return `<div><label><input type="checkbox" id="${id}" data-val="${v}" ${chk} ${dis}> <span class="pill">${label(v)}</span>${extra}</label></div>`;
  }).join('');
}

function checkAll(boxId, yes){
  const box = document.getElementById(boxId);
  if(!box) return;
  box.querySelectorAll('input[type=checkbox][data-val]').forEach(ch=>ch.checked=!!yes);
}

/* system inputter helpers (TXT side) */
function isSystemInputter(name){
  const v = String(name||'').trim().toUpperCase();
  if(!v) return false;
  // Common system/automation users seen in COB/T24 exports
  if(v === 'SMARTBANK') return true;
  if(v === 'DATAUPDUS') return true;        // system data update user
  if(v.startsWith('EFTHO')) return true;     // EFT head office user
  if(v.startsWith('SYSTEM')) return true;
  if(v.startsWith('BATCH')) return true;
  if(v === 'T24' || v === 'T24USER') return true;
  return false;
}

function renderSummaryInputters(){
  // HTML summary inputters (always show all)
  if(htmlRows.length){
    const hItems = uniq(htmlRows.map(r=>r.inputter)).sort();
    renderCheckboxList('htmlSumInputters', hItems);
  }
  // TXT summary inputters (optionally hide system-generated)
  if(txtRows.length){
    const tItems = uniq(txtRows.map(r=>r.inputter)).sort();
    const hideSystem = document.getElementById('txtHideSystem')?.checked;
    renderCheckboxList('txtSumInputters', tItems, {
      hide: (v)=> hideSystem ? isSystemInputter(v) : false,
      disabled: (v)=> hideSystem ? isSystemInputter(v) : false,
      checked: (v)=> hideSystem ? (!isSystemInputter(v)) : true
    });
  }
}

function getEffectiveInputterSet(side){
  const isHtml = (side==='html');
  const boxId = isHtml ? 'htmlSumInputters' : 'txtSumInputters';
  const selected = getCheckedSet(boxId); // if empty => means "all visible"
  const all = new Set((isHtml ? htmlRows : txtRows).map(r=>r.inputter));
  // respect visibility: if system are hidden, they are not part of "all" for compare
  if(!isHtml && document.getElementById('txtHideSystem')?.checked){
    for(const v of Array.from(all)){
      if(isSystemInputter(v)) all.delete(v);
    }
  }
  return selected.size ? selected : all;
}

function inputterCompareNote(){
  // Compare effective filter sets between HTML & TXT (after optional TXT system exclusion)
  // Note: TXT inputter can be truncated (e.g., HTML: MOAZZEM01683 vs TXT: MOAZZEM016). So we allow prefix matching.
  const h = getEffectiveInputterSet('html');
  const t = getEffectiveInputterSet('txt');

  const norm = (x)=> String(x||'').trim().toUpperCase();
  const hArr = Array.from(h).map(norm).filter(Boolean);
  const tArr = Array.from(t).map(norm).filter(Boolean);

  const hasMatch = (x, arr)=>{
    for(const y of arr){
      if(x===y) return true;
      if(x.startsWith(y) || y.startsWith(x)) return true;
    }
    return false;
  };

  const onlyInHtml = hArr.filter(x=>!hasMatch(x, tArr)).sort();
  const onlyInTxt  = tArr.filter(x=>!hasMatch(x, hArr)).sort();

  if(onlyInHtml.length===0 && onlyInTxt.length===0){
    return {
      status: 'MATCHED',
      htmlCount: hArr.length,
      txtCount: tArr.length,
      msg: 'Inputter matched after excluding system-generated TXT inputters (prefix match applied for truncated TXT names).'
    };
  }
  const parts = [];
  if(onlyInHtml.length) parts.push('Only in HTML: ' + onlyInHtml.slice(0,20).join(', ') + (onlyInHtml.length>20 ? ` (+${onlyInHtml.length-20} more)` : ''));
  if(onlyInTxt.length) parts.push('Only in TXT: ' + onlyInTxt.slice(0,20).join(', ') + (onlyInTxt.length>20 ? ` (+${onlyInTxt.length-20} more)` : ''));
  return {
    status: 'NOT MATCHED',
    htmlCount: hArr.length,
    txtCount: tArr.length,
    msg: parts.join(' | ')
  };
}

function buildObservationExtras(){
  // Build extra observation lines requested by audit workflow:
  // - Compare HTML totals vs TXT totals AFTER excluding system-generated TXT inputters
  // - Show debit/credit count for HTML and TXT
  // - Show excluded system inputters list
  // - Show blank/invalid FT reference counts + sample invalid refs

  const hideSystem = document.getElementById('txtHideSystem')?.checked;

  const norm = (x)=> String(x||'').trim().toUpperCase();

  // Helper: inputter can be truncated in TXT; allow prefix match.
  const matchInputter = (name, setArr)=>{
    const x = norm(name);
    for(const y0 of setArr){
      const y = norm(y0);
      if(!x || !y) continue;
      if(x===y) return true;
      if(x.startsWith(y) || y.startsWith(x)) return true;
    }
    return false;
  };

  const effSetHtml = Array.from(getEffectiveInputterSet('html'));
  const effSetTxt  = Array.from(getEffectiveInputterSet('txt'));

  const htmlEffRows = (htmlRows||[]).filter(r=> matchInputter(r.inputter, effSetHtml));
  const txtEffRows  = (txtRows||[]).filter(r=> matchInputter(r.inputter, effSetTxt));

  const sum = (rows, field)=>{
    let s = 0;
    for(const r of (rows||[])){
      const v = toNum(r[field]);
      if(isFinite(v)) s += v;
    }
    return s;
  };

  const countPos = (rows, field)=>{
    let c = 0;
    for(const r of (rows||[])){
      const v = toNum(r[field]);
      if(isFinite(v) && v>0) c++;
    }
    return c;
  };

  const fmtMoney = (n)=>{
    if(!isFinite(n)) return '0.00';
    try{
      return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }catch(e){
      return (Math.round(n*100)/100).toFixed(2);
    }
  };

  const htmlDebit  = sum(htmlEffRows, 'debit_amt');
  const htmlCredit = sum(htmlEffRows, 'credit_amt');
  const txtDebit   = sum(txtEffRows,  'debit_amt');
  const txtCredit  = sum(txtEffRows,  'credit_amt');

  const htmlDebitCnt  = countPos(htmlEffRows, 'debit_amt');
  const htmlCreditCnt = countPos(htmlEffRows, 'credit_amt');
  const txtDebitCnt   = countPos(txtEffRows,  'debit_amt');
  const txtCreditCnt  = countPos(txtEffRows,  'credit_amt');

  const dDebit  = htmlDebit  - txtDebit;
  const dCredit = htmlCredit - txtCredit;

  const isValidFT = (ref)=> /^FT[0-9A-Z]+$/.test(norm(ref));
  const blankHtml = (htmlRows||[]).filter(r=>!r.ref || !String(r.ref).trim()).length;
  const blankTxt  = (txtRows ||[]).filter(r=>!r.ref || !String(r.ref).trim()).length;
  const invalidHtml = (htmlRows||[]).filter(r=>r.ref && String(r.ref).trim() && !isValidFT(r.ref));
  const invalidTxt  = (txtRows ||[]).filter(r=>r.ref && String(r.ref).trim() && !isValidFT(r.ref));

  const invalidSample = (arr)=> arr.slice(0,5).map(r=>String(r.ref)).join(', ');

  let excluded = [];
  if(hideSystem){
    excluded = uniq((txtRows||[]).map(r=>r.inputter).filter(isSystemInputter)).map(norm).sort();
  }

  const lines = [];
  lines.push(`<b>Totals compare (TXT excludes system inputters):</b> HTML Debit ${fmtMoney(htmlDebit)} vs TXT Debit ${fmtMoney(txtDebit)} (Œî ${fmtMoney(dDebit)}); HTML Credit ${fmtMoney(htmlCredit)} vs TXT Credit ${fmtMoney(txtCredit)} (Œî ${fmtMoney(dCredit)})`);
  lines.push(`<b>Debit/Credit count:</b> HTML Dr ${htmlDebitCnt}, Cr ${htmlCreditCnt}; TXT Dr ${txtDebitCnt}, Cr ${txtCreditCnt} (system excluded: ${hideSystem ? 'YES' : 'NO'})`);
  if(hideSystem){
    lines.push(`<b>Excluded system inputters (TXT):</b> ${excluded.length ? excluded.join(', ') : '‚Äî'}`);
  }
  lines.push(`<b>FT reference quality:</b> HTML blank ${blankHtml}, invalid-format ${invalidHtml.length}; TXT blank ${blankTxt}, invalid-format ${invalidTxt.length}`);
  if(invalidHtml.length) lines.push(`<span class="muted">Sample invalid (HTML): ${invalidSample(invalidHtml)}</span>`);
  if(invalidTxt.length)  lines.push(`<span class="muted">Sample invalid (TXT): ${invalidSample(invalidTxt)}</span>`);
  return lines.join('<br/>');
}


function refreshOnePageObservation(){
  // Recompute only the Observation area after filter changes
  const h = Number(document.getElementById('sumHtmlRefs')?.textContent || 0);
  const t = Number(document.getElementById('sumTxtRefs')?.textContent || 0);
  updateOnePageCounts(h, t);
}



function getCheckedSet(boxId){
  const box = document.getElementById(boxId);
  if(!box) return new Set();
  const s = new Set();
  box.querySelectorAll('input[type=checkbox][data-val]').forEach(ch=>{
    if(ch.checked) s.add(ch.getAttribute('data-val'));
  });
  return s;
}

/* render table */
function renderTable(headId, tableId, rows, cols){
  const head = document.getElementById(headId);
  const tbody = document.querySelector(`#${tableId} tbody`);
  head.innerHTML = cols.map(c=>`<th>${c.label}</th>`).join('');
  tbody.innerHTML = '';

  if(!rows.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="${cols.length}" class="muted">No data</td>`;
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = cols.map(c=>{
      const v = r[c.k];
      const isNum = (c.k.endsWith('_amt') || c.k === 'debit_amt' || c.k === 'credit_amt');
      if(isNum){
        const n = Number(v);
        return `<td class="num">${isFinite(n)?fmt(n):''}</td>`;
      }
      return `<td>${(v===undefined || v===null)?'':String(v)}</td>`;
    }).join('');
    tbody.appendChild(tr);
  });
}

/* compare */
function computeMissing(){
  const hSet = new Set(htmlRows.map(r=>r.ref).filter(Boolean));
  const tSet = new Set(txtRows.map(r=>r.ref).filter(Boolean));

  const onlyHtml = new Set([...hSet].filter(r=>!tSet.has(r)));
  const onlyTxt  = new Set([...tSet].filter(r=>!hSet.has(r)));

  missingHtmlAll = htmlRows.filter(r=>onlyHtml.has(r.ref));
  missingTxtAll  = txtRows.filter(r=>onlyTxt.has(r.ref));

  renderCheckboxList('htmlMissInputters', uniq(missingHtmlAll.map(r=>r.inputter)).sort());
  renderCheckboxList('htmlMissDrCats', uniq(missingHtmlAll.map(r=>r.dr_cat)).sort());
  renderCheckboxList('htmlMissCrCats', uniq(missingHtmlAll.map(r=>r.cr_cat)).sort());

  renderCheckboxList('txtMissInputters', uniq(missingTxtAll.map(r=>r.inputter)).sort());
  renderCheckboxList('txtMissDrCats', uniq(missingTxtAll.map(r=>r.dr_cat)).sort());
  renderCheckboxList('txtMissCrCats', uniq(missingTxtAll.map(r=>r.cr_cat)).sort());

  resetMissing('html', true);
  resetMissing('txt', true);
}

function applyMissing(side){
  const isHtml = (side === 'html');
  const all = isHtml ? missingHtmlAll : missingTxtAll;

  const inp = getCheckedSet(isHtml ? 'htmlMissInputters' : 'txtMissInputters');
  const dr  = getCheckedSet(isHtml ? 'htmlMissDrCats' : 'txtMissDrCats');
  const cr  = getCheckedSet(isHtml ? 'htmlMissCrCats' : 'txtMissCrCats');

  const q = (document.getElementById(isHtml ? 'htmlMissSearch' : 'txtMissSearch').value || '').trim().toLowerCase();
  const minA = parseFloat(document.getElementById(isHtml ? 'htmlMinAmt' : 'txtMinAmt').value || '');
  const maxA = parseFloat(document.getElementById(isHtml ? 'htmlMaxAmt' : 'txtMaxAmt').value || '');

  const inRange = (v) => {
    if(!isFinite(v)) return true;
    if(isFinite(minA) && v < minA) return false;
    if(isFinite(maxA) && v > maxA) return false;
    return true;
  };

  const filtered = all.filter(r=>{
    if(inp.size && !inp.has(r.inputter)) return false;
    if(dr.size && !dr.has(r.dr_cat)) return false;
    if(cr.size && !cr.has(r.cr_cat)) return false;

    const anyAmt = isFinite(r.debit_amt) ? r.debit_amt : (isFinite(r.credit_amt) ? r.credit_amt : NaN);
    if(!inRange(Number(anyAmt))) return false;

    if(q && !rowText(r).includes(q)) return false;
    return true;
  });

  if(isHtml){
    missingHtmlFiltered = filtered;
    document.getElementById('htmlMissCount').innerHTML = `Missing count: <b>${filtered.length}</b> (of ${missingHtmlAll.length})`;
    const cols = (document.getElementById('htmlCompact')?.checked) ? HTML_COLS_COMPACT : HTML_COLS;
    renderTable('htmlMissHead', 'htmlMissTable', filtered, cols);
  } else {
    missingTxtFiltered = filtered;
    document.getElementById('txtMissCount').innerHTML = `Missing count: <b>${filtered.length}</b> (of ${missingTxtAll.length})`;
    const cols = (document.getElementById('txtCompact')?.checked) ? TXT_COLS_COMPACT : TXT_COLS;
    renderTable('txtMissHead', 'txtMissTable', filtered, cols);
  }
}

function resetMissing(side, silent=false){
  const isHtml = (side === 'html');
  document.getElementById(isHtml ? 'htmlMissSearch' : 'txtMissSearch').value = '';
  document.getElementById(isHtml ? 'htmlMinAmt' : 'txtMinAmt').value = '';
  document.getElementById(isHtml ? 'htmlMaxAmt' : 'txtMaxAmt').value = '';

  checkAll(isHtml ? 'htmlMissInputters' : 'txtMissInputters', true);
  checkAll(isHtml ? 'htmlMissDrCats' : 'txtMissDrCats', true);
  checkAll(isHtml ? 'htmlMissCrCats' : 'txtMissCrCats', true);

  applyMissing(side);
  if(!silent){
    try { (document.getElementById(isHtml ? 'htmlMissTable' : 'txtMissTable')).scrollIntoView({behavior:'smooth', block:'start'}); } catch(e){}
  }
}

/* copy + csv */
function copyRefs(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? missingHtmlFiltered : missingTxtFiltered;
  const refs = uniq(rows.map(r=>r.ref)).join('\n');
  if(!refs){ alert('No refs to copy'); return; }
  navigator.clipboard.writeText(refs).then(()=>alert('Copied ‚úÖ')).catch(()=>{
    const ta = document.createElement('textarea'); ta.value = refs; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); alert('Copied ‚úÖ');
  });
}

function downloadCSV(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? missingHtmlFiltered : missingTxtFiltered;
  const cols = isHtml ? ((document.getElementById('htmlCompact')?.checked) ? HTML_COLS_COMPACT : HTML_COLS)
                      : ((document.getElementById('txtCompact')?.checked) ? TXT_COLS_COMPACT : TXT_COLS);
  const filename = isHtml ? 'HTML_missing_in_TXT_filtered.csv' : 'TXT_missing_in_HTML_filtered.csv';

  const esc = (s) => {
    const t = String(s ?? '');
    if (/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
    return t;
  };

  const lines = [];
  lines.push(cols.map(c=>esc(c.label)).join(','));
  rows.forEach(r=>{
    lines.push(cols.map(c=>{
      const v = r[c.k];
      return esc((typeof v === 'number' && isFinite(v)) ? v : (v ?? ''));
    }).join(','));
  });

  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


/* -------------------- Category Summary (Filtered) -------------------- */
let htmlSummaryRows = [];
let txtSummaryRows = [];

function buildSummaryInputterLists(){
  // Build from full parsed rows (not missing-only)
  renderSummaryInputters();
  // handled by renderSummaryInputters()
}

function renderSumTable(tableId, mp){
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';
  const items = [...mp.entries()].sort((a,b)=>b[1]-a[1]);
  if(!items.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="2" class="muted">No data (after filter)</td>`;
    tbody.appendChild(tr);
    return;
  }
  items.forEach(([cat, total])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${cat}</td><td class="num">${fmt(total)}</td>`;
    tbody.appendChild(tr);
  });
}

function generateSummary(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? htmlRows : txtRows;
  const boxId = isHtml ? 'htmlSumInputters' : 'txtSumInputters';
  const selected = getCheckedSet(boxId);

  const dr = new Map();
  const cr = new Map();
  let drTotal = 0, crTotal = 0;

  rows.forEach(r=>{
    if(selected.size && !selected.has(r.inputter)) return;
    const drCat = r.dr_cat || '(Blank)';
    const crCat = r.cr_cat || '(Blank)';
    if (isFinite(r.debit_amt) && r.debit_amt !== 0){
      dr.set(drCat, (dr.get(drCat) || 0) + r.debit_amt);
      drTotal += r.debit_amt;
    }
    if (isFinite(r.credit_amt) && r.credit_amt !== 0){
      cr.set(crCat, (cr.get(crCat) || 0) + r.credit_amt);
      crTotal += r.credit_amt;
    }
  });

  if(isHtml){
    htmlSummaryRows = rows.filter(r=>!selected.size || selected.has(r.inputter));
    renderSumTable('htmlSumDrTable', dr);
    renderSumTable('htmlSumCrTable', cr);
    document.getElementById('htmlSumDrTotal').textContent = fmt(drTotal);
    document.getElementById('htmlSumCrTotal').textContent = fmt(crTotal);
    document.getElementById('htmlSumDiff').textContent = fmt(drTotal - crTotal);
    htmlSummaryTotals = {drTotal, crTotal};
    updateCrossDiffUI();
  } else {
    txtSummaryRows = rows.filter(r=>!selected.size || selected.has(r.inputter));
    renderSumTable('txtSumDrTable', dr);
    renderSumTable('txtSumCrTable', cr);
    document.getElementById('txtSumDrTotal').textContent = fmt(drTotal);
    document.getElementById('txtSumCrTotal').textContent = fmt(crTotal);
    document.getElementById('txtSumDiff').textContent = fmt(drTotal - crTotal);
    txtSummaryTotals = {drTotal, crTotal};
    updateCrossDiffUI();
  }
  refreshOnePageObservation();
}


function downloadSummaryCSV(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? htmlSummaryRows : txtSummaryRows;
  const cols = isHtml ? ((document.getElementById('htmlCompact')?.checked) ? HTML_COLS_COMPACT : HTML_COLS)
                      : ((document.getElementById('txtCompact')?.checked) ? TXT_COLS_COMPACT : TXT_COLS);
  const filename = isHtml ? 'HTML_summary_filtered_rows.csv' : 'TXT_summary_filtered_rows.csv';

  const esc = (s) => {
    const t = String(s ?? '');
    if (/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
    return t;
  };

  const lines = [];
  lines.push(cols.map(c=>esc(c.label)).join(','));
  rows.forEach(r=>{
    lines.push(cols.map(c=>{
      const v = r[c.k];
      return esc((typeof v === 'number' && isFinite(v)) ? v : (v ?? ''));
    }).join(','));
  });

  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


/* -------------------- PDF Preview (Browser Print) -------------------- */
function printSection(id){
  const el = document.getElementById(id);
  if(!el){ alert('Section not found'); return; }

  // Create/clear print area
  let pa = document.getElementById('printArea');
  if(!pa){
    pa = document.createElement('div');
    pa.id = 'printArea';
    document.body.appendChild(pa);
  }
  pa.innerHTML = '';
  const clone = el.cloneNode(true);

  // Remove UI-only buttons inside clone
  clone.querySelectorAll('.no-print').forEach(n=>n.remove());

  // Ensure tables expand in print
  clone.querySelectorAll('.scrollTable').forEach(n=>{
    n.style.maxHeight = 'none';
    n.style.overflow = 'visible';
    n.style.border = 'none';
  });
  clone.querySelectorAll('.list').forEach(n=>{
    n.style.maxHeight = 'none';
    n.style.overflow = 'visible';
  });

  pa.appendChild(clone);

  // Toggle print mode
  document.body.classList.add('printing');
  setTimeout(()=>{
    window.print();
    setTimeout(()=>{
      document.body.classList.remove('printing');
      pa.innerHTML = '';
    }, 300);
  }, 50);
}

/* -------------------- Cross-file Summary Differences -------------------- */
let htmlSummaryTotals = {drTotal:0, crTotal:0};
let txtSummaryTotals  = {drTotal:0, crTotal:0};


function updateOnePageSummary(htmlRefs, txtRefs){
  const bankEl = document.getElementById('sumBankTitle');
  const branchEl = document.getElementById('sumBranchTitle');
  const regEl = document.getElementById('sumRegisterTitle');
  const dateEl = document.getElementById('sumDate');

  if(bankEl) bankEl.textContent = (htmlMeta?.bank && htmlMeta.bank !== '‚Äî' && htmlMeta.bank.trim()) ? htmlMeta.bank : 'AGRANI BANK PLC';
  if(branchEl) branchEl.textContent = (htmlMeta?.branch && htmlMeta.branch !== '‚Äî') ? htmlMeta.branch : '‚Äî';
  if(regEl) regEl.textContent = (htmlMeta?.register && htmlMeta.register !== '‚Äî' && htmlMeta.register.trim()) ? htmlMeta.register : 'DAILY TRANSFER REGISTER';
  if(dateEl) dateEl.textContent = htmlMeta?.date || '‚Äî';

  const hR = document.getElementById('sumHtmlRefs'); if(hR) hR.textContent = String(htmlRefs ?? 0);
  const tR = document.getElementById('sumTxtRefs'); if(tR) tR.textContent = String(txtRefs ?? 0);
  const m1 = document.getElementById('sumMissInTxt'); if(m1) m1.textContent = String(missingHtmlAll.length);
  const m2 = document.getElementById('sumMissInHtml'); if(m2) m2.textContent = String(missingTxtAll.length);
}
function updateCrossDiffUI(){
  const debitDelta = (htmlSummaryTotals.drTotal - txtSummaryTotals.drTotal);
  const creditDelta = (htmlSummaryTotals.crTotal - txtSummaryTotals.crTotal);

  const kDebit = document.getElementById('kpiDebitDelta');
  const kCredit = document.getElementById('kpiCreditDelta');
  const sDebit = document.getElementById('sumDebitDelta');
  const sCredit = document.getElementById('sumCreditDelta');

  if(kDebit) kDebit.textContent = fmt(debitDelta);
  if(kCredit) kCredit.textContent = fmt(creditDelta);
  if(sDebit) sDebit.textContent = fmt(debitDelta);
  if(sCredit) sCredit.textContent = fmt(creditDelta);
}

/* main */
async function loadAll(){
  const hf = document.getElementById('htmlFile').files[0];
  const tf = document.getElementById('txtFile').files[0];
  if(!hf || !tf){ alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá HTML ‡¶è‡¶¨‡¶Ç TXT‚Äî‡¶¶‡ßÅ‡¶á‡¶ü‡¶æ ‡¶´‡¶æ‡¶á‡¶≤‡¶á ‡¶¶‡¶ø‡¶®'); return; }

  setStatus('Loading...');
  debug('');

  htmlRows = []; txtRows = [];
  missingHtmlAll = []; missingTxtAll = [];
  missingHtmlFiltered = []; missingTxtFiltered = [];

  try {
    const [hText, tText] = await Promise.all([readFile(hf), readFile(tf)]);
    validateHtmlContent(hText);
    validateTxtContent(tText);
    setSummaryStatic(hf, tf);
    const h = parseHTML(hText);
    const t = parseTXTFixedWidth(tText);

    htmlRows = h.rows;
    txtRows = t.rows;

    if (h.meta) htmlMeta = {bank:'‚Äî', branch:'‚Äî', register:'‚Äî', date:'‚Äî', ...h.meta};
setSummaryStatic(hf, tf);  // ‚úÖ after htmlMeta updated
    updateOnePageSummary(h.refCount, t.refCount);

  const msg = [
    `HTML parsed rows: ${htmlRows.length} | unique FT refs: ${h.refCount} | note: ${h.note}`,
    `TXT parsed rows:  ${txtRows.length} | unique FT refs: ${t.refCount} | note: ${t.note}`,
  ];

  const warn = [];
  if(h.refCount === 0) warn.push("‚ö†Ô∏è HTML ‡¶•‡ßá‡¶ï‡ßá FT ref ‡¶™‡ßú‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø (0). ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ HTML ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü/‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
  if(t.refCount === 0) warn.push("‚ö†Ô∏è TXT ‡¶•‡ßá‡¶ï‡ßá FT ref ‡¶™‡ßú‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø (0). TXT report header/spacing ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§");

  debug(msg.join('\n') + (warn.length ? ("\n\n" + warn.join('\n')) : ''));

  computeMissing();
    computeDiagnostics();
    updateOnePageCounts(h.refCount, t.refCount);

  updateOnePageSummary(h.refCount, t.refCount);
  buildSummaryInputterLists();
  generateSummary('html');
  generateSummary('txt');

  // Tx tools
  buildInputterSummary();
  updateDQPanel();
  resetTxFinder();

  // KPI updates
  document.getElementById('kpiHtmlRows').textContent = String(htmlRows.length);
  document.getElementById('kpiHtmlRefs').textContent = String(h.refCount);
  document.getElementById('kpiTxtRows').textContent = String(txtRows.length);
  document.getElementById('kpiTxtRefs').textContent = String(t.refCount);
  document.getElementById('kpiHtmlMissing').textContent = String(missingHtmlAll.length);
  document.getElementById('kpiTxtMissing').textContent = String(missingTxtAll.length);
  updateCrossDiffUI();


  // KPI updates
  document.getElementById('kpiHtmlRows').textContent = String(htmlRows.length);
  document.getElementById('kpiHtmlRefs').textContent = String(h.refCount);
  document.getElementById('kpiTxtRows').textContent = String(txtRows.length);
  document.getElementById('kpiTxtRefs').textContent = String(t.refCount);
  document.getElementById('kpiHtmlMissing').textContent = String(missingHtmlAll.length);
  document.getElementById('kpiTxtMissing').textContent = String(missingTxtAll.length);

  setStatus('Done');
  } catch(e) {
    console.error(e);
    setStatus('Error');
    debug('ERROR: ' + (e && e.message ? e.message : String(e)) + '\n' + (e && e.stack ? e.stack : ''));
    alert('‡¶≤‡ßã‡¶°/‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ Debug ‡¶Ö‡¶Ç‡¶∂‡ßá Error ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§');
  }
}


function injectHelpBoxes(){
  // ‚úÖ only one target section (change '#upload' to any section id you want)
  const sec = document.querySelector('#upload');
  if(!sec) return;

  if(sec.querySelector('.helpBox')) return;

  const title = sec.querySelector('.sectionTitle');
  if(!title) return;

  const defaultHelp = `‚Ä¢ Select <code>Before COB (HTML)</code> and <code>After COB (TXT)</code> files<br/>
‚Ä¢ Click <b>Load & Compare</b> to generate results<br/>
‚Ä¢ Use filters to narrow down by Inputter / Category / Amount range<br/>
‚Ä¢ Use <b>Compact view</b> for wide tables (audit section)<br/>
‚Ä¢ For PDF: open <b>üßæ One-page Audit Summary</b> ‚Üí Print / Save PDF`;

  const details = document.createElement('details');
  details.className = 'helpBox';
  details.innerHTML = `<summary>‚ÑπÔ∏è Help / Instruction</summary><div class="helpBody">${defaultHelp}</div>`;

  title.insertAdjacentElement('afterend', details);
}


function showCredit(){
  const o = document.getElementById('creditOverlay');
  if(o) o.style.display = 'flex';
}
function hideCredit(){
  const o = document.getElementById('creditOverlay');
  if(o) o.style.display = 'none';
}
document.addEventListener('DOMContentLoaded', ()=>{
  injectHelpBoxes();
  // show small credit popup once per browser session
  try{
    if(!sessionStorage.getItem('transferToolCreditShown')){
      showCredit();
      sessionStorage.setItem('transferToolCreditShown','1');
    }
  }catch(e){ showCredit(); }
});


// -------------------- v13: validations + diagnostics + one-page print --------------------
let amountMismatch = [];
let dupHtmlRefs = [];
let dupTxtRefs = [];
let blankRefCount = 0;

function makeAuditRef(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `ABTL-TR-${y}${m}${da}-${hh}${mm}`;
}

function setSummaryStatic(hf, tf){
  const gen = new Date();
  const genStr = gen.toLocaleString();
  const el = (id, v)=>{ const x=document.getElementById(id); if(x) x.textContent = v; };

  el('sumGeneratedAt', genStr);
  el('sumAuditRef', makeAuditRef());
  el('sumHtmlFile', hf?.name || '‚Äî');
  el('sumTxtFile', tf?.name || '‚Äî');
  // Bank/Branch/Register/Date are filled from HTML meta in updateOnePageSummary()
}


function validateHtmlContent(text){
  const t = (text || '').toLowerCase();
  const okTable = t.includes('<table');
  const okHint = t.includes('daily transfer') || t.includes('transfer register') || t.includes('trreg') || t.includes('daily transfer register');
  if(!okTable) throw new Error('Invalid HTML: ‡¶ï‡ßã‡¶® ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ (<table>) ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ ‡¶≠‡ßÅ‡¶≤ HTML ‡¶´‡¶æ‡¶á‡¶≤‡•§');
  if(!okHint) {
    // not fatal, but warn
    debug((document.getElementById('debugBox')?.textContent || '') + '\n‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: HTML ‡¶´‡¶æ‡¶á‡¶≤‡ßá "Transfer Register" ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶®‡ßü‡•§ ‡¶§‡¶¨‡ßÅ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§');
  }
  return true;
}

function validateTxtContent(text){
  const t = (text || '').toLowerCase();
  const hasTrreg = t.includes('trreg') || t.includes('cob') || t.includes('results') || t.includes('selection');
  const hasFT = /ft\d{6,}/i.test(text || '');
  if(!hasFT) throw new Error('Invalid TXT: TXT ‡¶´‡¶æ‡¶á‡¶≤‡ßá FT reference pattern (FTxxxxxx) ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ ‡¶≠‡ßÅ‡¶≤ TXT ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡•§');
  if(!hasTrreg){
    debug((document.getElementById('debugBox')?.textContent || '') + '\n‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: TXT ‡¶´‡¶æ‡¶á‡¶≤‡ßá expected header hint (TRREG/COB) ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶®‡ßü‡•§ ‡¶§‡¶¨‡ßÅ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§');
  }
  return true;
}

function countDuplicates(rows){
  const m = new Map();
  for(const r of rows){
    const ref = r.ref;
    if(!ref) continue;
    m.set(ref, (m.get(ref)||0)+1);
  }
  const dups = [];
  for(const [k,v] of m.entries()){
    if(v>1) dups.push({ref:k, count:v});
  }
  return dups.sort((a,b)=>b.count-a.count);
}

function computeDiagnostics(){
  // blank refs across both (for quality)
  const allRefs = [...htmlRows, ...txtRows].map(r=>r.ref).filter(r=>!r || String(r).trim()==='' );
  blankRefCount = allRefs.length;

  dupHtmlRefs = countDuplicates(htmlRows);
  dupTxtRefs  = countDuplicates(txtRows);

  // amount mismatch by ref (compare debit amount primarily; fallback credit)
  const hMap = new Map();
  for(const r of htmlRows){ if(r.ref && !hMap.has(r.ref)) hMap.set(r.ref, r); }
  const tMap = new Map();
  for(const r of txtRows){ if(r.ref && !tMap.has(r.ref)) tMap.set(r.ref, r); }

  amountMismatch = [];
  for(const [ref, hr] of hMap.entries()){
    if(!tMap.has(ref)) continue;
    const tr = tMap.get(ref);

    const hAmt = isFinite(toNum(hr.dr_amt)) ? toNum(hr.dr_amt) : toNum(hr.cr_amt);
    const tAmt = isFinite(toNum(tr.dr_amt)) ? toNum(tr.dr_amt) : toNum(tr.cr_amt);

    if(isFinite(hAmt) && isFinite(tAmt)){
      if(Math.abs(hAmt - tAmt) > 0.0001){
        amountMismatch.push({ref, html_amt:hAmt, txt_amt:tAmt, inputter: hr.inputter || tr.inputter || ''});
      }
    }
  }
}

function updateOnePageCounts(htmlRefs, txtRefs){
  const el = (id,v)=>{ const x=document.getElementById(id); if(x) x.textContent = String(v); };

  el('sumHtmlRefs', htmlRefs ?? 0);
  el('sumTxtRefs',  txtRefs ?? 0);
  el('sumMissInTxt', missingHtmlAll.length);
  el('sumMissInHtml', missingTxtAll.length);
  el('sumAmtMismatch', amountMismatch.length);
  el('sumDupHtml', dupHtmlRefs.length);
  el('sumDupTxt', dupTxtRefs.length);
  el('sumBlankRefs', blankRefCount);

  // --- Additional professional summary stats ---
  const sumField = (rows, field)=>{
    let s = 0;
    for(const r of (rows||[])){
      const v = toNum(r[field]);
      if(isFinite(v)) s += v;
    }
    return s;
  };
  const fmtMoney = (n)=>{
    if(!isFinite(n)) return '0.00';
    try{
      return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }catch(e){
      return (Math.round(n*100)/100).toFixed(2);
    }
  };

  // Totals per file
  const htmlDebitTotal  = sumField(htmlRows, 'debit_amt');
  const htmlCreditTotal = sumField(htmlRows, 'credit_amt');
  const txtDebitTotal   = sumField(txtRows,  'debit_amt');
  const txtCreditTotal  = sumField(txtRows,  'credit_amt');

  el('sumHtmlDebitTotal',  fmtMoney(htmlDebitTotal));
  el('sumHtmlCreditTotal', fmtMoney(htmlCreditTotal));
  el('sumTxtDebitTotal',   fmtMoney(txtDebitTotal));
  el('sumTxtCreditTotal',  fmtMoney(txtCreditTotal));

  // Inputter breakdown (Count + Sum of Amount; use Debit amount primarily, else Credit)
  const inputterStats = (rows)=>{
    const m = new Map();
    for(const r of (rows||[])){
      const name = (r.inputter || '‚Äî').toString().trim() || '‚Äî';
      const amt = isFinite(toNum(r.debit_amt)) ? toNum(r.debit_amt) : toNum(r.credit_amt);
      const cur = m.get(name) || {inputter:name, count:0, total:0};
      cur.count += 1;
      if(isFinite(amt)) cur.total += amt;
      m.set(name, cur);
    }
    return Array.from(m.values()).sort((a,b)=> (b.total - a.total) || (b.count - a.count) || a.inputter.localeCompare(b.inputter));
  };

  const renderInputterTable = (stats, targetId)=>{
    const box = document.getElementById(targetId);
    if(!box) return;
    if(!stats || !stats.length){ box.innerHTML = '<span class="muted">‚Äî</span>'; return; }
    const top = stats.slice(0, 10);
    let h = '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
    h += '<thead><tr>';
    h += '<th style="border:1px solid #ddd; padding:4px 6px; text-align:left;">Inputter</th>';
    h += '<th style="border:1px solid #ddd; padding:4px 6px; text-align:right;">Tx</th>';
    h += '<th style="border:1px solid #ddd; padding:4px 6px; text-align:right;">Total</th>';
    h += '</tr></thead><tbody>';
    for(const r of top){
      h += `<tr>
        <td style="border:1px solid #ddd; padding:4px 6px;">${(r.inputter||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}</td>
        <td style="border:1px solid #ddd; padding:4px 6px; text-align:right;">${r.count}</td>
        <td style="border:1px solid #ddd; padding:4px 6px; text-align:right;">${fmtMoney(r.total)}</td>
      </tr>`;
    }
    h += '</tbody></table>';
    if(stats.length > top.length){
      h += `<div class="muted" style="margin-top:4px; font-size:11px;">Showing top ${top.length} of ${stats.length} inputters</div>`;
    }
    box.innerHTML = h;
  };

  renderInputterTable(inputterStats(htmlRows), 'sumHtmlInputterTable');
  renderInputterTable(inputterStats(txtRows),  'sumTxtInputterTable');

  // Largest transactions (max debit / max credit) across both files
  const pickMax = (rows, field)=> {
    let best = null;
    for(const r of (rows||[])){
      const v = toNum(r[field]);
      if(!isFinite(v)) continue;
      if(!best || v > best.amt){
        best = {amt:v, ref:r.ref || '‚Äî', inputter:r.inputter || '‚Äî'};
      }
    }
    return best;
  };

  const maxHtmlDebit  = pickMax(htmlRows, 'debit_amt');
  const maxTxtDebit   = pickMax(txtRows,  'debit_amt');
  const maxHtmlCredit = pickMax(htmlRows, 'credit_amt');
  const maxTxtCredit  = pickMax(txtRows,  'credit_amt');

  const choose = (a, b)=>{
    if(!a && !b) return null;
    if(a && !b) return {src:'HTML', ...a};
    if(!a && b) return {src:'TXT', ...b};
    return (a.amt >= b.amt) ? {src:'HTML', ...a} : {src:'TXT', ...b};
  };

  const bestDebit  = choose(maxHtmlDebit,  maxTxtDebit);
  const bestCredit = choose(maxHtmlCredit, maxTxtCredit);

  el('sumMaxDebitAmt',   bestDebit ? fmtMoney(bestDebit.amt) : '0.00');
  el('sumMaxDebitRef',   bestDebit ? bestDebit.ref : '‚Äî');
  el('sumMaxDebitSrc',   bestDebit ? bestDebit.src : '‚Äî');

  el('sumMaxCreditAmt',  bestCredit ? fmtMoney(bestCredit.amt) : '0.00');
  el('sumMaxCreditRef',  bestCredit ? bestCredit.ref : '‚Äî');
  el('sumMaxCreditSrc',  bestCredit ? bestCredit.src : '‚Äî');

  const matched = Math.max(0, Math.min(htmlRefs||0, txtRefs||0) - (missingHtmlAll.length + missingTxtAll.length));
  el('sumMatched', matched);

  // Observation text (bank format + action stamp)
  const obs = document.getElementById('sumObservation');
  const stamp = document.getElementById('sumActionStamp');
  if(obs){
    const totalFindings = (missingHtmlAll.length||0) + (missingTxtAll.length||0) + (amountMismatch.length||0);
    if(stamp) stamp.style.display = (totalFindings > 0) ? 'inline-block' : 'none';

    if(totalFindings === 0){
      const ic = inputterCompareNote();
      obs.innerHTML = [
        '<b>Result:</b> No discrepancy found between Before COB and After COB registers.',
        '<b>Status:</b> OK (Matched / No missing FT refs / No amount mismatch).',
        `<b>Inputter check (filtered):</b> <span class="tag">${ic.status}</span> ‚Äî ${ic.msg}`, buildObservationExtras()
      ].join('<br/>');
    } else {
      const lines = [];
      lines.push('<b>Result:</b> Discrepancy found between Before COB (HTML) and After COB (TXT) registers.');
      lines.push('<b>Status:</b> ACTION REQUIRED (Manual review & verification).');
      if(missingHtmlAll.length) lines.push(`1) HTML missing in TXT (After COB): <b>${missingHtmlAll.length}</b>`);
      if(missingTxtAll.length)  lines.push(`2) TXT missing in HTML (Before COB): <b>${missingTxtAll.length}</b>`);
      if(amountMismatch.length) lines.push(`3) Amount mismatch: <b>${amountMismatch.length}</b>`);
      const ic = inputterCompareNote();
      lines.push(`<b>Inputter check (filtered):</b> <span class="tag">${ic.status}</span> ‚Äî ${ic.msg}`, buildObservationExtras());
      lines.push('<span class="muted">Note: Please verify supporting vouchers/authorisation for the above FT references.</span>');
      obs.innerHTML = lines.join('<br/>');
    }
  }

  // date in summary: best-effort from meta; fallback today
  const d = document.getElementById('sumDate');
  if(d){
    d.textContent = (htmlMeta && htmlMeta.date) ? htmlMeta.date : new Date().toLocaleDateString();
  }
}

function printSummaryPage(){
  printSection('summaryPageOnly');
}

function downloadFindingsCSV(){
  // Combine key findings into one CSV
  const rows = [];
  const push = (type, r)=>rows.push({
    Finding: type,
    FT_Ref: r.ref || '',
    Debit_Amt: (r.debit_amt ?? (r.debit_amt ?? r.dr_amt) ?? ''),
    Credit_Amt: (r.credit_amt ?? (r.credit_amt ?? r.cr_amt) ?? ''),
    Inputter: r.inputter ?? '',
    Dr_Category: r.dr_cat ?? '',
    Cr_Category: r.cr_cat ?? '',
    Note: r.note ?? ''
  });

  missingHtmlAll.forEach(r=>push('HTML missing in TXT', r));
  missingTxtAll.forEach(r=>push('TXT missing in HTML', r));
  amountMismatch.forEach(r=>rows.push({
    Finding:'Amount mismatch',
    FT_Ref:r.ref,
    Debit_Amt:r.html_amt,
    Credit_Amt:r.txt_amt,
    Inputter:r.inputter,
    Dr_Category:'',
    Cr_Category:'',
    Note:'HTML vs TXT amount differs'
  }));

  if(!rows.length){ alert('No findings to export.'); return; }
  downloadCSV('transfer_audit_findings.csv', rows);
}

// remember compact view (professional touch)
function rememberToggle(id){
  try{
    const el = document.getElementById(id);
    if(!el) return;
    const key = 'tr_audit_' + id;
    el.checked = (localStorage.getItem(key) === '1');
    el.addEventListener('change', ()=> localStorage.setItem(key, el.checked ? '1' : '0'));
  }catch(e){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  rememberToggle('htmlCompact');
  rememberToggle('txtCompact');

  // disable Load button until both files present
  const btn = document.getElementById('loadBtn');
  const hf = document.getElementById('htmlFile');
  const tf = document.getElementById('txtFile');
  const refresh = ()=>{
    if(!btn) return;
    btn.disabled = !(hf?.files?.length && tf?.files?.length);
  };
  hf?.addEventListener('change', refresh);
  tf?.addEventListener('change', refresh);
  refresh();
});



/* =========================
   Transaction Finder tools
   ========================= */

function downloadText(content, filename, mime){
  const blob = new Blob([content], {type: mime || 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename || 'export.txt';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 300);
}

function downloadRowsAsCSV(rows, cols, filename){
  const esc = (s) => {
    const t = String(s ?? '');
    if (/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
    return t;
  };
  const header = cols.join(',');
  const body = rows.map(r=> cols.map(c=> esc(r[c])).join(',')).join('\n');
  downloadText(header + '\n' + body, filename || 'export.csv', 'text/csv');
}
let txFinderResults = [];
let inputterSummary = [];

function combinedRows(){
  const h = htmlRows.map(r=>({...r, __src:'HTML'}));
  const t = txtRows.map(r=>({...r, __src:'TXT'}));
  return h.concat(t);
}

function rowMaxAmt(r){
  const a = Math.max(Math.abs(Number(r.debit_amt)||0), Math.abs(Number(r.credit_amt)||0));
  return isFinite(a) ? a : 0;
}

function buildInputterSummary(){
  const map = new Map();
  combinedRows().forEach(r=>{
    const k = (r.inputter || '(Blank)').trim() || '(Blank)';
    const o = map.get(k) || {inputter:k, rows:0, dr:0, cr:0, maxAmt:0, maxRef:'‚Äî', maxSrc:'‚Äî'};
    o.rows += 1;
    if(isFinite(r.debit_amt)) o.dr += (Number(r.debit_amt)||0);
    if(isFinite(r.credit_amt)) o.cr += (Number(r.credit_amt)||0);
    const m = rowMaxAmt(r);
    if(m > o.maxAmt){
      o.maxAmt = m;
      o.maxRef = r.ref || '‚Äî';
      o.maxSrc = r.__src || '‚Äî';
    }
    map.set(k,o);
  });
  inputterSummary = Array.from(map.values()).sort((a,b)=> (b.rows-a.rows) || (b.maxAmt-a.maxAmt));
  renderInputterSummaryTable();
  populateTxInputterSelect();
}

function renderInputterSummaryTable(){
  const tb = document.querySelector('#txUserTable tbody');
  if(!tb) return;
  tb.innerHTML = inputterSummary.map(o=>{
    const safe = (s)=> String(s??'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return `<tr style="cursor:pointer" onclick="setFinderInputter('${safe(o.inputter).replace(/'/g,'&#39;')}')">
      <td>${safe(o.inputter)}</td>
      <td class="num">${o.rows}</td>
      <td class="num">${fmt(o.dr)}</td>
      <td class="num">${fmt(o.cr)}</td>
      <td class="num">${fmt(o.maxAmt)}</td>
      <td><code>${safe(o.maxRef)}</code></td>
      <td>${safe(o.maxSrc)}</td>
    </tr>`;
  }).join('');
}

function populateTxInputterSelect(){
  const sel = document.getElementById('txInputterSelect');
  if(!sel) return;
  const opts = ['(All inputters)'].concat(inputterSummary.map(o=>o.inputter));
  sel.innerHTML = opts.map(v=> `<option value="${String(v).replace(/"/g,'&quot;')}">${v}</option>`).join('');
}

function setFinderInputter(v){
  const sel = document.getElementById('txInputterSelect');
  if(sel){
    sel.value = v;
    applyTxInputter();
  }
}

function applyTxInputter(){
  const sel = document.getElementById('txInputterSelect');
  if(!sel) return;
  const v = sel.value;
  if(v && v !== '(All inputters)'){
    document.getElementById('txField').value = 'inputter';
    document.getElementById('txQuery').value = v;
  } else {
    document.getElementById('txQuery').value = '';
  }
  runTxFinder();
}

function clearTxInputter(){
  const sel = document.getElementById('txInputterSelect');
  if(sel) sel.value = '(All inputters)';
  document.getElementById('txQuery').value = '';
  document.getElementById('txField').value = 'any';
  document.getElementById('txSource').value = 'both';
  resetTxFinder();
}

function setTxFinderMissing(which){
  // which: 'html' => html missing in txt | 'txt' => txt missing in html
  const tag = document.getElementById('txResultTag');
  if(which==='html'){
    txFinderResults = (missingHtmlAll||[]).map(r=>({...r, __src:'HTML'}));
    if(tag) tag.textContent = `HTML missing in TXT (${txFinderResults.length})`;
  } else {
    txFinderResults = (missingTxtAll||[]).map(r=>({...r, __src:'TXT'}));
    if(tag) tag.textContent = `TXT missing in HTML (${txFinderResults.length})`;
  }
  renderTxFinderResults();
}

function runTxFinder(){
  const q = (document.getElementById('txQuery')?.value || '').trim().toUpperCase();
  const src = document.getElementById('txSource')?.value || 'both';
  const field = document.getElementById('txField')?.value || 'any';

  const rows = combinedRows().filter(r=>{
    if(src==='html' && r.__src!=='HTML') return false;
    if(src==='txt' && r.__src!=='TXT') return false;
    return true;
  });

  txFinderResults = rows.filter(r=>{
    if(!q) return true;
    const ref = String(r.ref||'').toUpperCase();
    const debitAc = String(r.debit_ac||'').toUpperCase();
    const creditAc = String(r.credit_ac||'').toUpperCase();
    const dTitle = String(r.debit_title||'').toUpperCase();
    const cTitle = String(r.credit_title||'').toUpperCase();
    const inp = String(r.inputter||'').toUpperCase();

    if(field==='ref') return ref.includes(q);
    if(field==='account') return debitAc.includes(q) || creditAc.includes(q);
    if(field==='title') return dTitle.includes(q) || cTitle.includes(q);
    if(field==='inputter') return inp.includes(q);
    // any
    return (ref+ ' ' + debitAc + ' ' + creditAc + ' ' + dTitle + ' ' + cTitle + ' ' + inp).includes(q);
  });

  const tag = document.getElementById('txResultTag');
  if(tag){
    const label = q ? `Search: ${q}` : 'All rows';
    tag.textContent = `${label} | ${txFinderResults.length}`;
  }
  renderTxFinderResults();
}

function resetTxFinder(){
  txFinderResults = [];
  renderTxFinderResults();
}

function renderTxFinderResults(){
  const tb = document.querySelector('#txResultTable tbody');
  const info = document.getElementById('txResultInfo');
  if(!tb) return;

  if(!txFinderResults.length){
    tb.innerHTML = '';
    if(info) info.textContent = 'No results (run search / or pick missing list).';
  } else {
    if(info) info.textContent = `Showing ${txFinderResults.length} row(s).`;
    const safe = (s)=> String(s??'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    tb.innerHTML = txFinderResults.slice(0,2000).map(r=>`<tr>
      <td>${safe(r.__src)}</td>
      <td><code>${safe(r.ref)}</code></td>
      <td>${safe(r.debit_ac)}</td>
      <td>${safe(r.debit_title)}</td>
      <td class="num">${fmt(r.debit_amt)}</td>
      <td>${safe(r.credit_ac)}</td>
      <td>${safe(r.credit_title)}</td>
      <td class="num">${fmt(r.credit_amt)}</td>
      <td>${safe(r.inputter)}</td>
      <td>${safe(r.authoriser)}</td>
      <td>${safe(r.time)}</td>
      <td>${safe(r.dr_cat)}</td>
      <td>${safe(r.cr_cat)}</td>
      <td>${safe(r.type)}</td>
    </tr>`).join('');
    if(txFinderResults.length>2000){
      tb.innerHTML += `<tr><td colspan="14" class="muted small">Showing first 2000 rows. Please refine search to narrow results.</td></tr>`;
    }
  }

  // update stats
  const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=String(v); };
  let dr=0, cr=0, maxAmt=0, maxRef='‚Äî', maxSrc='‚Äî';
  txFinderResults.forEach(r=>{
    if(isFinite(r.debit_amt)) dr += (Number(r.debit_amt)||0);
    if(isFinite(r.credit_amt)) cr += (Number(r.credit_amt)||0);
    const m = rowMaxAmt(r);
    if(m>maxAmt){ maxAmt=m; maxRef=r.ref||'‚Äî'; maxSrc=r.__src||'‚Äî'; }
  });
  set('txStatRows', txFinderResults.length);
  set('txStatDebit', fmt(dr));
  set('txStatCredit', fmt(cr));
  set('txStatMaxAmt', fmt(maxAmt));
  set('txStatMaxRef', maxRef);
  set('txStatMaxSrc', maxSrc);
}

function downloadTxFinder(fmtType){
  const rows = txFinderResults.length ? txFinderResults : combinedRows();
  if(fmtType==='csv'){
    const cols = ['__src','ref','debit_ac','debit_title','debit_amt','credit_ac','credit_title','credit_amt','inputter','authoriser','time','dr_cat','cr_cat','type'];
    downloadRowsAsCSV(rows, cols, 'tx_finder_export.csv');
    return;
  }
  if(fmtType==='txt'){
    const cols = ['__src','ref','debit_ac','debit_title','debit_amt','credit_ac','credit_title','credit_amt','inputter','authoriser','time','dr_cat','cr_cat','type'];
    const lines = [cols.join('\t')].concat(rows.map(r=> cols.map(c=> String(r[c]??'')).join('\t')));
    downloadText(lines.join('\n'), 'tx_finder_export.txt', 'text/plain');
    return;
  }
  if(fmtType==='html'){
    const cols = ['__src','ref','debit_ac','debit_title','debit_amt','credit_ac','credit_title','credit_amt','inputter','authoriser','time','dr_cat','cr_cat','type'];
    const esc = (s)=> String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const head = cols.map(c=>`<th>${esc(c)}</th>`).join('');
    const body = rows.map(r=>`<tr>${cols.map(c=>`<td>${esc(r[c])}</td>`).join('')}</tr>`).join('');
    const html = `<!doctype html><html><head><meta charset="utf-8"><title>Tx Export</title>
      <style>body{font-family:system-ui,Segoe UI,Arial;font-size:12px;padding:16px;} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px;} th{background:#f5f5f5;position:sticky;top:0}</style>
      </head><body><h3>Transaction Export (${rows.length} rows)</h3><table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></body></html>`;
    downloadText(html, 'tx_finder_export.html', 'text/html');
    return;
  }
}

function downloadInputterSummaryCSV(){
  const cols = ['inputter','rows','dr','cr','maxAmt','maxRef','maxSrc'];
  downloadRowsAsCSV(inputterSummary, cols, 'inputter_summary_both.csv');
}

function updateDQPanel(){
  const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=String(v); };
  const blanks = (htmlRows.concat(txtRows)).filter(r=>!String(r.ref||'').trim() || String(r.ref||'').trim()==='0').length;
  const blankAmt = (htmlRows.concat(txtRows)).filter(r=>!(isFinite(r.debit_amt) && r.debit_amt!==0) && !(isFinite(r.credit_amt) && r.credit_amt!==0)).length;
  const blankAcTitle = (htmlRows.concat(txtRows)).filter(r=>{
    const a = String(r.debit_ac||'').trim() && String(r.credit_ac||'').trim();
    const t = String(r.debit_title||'').trim() && String(r.credit_title||'').trim();
    return !(a && t);
  }).length;
  set('txDQBlankRefs', blanks);
  set('txDQBlankAmt', blankAmt);
  set('txDQBlankAcTitle', blankAcTitle);
  set('txDQMissHtml', (missingHtmlAll||[]).length);
  set('txDQMissTxt', (missingTxtAll||[]).length);
}

</script>

<script>
(function(){
  function toNumber(s){
    if(!s) return NaN;
    return parseFloat(String(s).replace(/,/g,'').trim());
  }
  function fmtNumber(n){
    try { return (new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})).format(n); }
    catch(e){ return String(n); }
  }

  function enhance(textEl){
    try{
      if(!textEl) return;
      const raw = (textEl.getAttribute('data-raw') || textEl.textContent || '').trim();
      if(!raw || raw === '‚Äî') return;

      // Prevent re-processing loops
      if(textEl.getAttribute('data-enhanced') === '1' && textEl.getAttribute('data-raw') === raw) return;

      textEl.setAttribute('data-raw', raw);

      // Pull key parts using regex on RAW text
      const totalsRe = /Totals compare[^:]*:\s*HTML Debit\s*([0-9,]+\.[0-9]{2})\s*vs\s*TXT Debit\s*([0-9,]+\.[0-9]{2})\s*\(Œî\s*([0-9,]+\.[0-9]{2})\)\s*;\s*HTML Credit\s*([0-9,]+\.[0-9]{2})\s*vs\s*TXT Credit\s*([0-9,]+\.[0-9]{2})\s*\(Œî\s*([0-9,]+\.[0-9]{2})\)/i;
      const countRe  = /Debit\/Credit count:\s*HTML\s*Dr\s*(\d+),\s*Cr\s*(\d+)\s*;\s*TXT\s*Dr\s*(\d+),\s*Cr\s*(\d+)/i;

      const tm = raw.match(totalsRe);
      const cm = raw.match(countRe);

      // Build HTML safely
      let html = raw
        .replace(/\bMATCHED\b/g,'<span class="status-matched">MATCHED</span>')
        .replace(/\bNOT MATCHED\b/g,'<span class="status-not-matched">NOT MATCHED</span>');

      // Replace totals line with table
      if(tm){
        const hDr = toNumber(tm[1]), tDr = toNumber(tm[2]), dDr = toNumber(tm[3]);
        const hCr = toNumber(tm[4]), tCr = toNumber(tm[5]), dCr = toNumber(tm[6]);
        const bothZero = (dDr === 0 && dCr === 0);
        const cls = bothZero ? 'delta-good' : 'delta-bad';
        const table =
          '<table aria-label="Totals compare">' +
            '<thead><tr><th></th><th>Debit Total</th><th>Credit Total</th></tr></thead>' +
            '<tbody>' +
              '<tr><td class="rowhdr">HTML</td><td>'+fmtNumber(hDr)+'</td><td>'+fmtNumber(hCr)+'</td></tr>' +
              '<tr><td class="rowhdr">TXT (system excluded)</td><td>'+fmtNumber(tDr)+'</td><td>'+fmtNumber(tCr)+'</td></tr>' +
              '<tr><td class="rowhdr">Œî Difference</td>' +
                '<td><span class="'+cls+'">Œî '+fmtNumber(dDr)+'</span></td>' +
                '<td><span class="'+cls+'">Œî '+fmtNumber(dCr)+'</span></td>' +
              '</tr>' +
            '</tbody>' +
          '</table>';

        html = html.replace(totalsRe, table);
      }

      // Replace count line with table
      if(cm){
        const table =
          '<table aria-label="Debit and Credit counts">' +
            '<thead><tr><th></th><th>Debit Count</th><th>Credit Count</th></tr></thead>' +
            '<tbody>' +
              '<tr><td class="rowhdr">HTML</td><td>'+cm[1]+'</td><td>'+cm[2]+'</td></tr>' +
              '<tr><td class="rowhdr">TXT (system excluded)</td><td>'+cm[3]+'</td><td>'+cm[4]+'</td></tr>' +
            '</tbody>' +
          '</table>';
        html = html.replace(countRe, table);
      }

      // Convert line breaks to <br> (after table insertion)
      // First, temporarily protect tables
      const tables = [];
      html = html.replace(/<table[\s\S]*?<\/table>/g, function(m){ tables.push(m); return '%%TABLE_'+(tables.length-1)+'%%'; });

      html = html.replace(/\n/g,'<br>');

      html = html.replace(/%%TABLE_(\d+)%%/g, function(_,i){ return tables[parseInt(i,10)] || ''; });

      textEl.innerHTML = html;
      textEl.setAttribute('data-enhanced','1');
    }catch(e){
      // Never break app loading
      console && console.warn && console.warn('Observation enhance failed', e);
    }
  }

  function boot(){
    const el = document.getElementById('sumObservation');
    if(!el) return;

    // Observe changes (summary is generated after compare)
    const mo = new MutationObserver(function(){
      enhance(el);
    });
    mo.observe(el, {childList:true, characterData:true, subtree:true});

    // Also run once
    enhance(el);
  }

  window.addEventListener('load', boot);
})();
</script>

</body>
</html>
