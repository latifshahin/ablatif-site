<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Transfer Audit Tool v15 (HTML + TXT)</title>
<style>
  body{font-family: Arial, sans-serif; padding:16px; line-height:1.35;}
  .row{display:flex; gap:16px; flex-wrap:wrap;}
  .card{border:1px solid #ddd; border-radius:10px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.06);}
  .card h3{margin:0 0 10px;}
  .w50{flex:1 1 520px;}
  .w100{flex:1 1 100%;}
  input[type=file]{margin:6px 0;}
  button{padding:8px 12px; border-radius:8px; border:1px solid #999; background:#f7f7f7; cursor:pointer;}
  button:hover{background:#efefef;}
  table{border-collapse:collapse; width:100%; margin-top:10px;}
  th,td{border:1px solid #bbb; padding:6px 8px; font-size:13px; vertical-align:top;}
  th{background:#f2f2f2; text-align:left; position:sticky; top:0;}
  td.num{text-align:right;}
  .small{font-size:12px; color:#444;}
  .pill{display:inline-block; padding:2px 8px; border:1px solid #ccc; border-radius:999px; margin:2px 4px 2px 0;}
  .list{max-height:240px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:8px;}
  .scrollTable{max-height:360px; overflow:auto; border:1px solid #ddd; border-radius:8px;}
  .muted{color:#666;}
  .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
  .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;}
  .btnRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center;}
  @media (max-width: 1100px){ .grid3{grid-template-columns:1fr;} }
  @media (max-width: 900px){ .grid2{grid-template-columns:1fr;} }
  code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}

  /* --- Smart UI tweaks --- */
  h2{margin:0 0 6px;}
  .topbar{position:sticky; top:0; background:#fff; padding:10px 0; z-index:20; border-bottom:1px solid #eee; margin-bottom:10px;}
  .nav{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .nav a{color:#0b57d0; text-decoration:none; font-size:13px; padding:6px 10px; border:1px solid #d7e3ff; border-radius:999px; background:#f5f9ff;}
  .nav a:hover{background:#eaf2ff;}
  .kpis{display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap:10px; margin-top:10px;}
  .kpi{border:1px solid #e5e5e5; border-radius:12px; padding:10px; background:#fcfcfc;}
  .kpi .label{font-size:12px; color:#666;}
  .kpi .value{font-size:18px; font-weight:700; margin-top:4px;}
  .kpi .sub{font-size:12px; color:#666; margin-top:2px;}
  .sectionTitle{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;}
  .tag{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; background:#fafafa; font-size:12px; color:#444;}
  .btnRow .ghost{background:#fff;}
  .btnRow .primary{background:#0b57d0; border-color:#0b57d0; color:#fff;}
  .btnRow .primary:hover{background:#0949ae;}
  .btnRow .pillBtn{border-radius:999px;}
  .divider{height:1px; background:#eee; margin:14px 0;}
  @media (max-width: 1050px){
    .kpis{grid-template-columns: repeat(2, minmax(180px, 1fr));}
  }
  /* --- Print / PDF preview (Browser Print) --- */
  #printArea{display:none;}
  body.printing #printArea{display:block;}

  body.printing > *:not(#printArea){display:none !important;}
  body.printing #printArea{display:block !important;}

  .pagebreak{display:none;}
  @media print{
    .pagebreak{display:block; break-before: page; page-break-before: always;}
    /* When printing summary, stack columns */
    #summary .grid2{grid-template-columns:1fr !important;}
  }

  @media print{
    .no-print{display:none !important;}
    body{padding:0;}
    .card{border:none; box-shadow:none;}
    th{position:static;}
    .scrollTable{max-height:none; overflow:visible; border:none;}
    .list{max-height:none; overflow:visible;}
  }


  /* --- Compact typography --- */
  body{font-size:14px;}
  h2{font-size:20px;}
  h3{font-size:16px;}
  h4{font-size:14px;}
  th,td{font-size:12px;}
  .small{font-size:11px;}
  button{font-size:12px;}
  input,select{font-size:12px;}

  /* --- Checkbox list in 2 columns --- */
  .list.twoCol{
    column-count: 2;
    column-gap: 14px;
  }
  .list.twoCol > div{
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    page-break-inside: avoid;
    margin-bottom: 4px;
  }
  @media (max-width: 900px){
    .list.twoCol{column-count: 1;}
  }


  /* --- Credit modal --- */
  .modalOverlay{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; padding:16px;}
  .modal{background:#fff; border-radius:14px; max-width:560px; width:100%; box-shadow:0 10px 30px rgba(0,0,0,.25); border:1px solid #e5e5e5;}
  .modalHeader{padding:12px 14px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .modalHeader h3{margin:0; font-size:15px;}
  .modalBody{padding:12px 14px; font-size:13px; color:#333; line-height:1.45;}
  .modalFooter{padding:12px 14px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:8px;}
  .modalClose{border-radius:10px; padding:8px 12px; border:1px solid #999; background:#f7f7f7; cursor:pointer; font-size:12px;}
  .modalClose:hover{background:#efefef;}


  .printFrame{background:#fff; padding:12px; border:1px dashed #ddd; border-radius:10px;}
  @media print{
    body{padding:0;}
    .no-print{display:none !important;}
    .section{break-inside:avoid;}
    .printFrame{border:none;}
  }
</style>
</head>
<body>


<div class="modalOverlay" id="creditOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <h3>Credit / ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</h3>
      <button class="modalClose" onclick="hideCredit()">‚úï</button>
    </div>
    <div class="modalBody">
      <div><b>‡¶Ö‡¶ó‡ßç‡¶∞‡¶£‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶™‡¶ø‡¶è‡¶≤‡¶∏‡¶ø</b>, ‡¶ú‡¶æ‡¶Æ‡¶æ‡¶≤‡¶™‡ßÅ‡¶∞ ‡¶∂‡¶æ‡¶ñ‡¶æ</div>
      <div style="margin-top:6px;"><b>‡¶Ü‡¶¨‡ßç‡¶¶‡ßÅ‡¶≤ ‡¶≤‡¶§‡¶ø‡¶´ (‡¶è‡¶∏‡¶™‡¶ø‡¶ì)</b></div>
      <div>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ‡ß¶‡ßß‡ß´‡ß´‡ß®‡ß©‡ß´‡ßÆ‡ß≠‡ßØ‡ß¨</div>
      <div>‡¶á‡¶Æ‡ßá‡¶á‡¶≤: latifshahin@gmail.com</div>
      <div class="muted small" style="margin-top:8px;">‡¶è‡¶á ‡¶ü‡ßÅ‡¶≤‡¶ü‡¶ø ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ (Before COB HTML) ‡¶¨‡¶®‡¶æ‡¶Æ COB report (After COB TXT) ‡¶Æ‡¶ø‡¶≤‡¶ø‡ßü‡ßá ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø/‡¶Ö‡¶°‡¶ø‡¶ü ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§</div>
    </div>
    <div class="modalFooter">
      <button class="modalClose" onclick="hideCredit()">OK</button>
    </div>
  </div>
</div>


<div class="topbar no-print">
  <div class="nav">
    <span class="tag">Quick jump</span>
    <a href="#upload">Upload</a>
    <a href="#auditHtml">HTML missing</a>
    <a href="#auditTxt">TXT missing</a>
    <a href="#summary">Category summary</a>
  </div>
</div>


<h2>Transfer Audit Tool v15</h2>
<div class="small muted">
  ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø: ‡¶¶‡ßÅ‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá <b>Missing FT ref</b> ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ, ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø missing FT-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ú‡ßú‡¶ø‡¶§ <b>Inputter, Amount, Dr/Cr Category</b> ‡¶∏‡¶π <b>‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</b> ‡¶¶‡ßá‡¶ñ‡¶æ/‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡•§<br/>
  ‚úÖ <b>HTML missing in TXT</b> ‡¶è‡¶¨‡¶Ç ‚úÖ <b>TXT missing in HTML</b> ‚Äî ‡¶¶‡ßÅ‡¶ü‡ßã‡¶á <b>‡¶≠‡¶ø‡¶â ‡¶Æ‡ßÅ‡¶°‡ßá</b> ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¶‡ßÅ‡¶¶‡¶ø‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø <b>‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ filter</b> ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
</div>

<div class="row" style="margin-top:12px;">
  <div class="card w50 section" id="upload">
    <div class="sectionTitle"><h3>Step 1 ‚Äî ‡¶´‡¶æ‡¶á‡¶≤ Upload</h3><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('upload')">PDF Preview</button></div></div>
    <div><b>Before COB (HTML register):</b> <input type="file" id="htmlFile" accept=".html,.htm,text/html"/></div>
    <div><b>After COB (TXT register):</b> <input type="file" id="txtFile" accept=".txt,text/plain"/></div>
    <div class="btnRow">
      <button onclick="loadAll()">Load & Compare</button>
      <span id="status" class="small muted"></span>
    </div>
    <div class="small muted" style="margin-top:8px;">
      Debug: ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶ï‡ßç‡¶∏‡ßá parse/compare counts ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‚Äî‡¶Ø‡¶¶‡¶ø ref 0 ‡¶π‡ßü ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßã‡¶ù‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá TXT/HTML ‡¶•‡ßá‡¶ï‡ßá ref ‡¶™‡ßú‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§
    </div>
  </div>

  <div class="card w50 section" id="debugBox">
    <div class="sectionTitle"><h3>Debug / Counts</h3><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('debugBox')">PDF Preview</button></div></div>
    <div id="debug" class="small" style="white-space:pre-wrap;"></div>
  </div>

  
  <div class="card w100 section" id="kpis">
    <div class="sectionTitle">
      <h3>At-a-glance</h3>
      <div class="right no-print">
        <button class="pillBtn ghost" onclick="printSection('kpis')">PDF Preview</button>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi">
        <div class="label">HTML ‚Äî Rows / Unique FT</div>
        <div class="value" id="kpiHtmlRows">0</div>
        <div class="sub">Unique: <span id="kpiHtmlRefs">0</span></div>
      </div>
      <div class="kpi">
        <div class="label">TXT ‚Äî Rows / Unique FT</div>
        <div class="value" id="kpiTxtRows">0</div>
        <div class="sub">Unique: <span id="kpiTxtRefs">0</span></div>
      </div>
      <div class="kpi">
        <div class="label">Missing counts</div>
        <div class="value"><span id="kpiHtmlMissing">0</span> / <span id="kpiTxtMissing">0</span></div>
        <div class="sub">HTML-in-TXT / TXT-in-HTML</div>
      </div>
      <div class="kpi">
        <div class="label">Cross-file totals (Summary filters)</div>
        <div class="value">ŒîDebit: <span id="kpiDebitDelta">0.00</span></div>
        <div class="sub">ŒîCredit: <span id="kpiCreditDelta">0.00</span></div>
      </div>
    </div>
  </div>



<div class="card w100 section" id="summaryOnePage">
  <div class="sectionTitle">
    <h3>üßæ One-page Audit Summary (Print / Save as PDF)</h3>
    <div class="right no-print">
      <button class="pillBtn" onclick="printSummaryPage()">Print / Save PDF</button>
      <button class="pillBtn ghost" onclick="downloadFindingsCSV()">Export Findings (CSV)</button>
    </div>
  </div>

  <div id="summaryPageOnly" class="printFrame">
    <div style="text-align:center; margin-bottom:10px;">
      <div style="font-size:18px; font-weight:800;" id="sumBankTitle">AGRANI BANK PLC</div>
      <div style="font-size:14px; font-weight:700;" id="sumBranchTitle">JAMALPUR BRANCH</div>
      <div style="font-size:14px; font-weight:700;">Transfer Audit Summary</div>
      <div class="small muted" style="margin-top:4px;">
        Date: <span id="sumDate">‚Äî</span> &nbsp; | &nbsp; Audit Ref: <span id="sumAuditRef">‚Äî</span> &nbsp; | &nbsp; Generated: <span id="sumGeneratedAt">‚Äî</span>
      </div>
    </div>

    <div class="grid2" style="gap:12px;">
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Files</div>
        <div class="small">Before COB (HTML): <span id="sumHtmlFile">‚Äî</span></div>
        <div class="small">After COB (TXT): <span id="sumTxtFile">‚Äî</span></div>
      </div>
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Key Metrics</div>
        <div class="small">HTML unique FT refs: <b><span id="sumHtmlRefs">0</span></b></div>
        <div class="small">TXT unique FT refs: <b><span id="sumTxtRefs">0</span></b></div>
        <div class="small">Matched refs: <b><span id="sumMatched">0</span></b></div>
      </div>
    </div>

    
    <div class="grid2" style="gap:12px; margin-top:12px;">
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Totals (per file)</div>
        <div class="small">HTML Debit Total: <b><span id="sumHtmlDebitTotal">0.00</span></b></div>
        <div class="small">HTML Credit Total: <b><span id="sumHtmlCreditTotal">0.00</span></b></div>
        <div class="small">TXT Debit Total: <b><span id="sumTxtDebitTotal">0.00</span></b></div>
        <div class="small">TXT Credit Total: <b><span id="sumTxtCreditTotal">0.00</span></b></div>
      </div>
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Largest Transactions</div>
        <div class="small">Max Debit: <b><span id="sumMaxDebitAmt">0.00</span></b> &nbsp; | &nbsp; Ref: <span id="sumMaxDebitRef">‚Äî</span> &nbsp; | &nbsp; Source: <span id="sumMaxDebitSrc">‚Äî</span></div>
        <div class="small">Max Credit: <b><span id="sumMaxCreditAmt">0.00</span></b> &nbsp; | &nbsp; Ref: <span id="sumMaxCreditRef">‚Äî</span> &nbsp; | &nbsp; Source: <span id="sumMaxCreditSrc">‚Äî</span></div>
      </div>
    </div>

    <div class="grid2" style="gap:12px; margin-top:12px;">
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Inputter Summary (HTML)</div>
        <div class="small muted">Count + Total Amount</div>
        <div id="sumHtmlInputterTable" class="small" style="margin-top:6px;"></div>
      </div>
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Inputter Summary (TXT)</div>
        <div class="small muted">Count + Total Amount</div>
        <div id="sumTxtInputterTable" class="small" style="margin-top:6px;"></div>
      </div>
    </div>
<div class="grid3" style="gap:12px; margin-top:12px;">
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Findings</div>
        <div class="small">HTML missing in TXT: <b><span id="sumMissInTxt">0</span></b></div>
        <div class="small">TXT missing in HTML: <b><span id="sumMissInHtml">0</span></b></div>
        <div class="small">Amount mismatch: <b><span id="sumAmtMismatch">0</span></b></div>
      </div>
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Data quality</div>
        <div class="small">HTML duplicate FT refs: <b><span id="sumDupHtml">0</span></b></div>
        <div class="small">TXT duplicate FT refs: <b><span id="sumDupTxt">0</span></b></div>
        <div class="small">Blank/invalid refs: <b><span id="sumBlankRefs">0</span></b></div>
      </div>
      <div class="card" style="border:1px solid #e5e5e5;">
        <div class="small muted">Observation</div>
        <div class="small" id="sumObservation">‚Äî</div>
      </div>
    </div>

    <div class="card" style="border:1px solid #e5e5e5; margin-top:12px;">
      <div class="small muted">Prepared by</div>
      <div class="small"><b>Abdul Latif (SPO)</b></div>
      <div class="small">Agrani Bank PLC, Jamalpur Branch</div>
      <div class="small">Contact: 01552358796 &nbsp; | &nbsp; Email: latifshahin@gmail.com</div>
      <div class="small muted" style="margin-top:6px;">For Internal Audit & Control Purpose Only</div>
    </div>
  </div>
</div>

<div class="card w100 section" id="auditHtml">
    <div class="sectionTitle"><h3>‚úÖ Audit Result 1: HTML-‡¶è ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ TXT-‡¶è ‡¶®‡ßá‡¶á (Full Details)</h3><div class="right no-print"><label class="small muted" style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input type="checkbox" id="htmlCompact" onchange="applyMissing(\'html\')"> Compact view</label><button class="pillBtn ghost" onclick="printSection('auditHtml')">PDF Preview</button></div></div>
    <div class="small muted" id="htmlMissCount"></div>

    <div class="card" style="background:#fbfbfb;">
      <div class="grid2">
        <div>
          <div class="small muted"><b>Search (HTML missing)</b></div>
          <input id="htmlMissSearch" type="text" placeholder="FT / Account / Title / Inputter / Category" style="width:100%; padding:8px; border-radius:8px; border:1px solid #bbb;">
        </div>
        <div>
          <div class="small muted"><b>Amount range (optional)</b></div>
          <div class="btnRow">
            <input id="htmlMinAmt" type="number" step="0.01" placeholder="Min (any)" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;">
            <input id="htmlMaxAmt" type="number" step="0.01" placeholder="Max (any)" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;">
          </div>
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <div class="small muted"><b>Inputter Select/Deselect</b></div>
          <div class="list" id="htmlMissInputters" class="list twoCol" id="htmlMissInputters"></div>
          <div class="btnRow">
            <button onclick="checkAll('htmlMissInputters', true)">Select all</button>
            <button onclick="checkAll('htmlMissInputters', false)">Clear</button>
          </div>
        </div>
        <div>
          <div class="small muted"><b>Dr.Category Select/Deselect</b></div>
          <div class="list" id="htmlMissDrCats" class="list twoCol" id="htmlMissDrCats"></div>
          <div class="btnRow">
            <button onclick="checkAll('htmlMissDrCats', true)">Select all</button>
            <button onclick="checkAll('htmlMissDrCats', false)">Clear</button>
          </div>
        </div>
        <div>
          <div class="small muted"><b>Cr.Category Select/Deselect</b></div>
          <div class="list" id="htmlMissCrCats" class="list twoCol" id="htmlMissCrCats"></div>
          <div class="btnRow">
            <button onclick="checkAll('htmlMissCrCats', true)">Select all</button>
            <button onclick="checkAll('htmlMissCrCats', false)">Clear</button>
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button onclick="applyMissing('html')">Apply</button>
        <button onclick="resetMissing('html')">Reset</button>
        <button onclick="copyRefs('html')">Copy FT list</button>
        <button onclick="downloadCSV('html')">Download CSV</button>
      </div>
    </div>

    <div class="scrollTable" style="margin-top:10px;">
      <table id="htmlMissTable">
        <thead><tr id="htmlMissHead"></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card w100 section" id="auditTxt">
    <div class="sectionTitle"><h3>‚úÖ Audit Result 2: TXT-‡¶è ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ HTML-‡¶è ‡¶®‡ßá‡¶á (Full Details)</h3><div class="right no-print"><label class="small muted" style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input type="checkbox" id="txtCompact" onchange="applyMissing(\'txt\')"> Compact view</label><button class="pillBtn ghost" onclick="printSection('auditTxt')">PDF Preview</button></div></div>
    <div class="small muted" id="txtMissCount"></div>

    <div class="card" style="background:#fbfbfb;">
      <div class="grid2">
        <div>
          <div class="small muted"><b>Search (TXT missing)</b></div>
          <input id="txtMissSearch" type="text" placeholder="FT / Account / Title / Inputter / Category" style="width:100%; padding:8px; border-radius:8px; border:1px solid #bbb;">
        </div>
        <div>
          <div class="small muted"><b>Amount range (optional)</b></div>
          <div class="btnRow">
            <input id="txtMinAmt" type="number" step="0.01" placeholder="Min (any)" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;">
            <input id="txtMaxAmt" type="number" step="0.01" placeholder="Max (any)" style="flex:1; min-width:160px; padding:8px; border-radius:8px; border:1px solid #bbb;">
          </div>
        </div>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <div class="small muted"><b>Inputter Select/Deselect</b></div>
          <div class="list" id="txtMissInputters" class="list twoCol" id="txtMissInputters"></div>
          <div class="btnRow">
            <button onclick="checkAll('txtMissInputters', true)">Select all</button>
            <button onclick="checkAll('txtMissInputters', false)">Clear</button>
          </div>
        </div>
        <div>
          <div class="small muted"><b>Dr.Category Select/Deselect</b></div>
          <div class="list" id="txtMissDrCats" class="list twoCol" id="txtMissDrCats"></div>
          <div class="btnRow">
            <button onclick="checkAll('txtMissDrCats', true)">Select all</button>
            <button onclick="checkAll('txtMissDrCats', false)">Clear</button>
          </div>
        </div>
        <div>
          <div class="small muted"><b>Cr.Category Select/Deselect</b></div>
          <div class="list" id="txtMissCrCats" class="list twoCol" id="txtMissCrCats"></div>
          <div class="btnRow">
            <button onclick="checkAll('txtMissCrCats', true)">Select all</button>
            <button onclick="checkAll('txtMissCrCats', false)">Clear</button>
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button onclick="applyMissing('txt')">Apply</button>
        <button onclick="resetMissing('txt')">Reset</button>
        <button onclick="copyRefs('txt')">Copy FT list</button>
        <button onclick="downloadCSV('txt')">Download CSV</button>
      </div>
    </div>

    <div class="scrollTable" style="margin-top:10px;">
      <table id="txtMissTable">
        <thead><tr id="txtMissHead"></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <div class="card w100 section" id="summary">
    <div class="sectionTitle"><h3>Category Summary (Filtered) ‚Äî Important</h3><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('summary')">PDF Preview</button></div></div>
    <div class="small muted">
      HTML ‡¶è‡¶¨‡¶Ç TXT‚Äî‡¶¶‡ßÅ‡¶á ‡¶™‡¶æ‡¶∂‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ Inputter Select/Deselect ‡¶Ü‡¶õ‡ßá‡•§ ‡¶ü‡¶ø‡¶ï/‡¶Ü‡¶®‡¶ü‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá Category-wise Total Debit/Credit ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div class="card section" id="summaryHtml" style="background:#fbfbfb;">
        <div class="sectionTitle"><h4 style="margin:0 0 6px;">HTML Summary ‚Äî Inputter Filter</h4><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('summaryHtml')">PDF (HTML Summary)</button></div></div>
        <div class="small muted">HTML Debit/Credit difference: <b id="htmlSumDiff">0.00</b></div>
        <div class="list" id="htmlSumInputters" class="list twoCol" id="htmlSumInputters"></div>
        <div class="btnRow">
          <button onclick="checkAll('htmlSumInputters', true)">Select all</button>
          <button onclick="checkAll('htmlSumInputters', false)">Clear</button>
          <button onclick="generateSummary('html')">Generate</button>
          <button onclick="downloadSummaryCSV('html')">Download CSV</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <div class="small muted"><b>Debit by Dr.Category</b></div>
            <table id="htmlSumDrTable">
              <thead><tr><th>Dr.Category</th><th class="num">Total Debit</th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th>Total</th><th class="num" id="htmlSumDrTotal">0.00</th></tr></tfoot>
            </table>
          </div>
          <div>
            <div class="small muted"><b>Credit by Cr.Category</b></div>
            <table id="htmlSumCrTable">
              <thead><tr><th>Cr.Category</th><th class="num">Total Credit</th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th>Total</th><th class="num" id="htmlSumCrTotal">0.00</th></tr></tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="pagebreak"></div>

      <div class="card section" id="summaryTxt" style="background:#fbfbfb;">
        <div class="sectionTitle"><h4 style="margin:0 0 6px;">TXT Summary ‚Äî Inputter Filter</h4><div class="right no-print"><button class="pillBtn ghost" onclick="printSection('summaryTxt')">PDF (TXT Summary)</button></div></div>
        <div class="list" id="txtSumInputters" class="list twoCol" id="txtSumInputters"></div>
        <div class="btnRow">
          <button onclick="checkAll('txtSumInputters', true)">Select all</button>
          <button onclick="checkAll('txtSumInputters', false)">Clear</button>
          <button onclick="generateSummary('txt')">Generate</button>
          <button onclick="downloadSummaryCSV('txt')">Download CSV</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <div class="small muted"><b>Debit by Dr.Category</b></div>
            <table id="txtSumDrTable">
              <thead><tr><th>Dr.Category</th><th class="num">Total Debit</th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th>Total</th><th class="num" id="txtSumDrTotal">0.00</th></tr></tfoot>
            </table>
          </div>
          <div>
            <div class="small muted"><b>Credit by Cr.Category</b></div>
            <table id="txtSumCrTable">
              <thead><tr><th>Cr.Category</th><th class="num">Total Credit</th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th>Total</th><th class="num" id="txtSumCrTotal">0.00</th></tr></tfoot>
            </table>
          </div>
        </div>

        <div class="small muted" style="margin-top:8px;">
          TXT Debit/Credit difference: <b id="txtSumDiff">0.00</b>
        <div class="divider"></div>
        <div class="small muted"><b>HTML vs TXT Difference (Summary filters applied)</b><br/>
          ŒîDebit (HTML - TXT): <b id="sumDebitDelta">0.00</b><br/>
          ŒîCredit (HTML - TXT): <b id="sumCreditDelta">0.00</b>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
let htmlRows = [];
let txtRows = [];
let htmlMeta = {bank:'‚Äî', branch:'‚Äî', date:'‚Äî'};
let missingHtmlAll = [];
let missingTxtAll = [];
let missingHtmlFiltered = [];
let missingTxtFiltered = [];

const HTML_COLS = [
  {k:'tr_debit', label:'TR(Debit)'},
  {k:'debit_ac', label:'Debit.Ac.no'},
  {k:'debit_legacy', label:'Debit Legacy'},
  {k:'debit_title', label:'Debit Acct.Title'},
  {k:'debit_amt', label:'Debit.Amt'},
  {k:'cheque', label:'Chq'},
  {k:'dr_cat', label:'Dr.Category'},
  {k:'tr_credit', label:'TR(Credit)'},
  {k:'credit_ac', label:'Credit.Ac.no'},
  {k:'credit_legacy', label:'Credit Legacy'},
  {k:'credit_title', label:'Credit Acct.Title'},
  {k:'credit_amt', label:'Credit.Amt'},
  {k:'cr_cat', label:'Cr.Category'},
  {k:'type', label:'Type'},
  {k:'ref', label:'Trans.Rf.No'},
  {k:'bulk_ref', label:'Bulk.Rf.No'},
  {k:'inputter', label:'Inputter'},
  {k:'authoriser', label:'Authoriser'},
  {k:'time', label:'Time'},
  {k:'debit_branch', label:'Debit Branch'},
  {k:'credit_branch', label:'Credit Branch'}
];

const TXT_COLS = [
  {k:'tr_debit', label:'Tr'},
  {k:'debit_ac', label:'Debit Ac no'},
  {k:'debit_legacy', label:'Legacy no'},
  {k:'debit_title', label:'Debit Account Title'},
  {k:'debit_amt', label:'Debit Amount'},
  {k:'cheque', label:'Cheque'},
  {k:'dr_cat', label:'Dr.Category'},
  {k:'tr_credit', label:'Tr'},
  {k:'credit_ac', label:'Credit Ac no'},
  {k:'credit_legacy', label:'Legacy no'},
  {k:'credit_title', label:'Credit Account Title'},
  {k:'credit_amt', label:'Credit Amount'},
  {k:'cr_cat', label:'Cr.Category'},
  {k:'type', label:'Type'},
  {k:'ref', label:'Trans ref no'},
  {k:'inputter', label:'Inputter'},
  {k:'authoriser', label:'Authoriser'},
  {k:'time', label:'Time'}
];

// Compact columns (requested)
const HTML_COLS_COMPACT = [
  {k:'debit_ac', label:'Debit.Ac.no'},
  {k:'debit_legacy', label:'Debit Legacy'},
  {k:'debit_title', label:'Debit Acct.Title'},
  {k:'debit_amt', label:'Debit.Amt'},
  {k:'credit_ac', label:'Credit.Ac.no'},
  {k:'credit_legacy', label:'Credit Legacy'},
  {k:'credit_title', label:'Credit Acct.Title'},
  {k:'credit_amt', label:'Credit.Amt'},
  {k:'ref', label:'Trans.Rf.No'},
];

const TXT_COLS_COMPACT = [
  {k:'debit_ac', label:'Debit.Ac.no'},
  {k:'debit_legacy', label:'Debit Legacy'},
  {k:'debit_title', label:'Debit Acct.Title'},
  {k:'debit_amt', label:'Debit.Amt'},
  {k:'credit_ac', label:'Credit.Ac.no'},
  {k:'credit_legacy', label:'Credit Legacy'},
  {k:'credit_title', label:'Credit Acct.Title'},
  {k:'credit_amt', label:'Credit.Amt'},
  {k:'ref', label:'Trans.Rf.No'},
];



function setStatus(msg){ document.getElementById('status').textContent = msg; }
function debug(msg){ document.getElementById('debug').textContent = msg; }

function readFile(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsText(file);
  });
}

function toNum(s){
  if(s === null || s === undefined) return NaN;
  const t = String(s).replace(/,/g,'').trim();
  if(!t) return NaN;
  const n = Number(t);
  return isFinite(n) ? n : NaN;
}

function fmt(n){
  const x = Number(n);
  return (isFinite(x) ? x : 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}

function uniq(arr){
  return [...new Set(arr.filter(x => x !== null && x !== undefined && String(x).trim() !== '').map(x=>String(x)))];
}

function normalizeFT(val){
  if(!val) return '';
  const m = String(val).match(/\bFT[0-9A-Z]+\b/);
  return m ? m[0].trim() : String(val).trim();
}

function rowText(row){
  return Object.values(row).map(v => (v ?? '').toString().toLowerCase()).join(' | ');
}

/* TXT parsing */
function findHeaderLine(lines){
  const want = ['Debit Amount', 'Dr.Category', 'Credit Amount', 'Cr.Category', 'Trans ref no', 'Inputter', 'Authoriser', 'Time'];
  for (let i=0; i<lines.length; i++){
    const L = lines[i];
    let ok = true;
    for (const w of want){
      if (!L.includes(w)) { ok = false; break; }
    }
    if (ok) return {index: i, line: L};
  }
  return null;
}

function nthIndexOf(str, sub, n){
  let idx = -1, from = 0;
  for (let i = 0; i < n; i++){
    idx = str.indexOf(sub, from);
    if (idx < 0) return -1;
    from = idx + sub.length;
  }
  return idx;
}

function buildRangesFromHeader(headerLine){
  const cols = [
    {key:'Tr', name:'tr_debit', occ:1},
    {key:'Debit Ac no', name:'debit_ac', occ:1},
    {key:'Legacy no', name:'debit_legacy', occ:1},
    {key:'Debit Account Title', name:'debit_title', occ:1},
    {key:'Debit Amount', name:'debit_amt', occ:1},
    {key:'Cheque', name:'cheque', occ:1},
    {key:'Dr.Category', name:'dr_cat', occ:1},
    {key:'Tr', name:'tr_credit', occ:2},
    {key:'Credit Ac no', name:'credit_ac', occ:1},
    {key:'Legacy no', name:'credit_legacy', occ:2},
    {key:'Credit Account Title', name:'credit_title', occ:1},
    {key:'Credit Amount', name:'credit_amt', occ:1},
    {key:'Cr.Category', name:'cr_cat', occ:1},
    {key:'Type', name:'type', occ:1},
    {key:'Trans ref no', name:'ref', occ:1},
    {key:'Inputter', name:'inputter', occ:1},
    {key:'Authoriser', name:'authoriser', occ:1},
    {key:'Time', name:'time', occ:1},
  ];

  const starts = [];
  for (const c of cols){
    const s = nthIndexOf(headerLine, c.key, c.occ || 1);
    if (s >= 0) starts.push({name:c.name, start:s});
  }
  starts.sort((a,b)=>a.start-b.start);

  const ranges = [];
  for (let i=0; i<starts.length; i++){
    const cur = starts[i];
    const end = (i < starts.length-1) ? starts[i+1].start : headerLine.length + 120;
    ranges.push({name: cur.name, start: cur.start, end});
  }
  return ranges;
}

function sliceByRange(line, ranges, name){
  const r = ranges.find(x=>x.name===name);
  if(!r) return '';
  return line.substring(r.start, Math.min(r.end, line.length)).trim();
}

function parseTXTFixedWidth(tText){
  const lines = tText.split(/\r?\n/);
  const hdr = findHeaderLine(lines);
  if(!hdr) return {rows:[], refCount:0, note:"Header not found"};

  // --- meta: bank/branch/date (best-effort) ---
  const headText = lines.slice(0, Math.min(hdr.index+1, 40)).join(" ").replace(/\s+/g," ").trim();
  const bankMatch = headText.match(/([A-Z][A-Z\s\.]+BANK\s+P\.?L\.?C\.?|[A-Z][A-Z\s\.]+BANK\s+LIMITED)/i);
  const branchMatch = headText.match(/([A-Z][A-Z\s]+BRANCH)/i);
  const dateMatch = headText.match(/(\b[0-9]{4}[-\/][0-9]{2}[-\/][0-9]{2}\b|\b[0-9]{1,2}\s+[A-Z]{3}\s+[0-9]{4}\b)/i);
  const bank = bankMatch ? bankMatch[1].toUpperCase().replace(/\s+/g," ").trim() : "‚Äî";
  const branch = branchMatch ? branchMatch[1].toUpperCase().replace(/\s+/g," ").trim() : "‚Äî";
  const date = dateMatch ? dateMatch[1].toUpperCase().trim() : "‚Äî";

  let ranges = buildRangesFromHeader(hdr.line);
  const rows = [];

  for (let i = hdr.index + 1; i < lines.length; i++){
    const L = lines[i];
    if (!L || !L.trim()) continue;

    if (L.includes('Debit Amount') && L.includes('Trans ref no') && L.includes('Inputter')){
      ranges = buildRangesFromHeader(L);
      continue;
    }

    if (!/\bFT[0-9A-Z]+\b/.test(L)) continue;

    let ref = sliceByRange(L, ranges, 'ref');
    ref = normalizeFT(ref);

    rows.push({
      tr_debit: sliceByRange(L, ranges, 'tr_debit'),
      debit_ac: sliceByRange(L, ranges, 'debit_ac'),
      debit_legacy: sliceByRange(L, ranges, 'debit_legacy'),
      debit_title: sliceByRange(L, ranges, 'debit_title'),
      debit_amt: toNum(sliceByRange(L, ranges, 'debit_amt')),
      cheque: sliceByRange(L, ranges, 'cheque'),
      dr_cat: sliceByRange(L, ranges, 'dr_cat') || '(Blank)',
      tr_credit: sliceByRange(L, ranges, 'tr_credit'),
      credit_ac: sliceByRange(L, ranges, 'credit_ac'),
      credit_legacy: sliceByRange(L, ranges, 'credit_legacy'),
      credit_title: sliceByRange(L, ranges, 'credit_title'),
      credit_amt: toNum(sliceByRange(L, ranges, 'credit_amt')),
      cr_cat: sliceByRange(L, ranges, 'cr_cat') || '(Blank)',
      type: sliceByRange(L, ranges, 'type'),
      ref,
      inputter: sliceByRange(L, ranges, 'inputter') || '(Blank)',
      authoriser: sliceByRange(L, ranges, 'authoriser'),
      time: sliceByRange(L, ranges, 'time')
    });
  }

  const refCount = new Set(rows.map(r=>r.ref).filter(Boolean)).size;
  return {rows, refCount, note:"OK", meta:{bank, branch, date}};
}

/* HTML parsing */
function parseHTML(hText){
  const dom = new DOMParser().parseFromString(hText, 'text/html');
  // meta: bank/branch/date (best-effort)
  const pageText = (dom.body ? dom.body.textContent : '').replace(/\u00a0/g,' ').replace(/\s+/g,' ').trim();
  const bankMatch = pageText.match(/([A-Z][A-Z\s\.]+BANK\s+LIMITED)/i);
  const branchMatch = pageText.match(/([A-Z][A-Z\s]+BRANCH\s*\d*)/i);
  const dateMatch = pageText.match(/Transaction\s*Date\s*[:-]?\s*([0-9]{1,2}\s+[A-Z]{3}\s+[0-9]{4})/i);
  const bank = bankMatch ? bankMatch[1].toUpperCase().trim() : '‚Äî';
  const branch = branchMatch ? branchMatch[1].toUpperCase().trim() : '‚Äî';
  const date = dateMatch ? dateMatch[1].toUpperCase().trim() : '‚Äî';

  const trs = dom.querySelectorAll('tr');
  const rows = [];
  trs.forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if (tds.length >= 21){
      const c = Array.from(tds).map(td => td.textContent.replace(/\u00a0/g,' ').trim());
      const ref = normalizeFT(c[14] || '');
      if (ref.startsWith('FT')){
        rows.push({
          tr_debit: c[0] || '',
          debit_ac: c[1] || '',
          debit_legacy: c[2] || '',
          debit_title: c[3] || '',
          debit_amt: toNum(c[4]),
          cheque: c[5] || '',
          dr_cat: (c[6] || '').trim() || '(Blank)',
          tr_credit: c[7] || '',
          credit_ac: c[8] || '',
          credit_legacy: c[9] || '',
          credit_title: c[10] || '',
          credit_amt: toNum(c[11]),
          cr_cat: (c[12] || '').trim() || '(Blank)',
          type: c[13] || '',
          ref,
          bulk_ref: c[15] || '',
          inputter: (c[16] || '').trim() || '(Blank)',
          authoriser: (c[17] || '').trim(),
          time: (c[18] || '').trim(),
          debit_branch: (c[19] || '').trim(),
          credit_branch: (c[20] || '').trim()
        });
      }
    }
  });
  const refCount = new Set(rows.map(r=>r.ref).filter(Boolean)).size;
  return {rows, refCount, note:"OK"};
}

/* checkbox helpers */
function renderCheckboxList(boxId, items){
  const box = document.getElementById(boxId);
  if(!box) return;
  if(!items.length){
    box.innerHTML = '<div class="muted small">No items</div>';
    return;
  }
  box.innerHTML = items.map(v=>{
    const id = boxId + '_' + v.replace(/[^a-zA-Z0-9]/g,'_');
    return `<div><label><input type="checkbox" id="${id}" data-val="${v}" checked> <span class="pill">${v}</span></label></div>`;
  }).join('');
}

function checkAll(boxId, yes){
  const box = document.getElementById(boxId);
  if(!box) return;
  box.querySelectorAll('input[type=checkbox][data-val]').forEach(ch=>ch.checked=!!yes);
}

function getCheckedSet(boxId){
  const box = document.getElementById(boxId);
  if(!box) return new Set();
  const s = new Set();
  box.querySelectorAll('input[type=checkbox][data-val]').forEach(ch=>{
    if(ch.checked) s.add(ch.getAttribute('data-val'));
  });
  return s;
}

/* render table */
function renderTable(headId, tableId, rows, cols){
  const head = document.getElementById(headId);
  const tbody = document.querySelector(`#${tableId} tbody`);
  head.innerHTML = cols.map(c=>`<th>${c.label}</th>`).join('');
  tbody.innerHTML = '';

  if(!rows.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="${cols.length}" class="muted">No data</td>`;
    tbody.appendChild(tr);
    return;
  }

  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = cols.map(c=>{
      const v = r[c.k];
      const isNum = (c.k.endsWith('_amt') || c.k === 'debit_amt' || c.k === 'credit_amt');
      if(isNum){
        const n = Number(v);
        return `<td class="num">${isFinite(n)?fmt(n):''}</td>`;
      }
      return `<td>${(v===undefined || v===null)?'':String(v)}</td>`;
    }).join('');
    tbody.appendChild(tr);
  });
}

/* compare */
function computeMissing(){
  const hSet = new Set(htmlRows.map(r=>r.ref).filter(Boolean));
  const tSet = new Set(txtRows.map(r=>r.ref).filter(Boolean));

  const onlyHtml = new Set([...hSet].filter(r=>!tSet.has(r)));
  const onlyTxt  = new Set([...tSet].filter(r=>!hSet.has(r)));

  missingHtmlAll = htmlRows.filter(r=>onlyHtml.has(r.ref));
  missingTxtAll  = txtRows.filter(r=>onlyTxt.has(r.ref));

  renderCheckboxList('htmlMissInputters', uniq(missingHtmlAll.map(r=>r.inputter)).sort());
  renderCheckboxList('htmlMissDrCats', uniq(missingHtmlAll.map(r=>r.dr_cat)).sort());
  renderCheckboxList('htmlMissCrCats', uniq(missingHtmlAll.map(r=>r.cr_cat)).sort());

  renderCheckboxList('txtMissInputters', uniq(missingTxtAll.map(r=>r.inputter)).sort());
  renderCheckboxList('txtMissDrCats', uniq(missingTxtAll.map(r=>r.dr_cat)).sort());
  renderCheckboxList('txtMissCrCats', uniq(missingTxtAll.map(r=>r.cr_cat)).sort());

  resetMissing('html', true);
  resetMissing('txt', true);
}

function applyMissing(side){
  const isHtml = (side === 'html');
  const all = isHtml ? missingHtmlAll : missingTxtAll;

  const inp = getCheckedSet(isHtml ? 'htmlMissInputters' : 'txtMissInputters');
  const dr  = getCheckedSet(isHtml ? 'htmlMissDrCats' : 'txtMissDrCats');
  const cr  = getCheckedSet(isHtml ? 'htmlMissCrCats' : 'txtMissCrCats');

  const q = (document.getElementById(isHtml ? 'htmlMissSearch' : 'txtMissSearch').value || '').trim().toLowerCase();
  const minA = parseFloat(document.getElementById(isHtml ? 'htmlMinAmt' : 'txtMinAmt').value || '');
  const maxA = parseFloat(document.getElementById(isHtml ? 'htmlMaxAmt' : 'txtMaxAmt').value || '');

  const inRange = (v) => {
    if(!isFinite(v)) return true;
    if(isFinite(minA) && v < minA) return false;
    if(isFinite(maxA) && v > maxA) return false;
    return true;
  };

  const filtered = all.filter(r=>{
    if(inp.size && !inp.has(r.inputter)) return false;
    if(dr.size && !dr.has(r.dr_cat)) return false;
    if(cr.size && !cr.has(r.cr_cat)) return false;

    const anyAmt = isFinite(r.debit_amt) ? r.debit_amt : (isFinite(r.credit_amt) ? r.credit_amt : NaN);
    if(!inRange(Number(anyAmt))) return false;

    if(q && !rowText(r).includes(q)) return false;
    return true;
  });

  if(isHtml){
    missingHtmlFiltered = filtered;
    document.getElementById('htmlMissCount').innerHTML = `Missing count: <b>${filtered.length}</b> (of ${missingHtmlAll.length})`;
    const cols = (document.getElementById('htmlCompact')?.checked) ? HTML_COLS_COMPACT : HTML_COLS;
    renderTable('htmlMissHead', 'htmlMissTable', filtered, cols);
  } else {
    missingTxtFiltered = filtered;
    document.getElementById('txtMissCount').innerHTML = `Missing count: <b>${filtered.length}</b> (of ${missingTxtAll.length})`;
    const cols = (document.getElementById('txtCompact')?.checked) ? TXT_COLS_COMPACT : TXT_COLS;
    renderTable('txtMissHead', 'txtMissTable', filtered, cols);
  }
}

function resetMissing(side, silent=false){
  const isHtml = (side === 'html');
  document.getElementById(isHtml ? 'htmlMissSearch' : 'txtMissSearch').value = '';
  document.getElementById(isHtml ? 'htmlMinAmt' : 'txtMinAmt').value = '';
  document.getElementById(isHtml ? 'htmlMaxAmt' : 'txtMaxAmt').value = '';

  checkAll(isHtml ? 'htmlMissInputters' : 'txtMissInputters', true);
  checkAll(isHtml ? 'htmlMissDrCats' : 'txtMissDrCats', true);
  checkAll(isHtml ? 'htmlMissCrCats' : 'txtMissCrCats', true);

  applyMissing(side);
  if(!silent){
    try { (document.getElementById(isHtml ? 'htmlMissTable' : 'txtMissTable')).scrollIntoView({behavior:'smooth', block:'start'}); } catch(e){}
  }
}

/* copy + csv */
function copyRefs(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? missingHtmlFiltered : missingTxtFiltered;
  const refs = uniq(rows.map(r=>r.ref)).join('\n');
  if(!refs){ alert('No refs to copy'); return; }
  navigator.clipboard.writeText(refs).then(()=>alert('Copied ‚úÖ')).catch(()=>{
    const ta = document.createElement('textarea'); ta.value = refs; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); alert('Copied ‚úÖ');
  });
}

function downloadCSV(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? missingHtmlFiltered : missingTxtFiltered;
  const cols = isHtml ? ((document.getElementById('htmlCompact')?.checked) ? HTML_COLS_COMPACT : HTML_COLS)
                      : ((document.getElementById('txtCompact')?.checked) ? TXT_COLS_COMPACT : TXT_COLS);
  const filename = isHtml ? 'HTML_missing_in_TXT_filtered.csv' : 'TXT_missing_in_HTML_filtered.csv';

  const esc = (s) => {
    const t = String(s ?? '');
    if (/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
    return t;
  };

  const lines = [];
  lines.push(cols.map(c=>esc(c.label)).join(','));
  rows.forEach(r=>{
    lines.push(cols.map(c=>{
      const v = r[c.k];
      return esc((typeof v === 'number' && isFinite(v)) ? v : (v ?? ''));
    }).join(','));
  });

  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


/* -------------------- Category Summary (Filtered) -------------------- */
let htmlSummaryRows = [];
let txtSummaryRows = [];

function buildSummaryInputterLists(){
  // Build from full parsed rows (not missing-only)
  renderCheckboxList('htmlSumInputters', uniq(htmlRows.map(r=>r.inputter)).sort());
  renderCheckboxList('txtSumInputters', uniq(txtRows.map(r=>r.inputter)).sort());
}

function renderSumTable(tableId, mp){
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';
  const items = [...mp.entries()].sort((a,b)=>b[1]-a[1]);
  if(!items.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="2" class="muted">No data (after filter)</td>`;
    tbody.appendChild(tr);
    return;
  }
  items.forEach(([cat, total])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${cat}</td><td class="num">${fmt(total)}</td>`;
    tbody.appendChild(tr);
  });
}

function generateSummary(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? htmlRows : txtRows;
  const boxId = isHtml ? 'htmlSumInputters' : 'txtSumInputters';
  const selected = getCheckedSet(boxId);

  const dr = new Map();
  const cr = new Map();
  let drTotal = 0, crTotal = 0;

  rows.forEach(r=>{
    if(selected.size && !selected.has(r.inputter)) return;
    const drCat = r.dr_cat || '(Blank)';
    const crCat = r.cr_cat || '(Blank)';
    if (isFinite(r.debit_amt) && r.debit_amt !== 0){
      dr.set(drCat, (dr.get(drCat) || 0) + r.debit_amt);
      drTotal += r.debit_amt;
    }
    if (isFinite(r.credit_amt) && r.credit_amt !== 0){
      cr.set(crCat, (cr.get(crCat) || 0) + r.credit_amt);
      crTotal += r.credit_amt;
    }
  });

  if(isHtml){
    htmlSummaryRows = rows.filter(r=>!selected.size || selected.has(r.inputter));
    renderSumTable('htmlSumDrTable', dr);
    renderSumTable('htmlSumCrTable', cr);
    document.getElementById('htmlSumDrTotal').textContent = fmt(drTotal);
    document.getElementById('htmlSumCrTotal').textContent = fmt(crTotal);
    document.getElementById('htmlSumDiff').textContent = fmt(drTotal - crTotal);
    htmlSummaryTotals = {drTotal, crTotal};
    updateCrossDiffUI();
  } else {
    txtSummaryRows = rows.filter(r=>!selected.size || selected.has(r.inputter));
    renderSumTable('txtSumDrTable', dr);
    renderSumTable('txtSumCrTable', cr);
    document.getElementById('txtSumDrTotal').textContent = fmt(drTotal);
    document.getElementById('txtSumCrTotal').textContent = fmt(crTotal);
    document.getElementById('txtSumDiff').textContent = fmt(drTotal - crTotal);
    txtSummaryTotals = {drTotal, crTotal};
    updateCrossDiffUI();
  }
}

function downloadSummaryCSV(side){
  const isHtml = (side === 'html');
  const rows = isHtml ? htmlSummaryRows : txtSummaryRows;
  const cols = isHtml ? ((document.getElementById('htmlCompact')?.checked) ? HTML_COLS_COMPACT : HTML_COLS)
                      : ((document.getElementById('txtCompact')?.checked) ? TXT_COLS_COMPACT : TXT_COLS);
  const filename = isHtml ? 'HTML_summary_filtered_rows.csv' : 'TXT_summary_filtered_rows.csv';

  const esc = (s) => {
    const t = String(s ?? '');
    if (/[",\n]/.test(t)) return '"' + t.replace(/"/g,'""') + '"';
    return t;
  };

  const lines = [];
  lines.push(cols.map(c=>esc(c.label)).join(','));
  rows.forEach(r=>{
    lines.push(cols.map(c=>{
      const v = r[c.k];
      return esc((typeof v === 'number' && isFinite(v)) ? v : (v ?? ''));
    }).join(','));
  });

  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


/* -------------------- PDF Preview (Browser Print) -------------------- */
function printSection(id){
  const el = document.getElementById(id);
  if(!el){ alert('Section not found'); return; }

  // Create/clear print area
  let pa = document.getElementById('printArea');
  if(!pa){
    pa = document.createElement('div');
    pa.id = 'printArea';
    document.body.appendChild(pa);
  }
  pa.innerHTML = '';
  const clone = el.cloneNode(true);

  // Remove UI-only buttons inside clone
  clone.querySelectorAll('.no-print').forEach(n=>n.remove());

  // Ensure tables expand in print
  clone.querySelectorAll('.scrollTable').forEach(n=>{
    n.style.maxHeight = 'none';
    n.style.overflow = 'visible';
    n.style.border = 'none';
  });
  clone.querySelectorAll('.list').forEach(n=>{
    n.style.maxHeight = 'none';
    n.style.overflow = 'visible';
  });

  pa.appendChild(clone);

  // Toggle print mode
  document.body.classList.add('printing');
  setTimeout(()=>{
    window.print();
    setTimeout(()=>{
      document.body.classList.remove('printing');
      pa.innerHTML = '';
    }, 300);
  }, 50);
}

/* -------------------- Cross-file Summary Differences -------------------- */
let htmlSummaryTotals = {drTotal:0, crTotal:0};
let txtSummaryTotals  = {drTotal:0, crTotal:0};


function updateOnePageSummary(htmlRefs, txtRefs){
  const b = document.getElementById('sumBank');
  const br = document.getElementById('sumBranch');
  const d = document.getElementById('sumDate');
  if(b) b.textContent = htmlMeta.bank || '‚Äî';
  if(br) br.textContent = htmlMeta.branch || '‚Äî';
  if(d) d.textContent = htmlMeta.date || '‚Äî';
  const hR = document.getElementById('sumHtmlRefs'); if(hR) hR.textContent = String(htmlRefs ?? 0);
  const tR = document.getElementById('sumTxtRefs'); if(tR) tR.textContent = String(txtRefs ?? 0);
  const m1 = document.getElementById('sumMissInTxt'); if(m1) m1.textContent = String(missingHtmlAll.length);
  const m2 = document.getElementById('sumMissInHtml'); if(m2) m2.textContent = String(missingTxtAll.length);
}

function updateCrossDiffUI(){
  const debitDelta = (htmlSummaryTotals.drTotal - txtSummaryTotals.drTotal);
  const creditDelta = (htmlSummaryTotals.crTotal - txtSummaryTotals.crTotal);

  const kDebit = document.getElementById('kpiDebitDelta');
  const kCredit = document.getElementById('kpiCreditDelta');
  const sDebit = document.getElementById('sumDebitDelta');
  const sCredit = document.getElementById('sumCreditDelta');

  if(kDebit) kDebit.textContent = fmt(debitDelta);
  if(kCredit) kCredit.textContent = fmt(creditDelta);
  if(sDebit) sDebit.textContent = fmt(debitDelta);
  if(sCredit) sCredit.textContent = fmt(creditDelta);
}

/* main */
async function loadAll(){
  const hf = document.getElementById('htmlFile').files[0];
  const tf = document.getElementById('txtFile').files[0];
  if(!hf || !tf){ alert('‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá HTML ‡¶è‡¶¨‡¶Ç TXT‚Äî‡¶¶‡ßÅ‡¶á‡¶ü‡¶æ ‡¶´‡¶æ‡¶á‡¶≤‡¶á ‡¶¶‡¶ø‡¶®'); return; }

  setStatus('Loading...');
  debug('');

  htmlRows = []; txtRows = [];
  missingHtmlAll = []; missingTxtAll = [];
  missingHtmlFiltered = []; missingTxtFiltered = [];

  try {
    const [hText, tText] = await Promise.all([readFile(hf), readFile(tf)]);
    validateHtmlContent(hText);
    validateTxtContent(tText);
    setSummaryStatic(hf, tf);
    const h = parseHTML(hText);
    const t = parseTXTFixedWidth(tText);

  htmlRows = h.rows;
  txtRows = t.rows;
  if(h.meta){ htmlMeta = h.meta; }
  updateOnePageSummary(h.refCount, t.refCount);

  const msg = [
    `HTML parsed rows: ${htmlRows.length} | unique FT refs: ${h.refCount} | note: ${h.note}`,
    `TXT parsed rows:  ${txtRows.length} | unique FT refs: ${t.refCount} | note: ${t.note}`,
  ];

  const warn = [];
  if(h.refCount === 0) warn.push("‚ö†Ô∏è HTML ‡¶•‡ßá‡¶ï‡ßá FT ref ‡¶™‡ßú‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø (0). ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ HTML ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü/‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
  if(t.refCount === 0) warn.push("‚ö†Ô∏è TXT ‡¶•‡ßá‡¶ï‡ßá FT ref ‡¶™‡ßú‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø (0). TXT report header/spacing ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§");

  debug(msg.join('\n') + (warn.length ? ("\n\n" + warn.join('\n')) : ''));

  computeMissing();
    computeDiagnostics();
    updateOnePageCounts(h.refCount, t.refCount);

  updateOnePageSummary(h.refCount, t.refCount);
  buildSummaryInputterLists();
  generateSummary('html');
  generateSummary('txt');

  // KPI updates
  document.getElementById('kpiHtmlRows').textContent = String(htmlRows.length);
  document.getElementById('kpiHtmlRefs').textContent = String(h.refCount);
  document.getElementById('kpiTxtRows').textContent = String(txtRows.length);
  document.getElementById('kpiTxtRefs').textContent = String(t.refCount);
  document.getElementById('kpiHtmlMissing').textContent = String(missingHtmlAll.length);
  document.getElementById('kpiTxtMissing').textContent = String(missingTxtAll.length);
  updateCrossDiffUI();


  // KPI updates
  document.getElementById('kpiHtmlRows').textContent = String(htmlRows.length);
  document.getElementById('kpiHtmlRefs').textContent = String(h.refCount);
  document.getElementById('kpiTxtRows').textContent = String(txtRows.length);
  document.getElementById('kpiTxtRefs').textContent = String(t.refCount);
  document.getElementById('kpiHtmlMissing').textContent = String(missingHtmlAll.length);
  document.getElementById('kpiTxtMissing').textContent = String(missingTxtAll.length);

  setStatus('Done');
  } catch(e) {
    console.error(e);
    setStatus('Error');
    debug('ERROR: ' + (e && e.message ? e.message : String(e)) + '\n' + (e && e.stack ? e.stack : ''));
    alert('‡¶≤‡ßã‡¶°/‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ Debug ‡¶Ö‡¶Ç‡¶∂‡ßá Error ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§');
  }
}

function showCredit(){
  const o = document.getElementById('creditOverlay');
  if(o) o.style.display = 'flex';
}
function hideCredit(){
  const o = document.getElementById('creditOverlay');
  if(o) o.style.display = 'none';
}
document.addEventListener('DOMContentLoaded', ()=>{
  // show small credit popup once per browser session
  try{
    if(!sessionStorage.getItem('transferToolCreditShown')){
      showCredit();
      sessionStorage.setItem('transferToolCreditShown','1');
    }
  }catch(e){ showCredit(); }
});


// -------------------- v13: validations + diagnostics + one-page print --------------------
let amountMismatch = [];
let dupHtmlRefs = [];
let dupTxtRefs = [];
let blankRefCount = 0;

function makeAuditRef(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `ABTL-TR-${y}${m}${da}-${hh}${mm}`;
}

function setSummaryStatic(hf, tf){
  const gen = new Date();
  const genStr = gen.toLocaleString();
  const el = (id, v)=>{ const x=document.getElementById(id); if(x) x.textContent = v; };

  el('sumGeneratedAt', genStr);
  el('sumAuditRef', makeAuditRef());
  el('sumHtmlFile', hf?.name || '‚Äî');
  el('sumTxtFile', tf?.name || '‚Äî');

  // Bank/branch from meta (HTML best-effort), fallback to fixed
  const bank = (htmlMeta && htmlMeta.bank) ? htmlMeta.bank : 'AGRANI BANK PLC';
  const branch = (htmlMeta && htmlMeta.branch) ? htmlMeta.branch : 'JAMALPUR BRANCH';
  el('sumBankTitle', bank);
  el('sumBranchTitle', branch);
}

function validateHtmlContent(text){
  const t = (text || '').toLowerCase();
  const okTable = t.includes('<table');
  const okHint = t.includes('daily transfer') || t.includes('transfer register') || t.includes('trreg') || t.includes('daily transfer register');
  if(!okTable) throw new Error('Invalid HTML: ‡¶ï‡ßã‡¶® ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ (<table>) ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ ‡¶≠‡ßÅ‡¶≤ HTML ‡¶´‡¶æ‡¶á‡¶≤‡•§');
  if(!okHint) {
    // not fatal, but warn
    debug((document.getElementById('debugBox')?.textContent || '') + '\n‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: HTML ‡¶´‡¶æ‡¶á‡¶≤‡ßá "Transfer Register" ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶∏‡¶ø‡¶ó‡¶®‡ßá‡¶ö‡¶æ‡¶∞ ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶®‡ßü‡•§ ‡¶§‡¶¨‡ßÅ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§');
  }
  return true;
}

function validateTxtContent(text){
  const t = (text || '').toLowerCase();
  const hasTrreg = t.includes('trreg') || t.includes('cob') || t.includes('results') || t.includes('selection');
  const hasFT = /ft\d{6,}/i.test(text || '');
  if(!hasFT) throw new Error('Invalid TXT: TXT ‡¶´‡¶æ‡¶á‡¶≤‡ßá FT reference pattern (FTxxxxxx) ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ ‡¶≠‡ßÅ‡¶≤ TXT ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡•§');
  if(!hasTrreg){
    debug((document.getElementById('debugBox')?.textContent || '') + '\n‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: TXT ‡¶´‡¶æ‡¶á‡¶≤‡ßá expected header hint (TRREG/COB) ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶®‡ßü‡•§ ‡¶§‡¶¨‡ßÅ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§');
  }
  return true;
}

function countDuplicates(rows){
  const m = new Map();
  for(const r of rows){
    const ref = r.ref;
    if(!ref) continue;
    m.set(ref, (m.get(ref)||0)+1);
  }
  const dups = [];
  for(const [k,v] of m.entries()){
    if(v>1) dups.push({ref:k, count:v});
  }
  return dups.sort((a,b)=>b.count-a.count);
}

function computeDiagnostics(){
  // blank refs across both (for quality)
  const allRefs = [...htmlRows, ...txtRows].map(r=>r.ref).filter(r=>!r || String(r).trim()==='' );
  blankRefCount = allRefs.length;

  dupHtmlRefs = countDuplicates(htmlRows);
  dupTxtRefs  = countDuplicates(txtRows);

  // amount mismatch by ref (compare debit amount primarily; fallback credit)
  const hMap = new Map();
  for(const r of htmlRows){ if(r.ref && !hMap.has(r.ref)) hMap.set(r.ref, r); }
  const tMap = new Map();
  for(const r of txtRows){ if(r.ref && !tMap.has(r.ref)) tMap.set(r.ref, r); }

  amountMismatch = [];
  for(const [ref, hr] of hMap.entries()){
    if(!tMap.has(ref)) continue;
    const tr = tMap.get(ref);

    const hAmt = isFinite(toNum(hr.dr_amt)) ? toNum(hr.dr_amt) : toNum(hr.cr_amt);
    const tAmt = isFinite(toNum(tr.dr_amt)) ? toNum(tr.dr_amt) : toNum(tr.cr_amt);

    if(isFinite(hAmt) && isFinite(tAmt)){
      if(Math.abs(hAmt - tAmt) > 0.0001){
        amountMismatch.push({ref, html_amt:hAmt, txt_amt:tAmt, inputter: hr.inputter || tr.inputter || ''});
      }
    }
  }
}

function updateOnePageCounts(htmlRefs, txtRefs){
  const el = (id,v)=>{ const x=document.getElementById(id); if(x) x.textContent = String(v); };

  el('sumHtmlRefs', htmlRefs ?? 0);
  el('sumTxtRefs',  txtRefs ?? 0);
  el('sumMissInTxt', missingHtmlAll.length);
  el('sumMissInHtml', missingTxtAll.length);
  el('sumAmtMismatch', amountMismatch.length);
  el('sumDupHtml', dupHtmlRefs.length);
  el('sumDupTxt', dupTxtRefs.length);
  el('sumBlankRefs', blankRefCount);

  // --- Additional professional summary stats ---
  const sumField = (rows, field)=>{
    let s = 0;
    for(const r of (rows||[])){
      const v = toNum(r[field]);
      if(isFinite(v)) s += v;
    }
    return s;
  };
  const fmtMoney = (n)=>{
    if(!isFinite(n)) return '0.00';
    try{
      return n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }catch(e){
      return (Math.round(n*100)/100).toFixed(2);
    }
  };

  // Totals per file
  const htmlDebitTotal  = sumField(htmlRows, 'dr_amt');
  const htmlCreditTotal = sumField(htmlRows, 'cr_amt');
  const txtDebitTotal   = sumField(txtRows,  'dr_amt');
  const txtCreditTotal  = sumField(txtRows,  'cr_amt');

  el('sumHtmlDebitTotal',  fmtMoney(htmlDebitTotal));
  el('sumHtmlCreditTotal', fmtMoney(htmlCreditTotal));
  el('sumTxtDebitTotal',   fmtMoney(txtDebitTotal));
  el('sumTxtCreditTotal',  fmtMoney(txtCreditTotal));

  // Inputter breakdown (Count + Sum of Amount; use Debit amount primarily, else Credit)
  const inputterStats = (rows)=>{
    const m = new Map();
    for(const r of (rows||[])){
      const name = (r.inputter || '‚Äî').toString().trim() || '‚Äî';
      const amt = isFinite(toNum(r.dr_amt)) ? toNum(r.dr_amt) : toNum(r.cr_amt);
      const cur = m.get(name) || {inputter:name, count:0, total:0};
      cur.count += 1;
      if(isFinite(amt)) cur.total += amt;
      m.set(name, cur);
    }
    return Array.from(m.values()).sort((a,b)=> (b.total - a.total) || (b.count - a.count) || a.inputter.localeCompare(b.inputter));
  };

  const renderInputterTable = (stats, targetId)=>{
    const box = document.getElementById(targetId);
    if(!box) return;
    if(!stats || !stats.length){ box.innerHTML = '<span class="muted">‚Äî</span>'; return; }
    const top = stats.slice(0, 10);
    let h = '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
    h += '<thead><tr>';
    h += '<th style="border:1px solid #ddd; padding:4px 6px; text-align:left;">Inputter</th>';
    h += '<th style="border:1px solid #ddd; padding:4px 6px; text-align:right;">Tx</th>';
    h += '<th style="border:1px solid #ddd; padding:4px 6px; text-align:right;">Total</th>';
    h += '</tr></thead><tbody>';
    for(const r of top){
      h += `<tr>
        <td style="border:1px solid #ddd; padding:4px 6px;">${(r.inputter||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}</td>
        <td style="border:1px solid #ddd; padding:4px 6px; text-align:right;">${r.count}</td>
        <td style="border:1px solid #ddd; padding:4px 6px; text-align:right;">${fmtMoney(r.total)}</td>
      </tr>`;
    }
    h += '</tbody></table>';
    if(stats.length > top.length){
      h += `<div class="muted" style="margin-top:4px; font-size:11px;">Showing top ${top.length} of ${stats.length} inputters</div>`;
    }
    box.innerHTML = h;
  };

  renderInputterTable(inputterStats(htmlRows), 'sumHtmlInputterTable');
  renderInputterTable(inputterStats(txtRows),  'sumTxtInputterTable');

  // Largest transactions (max debit / max credit) across both files
  const pickMax = (rows, field)=> {
    let best = null;
    for(const r of (rows||[])){
      const v = toNum(r[field]);
      if(!isFinite(v)) continue;
      if(!best || v > best.amt){
        best = {amt:v, ref:r.ref || '‚Äî', inputter:r.inputter || '‚Äî'};
      }
    }
    return best;
  };

  const maxHtmlDebit  = pickMax(htmlRows, 'dr_amt');
  const maxTxtDebit   = pickMax(txtRows,  'dr_amt');
  const maxHtmlCredit = pickMax(htmlRows, 'cr_amt');
  const maxTxtCredit  = pickMax(txtRows,  'cr_amt');

  const choose = (a, b)=>{
    if(!a && !b) return null;
    if(a && !b) return {src:'HTML', ...a};
    if(!a && b) return {src:'TXT', ...b};
    return (a.amt >= b.amt) ? {src:'HTML', ...a} : {src:'TXT', ...b};
  };

  const bestDebit  = choose(maxHtmlDebit,  maxTxtDebit);
  const bestCredit = choose(maxHtmlCredit, maxTxtCredit);

  el('sumMaxDebitAmt',   bestDebit ? fmtMoney(bestDebit.amt) : '0.00');
  el('sumMaxDebitRef',   bestDebit ? bestDebit.ref : '‚Äî');
  el('sumMaxDebitSrc',   bestDebit ? bestDebit.src : '‚Äî');

  el('sumMaxCreditAmt',  bestCredit ? fmtMoney(bestCredit.amt) : '0.00');
  el('sumMaxCreditRef',  bestCredit ? bestCredit.ref : '‚Äî');
  el('sumMaxCreditSrc',  bestCredit ? bestCredit.src : '‚Äî');

  const matched = Math.max(0, Math.min(htmlRefs||0, txtRefs||0) - (missingHtmlAll.length + missingTxtAll.length));
  el('sumMatched', matched);

  // Observation text
  const obs = document.getElementById('sumObservation');
  if(obs){
    const totalFindings = missingHtmlAll.length + missingTxtAll.length + amountMismatch.length;
    if(totalFindings === 0){
      obs.textContent = 'No discrepancy found between registers. (No missing FT refs, no amount mismatch)';
    } else {
      const parts = [];
      if(missingHtmlAll.length) parts.push(`HTML Missing in TXT: ${missingHtmlAll.length}`);
      if(missingTxtAll.length)  parts.push(`TXT Missing in HTML: ${missingTxtAll.length}`);
      if(amountMismatch.length) parts.push(`Amount mismatch: ${amountMismatch.length}`);
      obs.textContent = 'Difference found between Before COB and After COB registers. Manual review required. ' + parts.join(' | ');
    }
  }

  // date in summary: best-effort from meta; fallback today
  const d = document.getElementById('sumDate');
  if(d){
    d.textContent = (htmlMeta && htmlMeta.date) ? htmlMeta.date : new Date().toLocaleDateString();
  }
}

function printSummaryPage(){
  printSection('summaryPageOnly');
}

function downloadFindingsCSV(){
  // Combine key findings into one CSV
  const rows = [];
  const push = (type, r)=>rows.push({
    Finding: type,
    FT_Ref: r.ref || '',
    Debit_Amt: r.dr_amt ?? '',
    Credit_Amt: r.cr_amt ?? '',
    Inputter: r.inputter ?? '',
    Dr_Category: r.dr_cat ?? '',
    Cr_Category: r.cr_cat ?? '',
    Note: r.note ?? ''
  });

  missingHtmlAll.forEach(r=>push('HTML missing in TXT', r));
  missingTxtAll.forEach(r=>push('TXT missing in HTML', r));
  amountMismatch.forEach(r=>rows.push({
    Finding:'Amount mismatch',
    FT_Ref:r.ref,
    Debit_Amt:r.html_amt,
    Credit_Amt:r.txt_amt,
    Inputter:r.inputter,
    Dr_Category:'',
    Cr_Category:'',
    Note:'HTML vs TXT amount differs'
  }));

  if(!rows.length){ alert('No findings to export.'); return; }
  downloadCSV('transfer_audit_findings.csv', rows);
}

// remember compact view (professional touch)
function rememberToggle(id){
  try{
    const el = document.getElementById(id);
    if(!el) return;
    const key = 'tr_audit_' + id;
    el.checked = (localStorage.getItem(key) === '1');
    el.addEventListener('change', ()=> localStorage.setItem(key, el.checked ? '1' : '0'));
  }catch(e){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  rememberToggle('htmlCompact');
  rememberToggle('txtCompact');

  // disable Load button until both files present
  const btn = document.getElementById('loadBtn');
  const hf = document.getElementById('htmlFile');
  const tf = document.getElementById('txtFile');
  const refresh = ()=>{
    if(!btn) return;
    btn.disabled = !(hf?.files?.length && tf?.files?.length);
  };
  hf?.addEventListener('change', refresh);
  tf?.addEventListener('change', refresh);
  refresh();
});

</script>
</body>
</html>
