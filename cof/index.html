<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X4YNW0E3XG"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-X4YNW0E3XG');
  </script>
  <title>Cost of Fund (COF) Calculation ‚Äì Online v6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Required libraries (must be in same folder) -->
  <script src="papaparse.min.js"></script>
  <script src="html2pdf.bundle.min.js"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3608304969182163"
     crossorigin="anonymous"></script>
  <style>
    :root{
      --bg:#f5f7fb;--card:#fff;--accent:#2563eb;--border:#e5e7eb;--muted:#6b7280;--danger:#b91c1c
    }
    *{box-sizing:border-box;font-family:system-ui,sans-serif}
    body{margin:0;background:var(--bg);color:#111827}
    .container{max-width:1100px;margin:auto;padding:16px 16px 64px}
    h1{text-align:center;font-size:1.6rem;margin:0.25rem 0 0.75rem}
    h2{font-size:1.2rem;margin:.8rem 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:12px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
    .card-header{font-weight:600;margin-bottom:6px}
    label{font-size:.85rem;color:var(--muted)}
    .small-text{font-size:.75rem;color:var(--muted)}
    .error{color:var(--danger);font-size:.85rem;margin-top:6px}
    input,select{width:100%;padding:6px 8px;border-radius:8px;border:1px solid var(--border)}
    input[disabled]{background:#f3f4f6;color:#4b5563}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .btn{padding:8px 16px;border-radius:999px;border:none;background:var(--accent);color:#fff;cursor:pointer;margin-top:8px;margin-right:6px}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid var(--border)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;font-size:.8rem}
    th,td{border:1px solid var(--border);padding:4px;vertical-align:top}
    th{background:#f3f4f6}
    .scroll-table{max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:8px;background:#fff}
    .summary-bold{font-weight:700;background:#f9fafb}

    /* injected rows */
    .injected-row{background:#fff7ed;font-weight:700}
    .injected-row td{border-color:#fdba74}

    /* Professional header (PDF & preview) */
    #reportHeader{text-align:center;margin:0 0 8px;padding:4px 0 6px;border-bottom:1px solid #d1d5db}
    #reportHeader .hdr-bank{font-size:18px;font-weight:700}
    #reportHeader .hdr-branch{font-size:14px;font-weight:600}
    #reportHeader .hdr-title{font-size:14px;font-weight:700;color:#2563eb;margin-top:2px}
    #reportHeader .hdr-meta{font-size:11px;color:#4b5563;margin-top:2px}

    @media print{
      .no-print{display:none!important}
      body{background:#fff}
      .card{box-shadow:none}
    }
    /* ===============================
   TOPBAR + CONTENT UI (NSS STYLE)
=============================== */

.container{
  max-width:1000px;
  margin:auto;
  padding:20px;
}

.topbar{
  background:#fff;
  border:1px solid rgba(0,0,0,.08);
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  border-radius:14px;
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  position:sticky;
  top:10px;
  z-index:9999;
}

.brand h1{
  margin:0;
  font-size:18px;
  font-weight:800;
  color:#1a2b4c;
}

.brand p{
  margin:0;
  font-size:13px;
  color:#64748b;
}

.btn{
  border:1px solid rgba(0,0,0,.12);
  background:transparent;
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
  font-weight:800;
  font-size:14px;
  text-decoration:none;
  color:#1a2b4c;
  display:inline-block;
}
.btn:hover{opacity:.9}

/* ‚úÖ Optional ad placeholder box */
.ad-box{
  margin-top:18px;
  background:#fff;
  border:1px dashed rgba(0,0,0,.15);
  border-radius:14px;
  padding:10px;
}

/* ‚úÖ Card Blocks */
.card{
  background:#fff;
  padding:18px;
  border-radius:14px;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  margin-top:18px;
  border:1px solid rgba(0,0,0,.08);
}

.card h3{
  margin:0 0 12px;
  font-size:18px;
  font-weight:800;
  color:#1a2b4c;
  border-left:4px solid #2563eb;
  padding-left:10px;
}

/* ‚úÖ Accordion Expandable */
details{
  border:1px solid rgba(0,0,0,.08);
  border-radius:12px;
  margin-bottom:12px;
  background:#fff;
  overflow:hidden;
}

summary{
  cursor:pointer;
  padding:12px 14px;
  font-weight:800;
  color:#1a2b4c;
  list-style:none;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

summary::-webkit-details-marker{display:none;}

summary span{
  color:#2563eb;
  font-size:18px;
  font-weight:900;
  transition:.2s;
}

details[open] summary span{
  transform:rotate(45deg);
}

.acc-body{
  padding:14px;
  border-top:1px solid rgba(0,0,0,.08);
  color:#334155;
  font-size:14px;
  line-height:1.7;
}

.acc-body ul{
  margin:8px 0 0;
  padding-left:18px;
}
.acc-body li{
  margin-bottom:8px;
}

/* ‚úÖ Footer Trust Section */
.footer{
  margin-top:25px;
  text-align:center;
  color:#64748b;
  font-size:13px;
  line-height:1.8;
  padding:18px 10px;
  border-top:1px solid rgba(0,0,0,.08);
}

.footer a{
  color:#2563eb;
  text-decoration:none;
  font-weight:700;
}

.footer a:hover{
  text-decoration:underline;
}

/* ‚úÖ Responsive */
@media(max-width:768px){
  .topbar{
    flex-direction:column;
    align-items:flex-start;
  }
}

  </style>
</head>
<body>
<div class="container">
  <!-- Top Bar -->
  <div class="topbar">
    <div class="brand">
      <h1>Cost of Fund (COF) Calculation ‚Äì Online </h1>
      <p>Agrani Bank PLC + Bangladesh Bank (BB) ‚Äì Practical Reference</p>
    </div>
    <div>
      <a class="btn" href="../index.html">&larr; Main Site</a>
      <a class="btn" href="interest-waiver-circulars.html">&larr; Circular Summary</a>
    </div>
  </div>
  <!-- ADS placeholder -->
  <div class="ad-box">
    <!-- Insert AdSense ad unit here later if needed -->
    <small style="color:#64748b;">Ad Placeholder (optional)</small>
  </div>

  <!-- Agrani Bank Summary -->
  <div class="card">
    <h3>Agrani Bank PLC ‚Äì Internal Practice Summary</h3>

    <details>
      <summary>‚úÖ When waiver/reduction is usually considered <span>+</span></summary>
      <div class="acc-body">
        <ul>
          <li>To recover principal from long overdue / classified loans</li>
          <li>To settle cases where borrower is paying but cannot bear full penal interest</li>
          <li>To close legal cases or reduce litigation cost</li>
          <li>For realistic adjustment of loan liability for negotiation or compromise settlement</li>
        </ul>
      </div>
    </details>

    <details>
      <summary>üìå Common internal conditions used in waiver proposals <span>+</span></summary>
      <div class="acc-body">
        <ul>
          <li>Borrower must pay minimum principal portion before waiver approval</li>
          <li>Waiver is normally applied only for classified period interest (not always for regular period)</li>
          <li>Waiver is linked with settlement schedule and borrower ability</li>
          <li>Approval authority depends on amount and classification category</li>
        </ul>
      </div>
    </details>

    <details>
      <summary>üìÑ Waiver proposal structure (typical format) <span>+</span></summary>
      <div class="acc-body">
        <ul>
          <li>Loan liability breakdown (principal + interest + charges)</li>
          <li>Recovery position (deposit, cash, collateral, security value)</li>
          <li>Cost of Fund (COF) calculation and justification</li>
          <li>Borrower commitment letter / settlement agreement</li>
          <li>Credit risk notes + legal status</li>
        </ul>
      </div>
    </details>
  </div>

  <!-- 1. Upload CSV -->
  <div class="card no-print">
    <div class="card-header">1. Upload Statement (.CSV)</div>
    <input type="file" id="csvFile" accept=".csv">
    <div id="fileError" class="error"></div>
    <div class="small-text" style="margin-top:6px">
      Download <b>#.csv</b> file from <b>T24</b> software and upload it here.
    </div>
    <div class="small-text" style="margin-top:6px">
      Every column and row of the CSB file is important here. So no column or row can be omitted or changed. Then the calculation will be wrong or the report will show wrong. If there is any mistake in the CSB file, change it efficiently or fix it from <b>T24</b> software and upload it. 
    </div>
  </div>

  <!-- 2. Account Info -->
  <div class="card no-print" id="infoCard">
    <div class="card-header">2. Account Information</div>
    <div class="grid">
      <div><label>Bank</label><input id="bankName" disabled></div>
      <div><label>Branch</label><input id="branchName" disabled></div>
      <div><label>Customer</label><input id="customerName" disabled></div>
      <div><label>Account Number / Contract ID</label><input id="accountNumber" disabled></div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div><label>Loan Limit</label><input id="loanLimit" disabled></div>
      <div><label>Opening Balance</label><input id="openingBalance" disabled></div>
      <div><label>Sanction Date</label><input id="sanctionDate" type="date" disabled></div>
      <div><label>Expiry Date</label><input id="expiryDate" type="date" disabled></div>
    </div>
  </div>

  <!-- 3. Classification & Rates -->
  <div class="card no-print" id="rateCard">
    <div class="card-header">3. Classification / Reporting & Rates</div>
    <div class="grid">
      <div>
        <label>Classification Date</label>
        <div class="small-text">First date of classification start or Last Date of SMA</div>
        <input id="classificationDate" type="date">
      </div>
      <div><label>Reporting Date</label><input id="reportingDate" type="date"></div>
      <div><label>General Rate (%)</label><input id="generalRate" type="number" step="0.01" value="13.40"></div>
      <div><label>Special Rate (%)</label><input id="specialRate" type="number" step="0.01" value="7.50"></div>
    </div>

    <button class="btn secondary" id="processBtn" disabled>Process Statement</button>
    <div id="processError" class="error"></div>
  </div>

  <!-- 4. Statement Mapping -->
  <div class="card no-print" id="mappingCard" style="display:none">
    <div class="card-header">4. Transaction Statement & Category Mapping</div>
    <div class="small-text" style="margin-bottom:6px">
      Columns ‚ÄúTransaction Rf - Br‚Äù and ‚ÄúDr/Cr‚Äù are hidden (if present). Injected Expiry/Classification rows are highlighted.
    </div>
    <div class="scroll-table">
      <table>
        <thead id="txHeader"></thead>
        <tbody id="txBody"></tbody>
      </table>
    </div>
  </div>

  <!-- 5. Actions -->
  <div class="card no-print">
    <div class="card-header">5. Calculate & Export</div>
    <button class="btn" id="calcBtn" disabled>Calculate & Preview</button>
    <button class="btn secondary" id="previewBtn">Preview Summary</button>
    <button class="btn secondary" onclick="window.print()">Print Summary</button>
    <button class="btn secondary" id="pdfBtnMain">Download Summary PDF</button>
    <button class="btn secondary" id="pdfBtnSpecial">Download Special Interest Sheet PDF</button>
    <button class="btn secondary" id="pdfBtnStatement">Download Transaction Statement PDF</button>
    <button class="btn secondary" id="downloadCsvBtn">Download Classified CSV</button>
    <div id="calcError" class="error"></div>
  </div>

  <!-- 6. Results -->
  <div class="card" id="resultsCard" style="display:none">
    <div id="reportHeader">
      <div class="hdr-bank" id="hBank"></div>
      <div class="hdr-branch" id="hBranch"></div>
      <div class="hdr-title">Cost of Fund (COF) Summary Report</div>
      <div class="hdr-meta">
        Customer: <span id="hCustomer"></span> | Account: <span id="hAcc"></span><br>
        Classification Date: <span id="hClassDate"></span> | Reporting Date: <span id="hReportDate"></span>
      </div>
    </div>

    <h2>Summary</h2>
    <table id="summaryTable"><thead><tr><th>SL</th><th>Title</th><th>Amount</th></tr></thead><tbody></tbody></table>

    <h2>Details</h2>
    <div id="details"></div>

    <div style="margin-top:20px;font-size:12px">
      <hr>
      <div>Date &amp; Time: <span id="sigDate"></span></div>
      <div style="margin-top:40px;font-weight:600">______________________________</div>
      <div style="font-weight:600">Authorized Officer</div>
    </div>
  </div>
<div style="margin-top:10px;font-size:12px;color:#94a3b8;">
This tool is for calculation support only. Always follow official Agrani Bank PLC & Bangladesh Bank circulars.
</div>

<!-- ‚úÖ Footer (AdSense trust) -->
  <div class="footer">
    <a href="/privacy-policy.html">Privacy Policy</a> |
    <a href="/terms.html">Terms</a> |
    <a href="/cookie-policy.html">Cookie Policy</a> |
    <a href="/disclaimer.html">Disclaimer</a> |
    <a href="/contact.html">Contact</a>
    <div style="margin-top:6px;">¬© 2026 Abdul Latif ‚Äî All Rights Reserved.</div>
  </div>
</div>

<!-- Special Interest Sheet Template -->
<template id="specialInterestTemplate">
  <div id="specialInterestContainer" style="font-size:12px;padding:10px">
    <div style="text-align:center;margin-bottom:10px">
      <div style="font-size:16px;font-weight:700" class="si-bank"></div>
      <div style="font-size:13px;font-weight:600" class="si-branch"></div>
      <div style="margin-top:2px">Customer: <span class="si-customer"></span></div>
      <div style="margin-top:2px">Account: <span class="si-account"></span></div>
      <div style="margin-top:6px;font-size:13px;font-weight:700;color:#2563eb" class="si-title">Special Interest (Diminishing Principal Method)</div>
      <div style="margin-top:2px;font-size:11px;color:#4b5563" class="si-meta">
        Classification Date: <span class="si-class-date"></span> | Reporting Date: <span class="si-report-date"></span>
      </div>
      <div style="margin-top:2px;font-size:11px;color:#4b5563">Starting Principal (Expiry Principal): <span class="si-start"></span></div>
      <hr style="margin-top:6px">
    </div>

    <table style="width:100%;border-collapse:collapse;font-size:11px">
      <thead>
        <tr>
          <th style="border:1px solid #d1d5db;padding:3px 4px;background:#f3f4f6;width:18%">Date (From ‚Üí To)</th>
          <th style="border:1px solid #d1d5db;padding:3px 4px;background:#f3f4f6;width:22%">Narration</th>
          <th style="border:1px solid #d1d5db;padding:3px 4px;background:#f3f4f6;width:13%">Deposit</th>
          <th style="border:1px solid #d1d5db;padding:3px 4px;background:#f3f4f6;width:17%">Principal (Tk.)</th>
          <th style="border:1px solid #d1d5db;padding:3px 4px;background:#f3f4f6;width:8%">Days</th>
          <th style="border:1px solid #d1d5db;padding:3px 4px;background:#f3f4f6;width:22%">(Principal √ó Days √ó Rate) / 360</th>
        </tr>
      </thead>
      <tbody class="si-body"></tbody>
      <tfoot>
        <tr>
          <th colspan="5" style="border:1px solid #d1d5db;padding:3px 4px;text-align:right">Total Special Interest</th>
          <th style="border:1px solid #d1d5db;padding:3px 4px;text-align:right" class="si-total"></th>
        </tr>
      </tfoot>
    </table>

    <div style="margin-top:8px;font-size:11px">
      Interest Rate (Special): <span class="si-rate"></span>% per annum, calculated on 360-day year basis.
    </div>

    <div style="margin-top:20px;font-size:11px">
      <div>Date &amp; Time: <span class="si-generated-at"></span></div>
      <div style="margin-top:30px;font-weight:600">______________________________</div>
      <div style="font-weight:600">Authorized Officer</div>
    </div>
  </div>
</template>
<script>
// ================= STRICT CSV LOADER =================
async function parseFileToRows(file){
  if(!window.Papa || typeof window.Papa.parse !== 'function'){
    throw new Error('papaparse.min.js not found. Keep it in same folder as this HTML.');
  }
  return new Promise((res,rej)=>Papa.parse(file,{complete:r=>res(r.data||[]),error:rej}));
}

// ================= CORE STATE =================
let rawRows=[],transactions=[],headerRow=[],headerIndex=-1,visibleColIndexes=[];
let colIndex={date:-1,debit:-1,credit:-1,balance:-1,narration:-1};
let meta={bankName:"",branchName:"",customerName:"",accountNumber:"",loanLimit:null,openingBalance:null,sanctionDate:null,expiryDate:null};
let processed=false;

let specialInterestRows=[];
let specialInterestTotal=0;
let specialInterestRatePct=0;
let expiryPrincipalCached=0;

// ================= HELPERS =================
const parseNumber=v=>{
  if(v==null) return 0;
  let s=String(v).replace(/,/g,"").trim();
  let neg=false;
  if(/^\(.*\)$/.test(s)){neg=true;s=s.slice(1,-1).trim();}
  if(!s) return 0;
  let n=parseFloat(s);
  if(isNaN(n)) return 0;
  return neg?-n:n;
};
const formatMoney=v=>{
  if(v==null||isNaN(v)) return "";
  const neg=v<0;const abs=Math.abs(v);
  const f=abs.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  return neg?`(${f})`:f;
};
const toISO=d=>d?new Date(d).toISOString().slice(0,10):"";
function parseDate(s){
  if(!s) return null;
  let d1=new Date(s);
  if(!isNaN(d1)) return d1;
  let t=String(s).replace(/,/g,"").trim();
  let p=t.split(/[\s\/\-]+/);
  if(p.length>=3){
    let dd=parseInt(p[0],10);
    let mm=p[1];
    let yy=parseInt(p[2],10);
    const mMap={JAN:0,FEB:1,MAR:2,APR:3,MAY:4,JUN:5,JUL:6,AUG:7,SEP:8,SEPT:8,OCT:9,NOV:10,DEC:11};
    let m=mMap[String(mm).toUpperCase()];
    if(m==null) m=parseInt(mm,10)-1;
    if(yy<100) yy=2000+yy;
    if([dd,m,yy].some(x=>Number.isNaN(x))) return null;
    return new Date(Date.UTC(yy,m,dd));
  }
  return null;
}
function diffDays(a,b){
  if(!a||!b) return 0;
  return Math.max(0, Math.floor((b-a)/(1000*60*60*24)));
}
function nowLong(){
  return new Date().toLocaleString(undefined,{dateStyle:"long",timeStyle:"short"});
}
function norm(s){
  return String(s||"").toLowerCase().replace(/\s+/g," ").trim();
}

function findColumnIndexByNames(names){
  for(let i=0;i<headerRow.length;i++){
    const h=norm(headerRow[i]);
    if(names.includes(h)) return i;
  }
  return -1;
}

function escapeHtml(s){
  return String(s||"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/\"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

// ================= META DETECTION =================
function detectMeta(){
  meta.bankName = (rawRows[0] && rawRows[0][0]) ? String(rawRows[0][0]).trim() : "";
  meta.branchName = (rawRows[1] && rawRows[1][0]) ? String(rawRows[1][0]).trim() : "";
  meta.customerName = (rawRows[3] && rawRows[3][0]) ? String(rawRows[3][0]).trim() : "";

  meta.accountNumber = "";
  meta.loanLimit = null;
  meta.openingBalance = null;
  meta.sanctionDate = null;
  meta.expiryDate = null;

  for(let i=0;i<rawRows.length;i++){
    const row = rawRows[i] || [];
    for(let j=0;j<row.length;j++){
      const cell = row[j];
      if(cell == null) continue;
      const text = String(cell).trim();

      // Account Number / Contract ID
      if(!meta.accountNumber && /^account number\s*\/\s*contract id\s*:/i.test(text)){
        const after = text.split(":")[1];
        let candidate = (after || "").trim();
        if(!candidate && j+1 < row.length) candidate = String(row[j+1]||"").trim();
        meta.accountNumber = candidate;
      }

      // Opening Balance
      if(/account balance at period start/i.test(text) && meta.openingBalance == null){
        let val = null;
        if(j+1 < row.length) val = parseNumber(row[j+1]);
        if(val === 0){
          for(let k=0;k<row.length;k++){
            if(k===j) continue;
            const n = parseNumber(row[k]);
            if(n !== 0){ val = n; break; }
          }
        }
        meta.openingBalance = val;
      }

      // Loan Limit
      if(/loan limit/i.test(text) && meta.loanLimit == null){
        let afterColon = text.split(":")[1];
        let candidate = (afterColon || "").trim();
        if(!candidate){
          for(let k=0;k<row.length;k++){
            if(k===j) continue;
            if(row[k] != null && String(row[k]).trim()){
              candidate = String(row[k]).trim();
              break;
            }
          }
        }
        meta.loanLimit = parseNumber(candidate);
      }

      // Sanction & Expiry
      if(/sanction and expiry date/i.test(text) && (!meta.sanctionDate || !meta.expiryDate)){
        let afterColon = text.split(":")[1];
        let candidate = (afterColon || "").trim();
        if(!candidate && j+1 < row.length) candidate = String(row[j+1] || "").trim();
        if(candidate){
          let parts = candidate.split("-");
          if(parts.length >= 2){
            meta.sanctionDate = parseDate(parts[0].trim());
            meta.expiryDate = parseDate(parts[1].trim());
          }
        }
      }
    }
  }
}

function detectHeader(){
  headerIndex=-1;headerRow=[];
  for(let i=0;i<rawRows.length;i++){
    if((rawRows[i]||[]).some(x=>String(x).trim().toLowerCase()==="trans date")){
      headerIndex=i;headerRow=rawRows[i];break;
    }
  }
  if(headerIndex<0) throw new Error("Header not found (Trans Date)");

  colIndex.date = findColumnIndexByNames(["trans date"]);
  colIndex.debit = headerRow.findIndex(x=>/debit/i.test(String(x||"")));
  colIndex.credit = headerRow.findIndex(x=>/credit/i.test(String(x||"")));
  colIndex.balance = headerRow.findIndex(x=>/balance/i.test(String(x||"")));

  // narration/particulars/description
  colIndex.narration = findColumnIndexByNames(["narration","particulars","description","details","remarks","particular","narration details"]);
}

function detectVisible(){
  visibleColIndexes=[];
  headerRow.forEach((c,i)=>{
    let n=norm(c);
    if(n==="transaction rf - br") return;
    if(n==="dr/cr") return;
    visibleColIndexes.push(i);
  });
}

function buildTransactions(){
  transactions=[];
  for(let i=headerIndex+1;i<rawRows.length;i++){
    let r=rawRows[i];
    let dt=parseDate(r?.[colIndex.date]);
    if(!dt) continue;
    transactions.push({
      raw:r,
      date:dt,
      debit:parseNumber(r?.[colIndex.debit]),
      credit:parseNumber(r?.[colIndex.credit]),
      balance:parseNumber(r?.[colIndex.balance]),
      text:(r?.join(" ")||"").toLowerCase(),
      category:"",
      isInjected:false
    });
  }
  transactions.sort((a,b)=>a.date-b.date);
}

function pickNarrationColumn(){
  if(colIndex.narration >= 0) return colIndex.narration;
  for(let i=0;i<headerRow.length;i++){
    if([colIndex.date,colIndex.debit,colIndex.credit,colIndex.balance].includes(i)) continue;
    return i;
  }
  return -1;
}

function ensureKeyDatesExist(expDate, classDate){
  const have={};
  transactions.forEach(t=>{ have[toISO(t.date)] = true; });
  const narCol = pickNarrationColumn();

  const injectRow = (d, narrationText) => {
    const raw = new Array(headerRow.length).fill("");
    raw[colIndex.date] = toISO(d);
    if(narCol >= 0) raw[narCol] = narrationText;
    transactions.push({
      raw,
      date:new Date(d),
      debit:0,
      credit:0,
      balance:NaN,
      text:narrationText.toLowerCase(),
      category:"Ignore",
      isInjected:true
    });
  };

  const expStr = toISO(expDate);
  if(expStr && !have[expStr]) injectRow(expDate, "Expiry Date Balance B/F");

  const clsStr = toISO(classDate);
  if(clsStr && !have[clsStr]) injectRow(classDate, "Classification Date");

  transactions.sort((a,b)=>a.date-b.date);
}

function autoCategoryAll(expDate, classDate){
  const hasAny=(txt, arr)=>arr.some(k=>txt.includes(k));

  const kwLegal=[
    "mamla","courat fee","court fee","court","lawyer","advocate","attorney","legal","case","suit","mokaddoma","mukaddoma"
  ].map(s=>s.toLowerCase());

  const kwWithdraw=["cash withdrawal","atm withdrawal","withdrawal","withdraw"].map(s=>s.toLowerCase());
  const kwDeposit=["cash deposit","deposit"].map(s=>s.toLowerCase());

  transactions.forEach(t=>{
    if(t.category) return;
    const txt = String(t.text||"").toLowerCase();

    if(txt.includes("debit interest")){
      if(expDate && t.date <= expDate) t.category = "Interest In period";
      else if(expDate && t.date > expDate && t.date <= classDate) t.category = "Interest up to SMA";
      else t.category = "Interest after SMA";
      return;
    }

    if(hasAny(txt, kwLegal)){
      t.category = "Legal Cost";
      return;
    }

    // Transfer rule per your instruction
    if(txt.includes("transfer")){
      if((t.credit||0) > 0) t.category = "Deposit";
      else if((t.debit||0) > 0) t.category = "Other Cost";
      return;
    }

    if(hasAny(txt, kwWithdraw)){
      t.category = "Withdrawal";
      return;
    }

    if(hasAny(txt, kwDeposit)){
      t.category = "Deposit";
      return;
    }
  });
}

function buildMappingUI(){
  txHeader.innerHTML = "<tr><th>#</th>" + visibleColIndexes.map(i=>`<th>${headerRow[i]||""}</th>`).join("") + "<th>Category</th></tr>";
  txBody.innerHTML="";

  transactions.forEach((t,i)=>{
    const rowClass = t.isInjected ? "injected-row" : "";
    txBody.innerHTML +=
      `<tr class="${rowClass}"><td>${i+1}</td>` +
      visibleColIndexes.map(j=>`<td>${t.raw[j] ?? ""}</td>`).join("") +
      `<td><select data-i="${i}">
          <option></option>
          <option ${t.category==="Interest In period"?"selected":""}>Interest In period</option>
          <option ${t.category==="Interest up to SMA"?"selected":""}>Interest up to SMA</option>
          <option ${t.category==="Interest after SMA"?"selected":""}>Interest after SMA</option>
          <option ${t.category==="Withdrawal"?"selected":""}>Withdrawal</option>
          <option ${t.category==="Deposit"?"selected":""}>Deposit</option>
          <option ${t.category==="Other Cost"?"selected":""}>Other Cost</option>
          <option ${t.category==="Legal Cost"?"selected":""}>Legal Cost</option>
          <option ${t.category==="Ignore"?"selected":""}>Ignore</option>
        </select></td></tr>`;
  });
}

function readCategoriesFromUI(){
  document.querySelectorAll('select[data-i]').forEach(sel=>{
    const i=parseInt(sel.dataset.i,10);
    if(transactions[i]) transactions[i].category = sel.value;
  });
}

function getNarration(t){
  const narCol = pickNarrationColumn();
  if(narCol >= 0) return String(t.raw?.[narCol] || "").trim();
  return "";
}

function computeUnchargedInterest(rate, start, end){
  const pts = transactions
    .filter(t => t.date <= end)
    .slice()
    .sort((a,b)=>a.date-b.date);
  if(!pts.length) return 0;

  let curBal=null;
  let curDate=start;
  let acc=0;

  pts.forEach(p=>{
    if(p.date <= start){
      curBal = Math.abs(p.balance);
    } else {
      if(curBal != null){
        const days = diffDays(curDate, p.date);
        acc += curBal * (rate/360) * days;
      }
      curBal = Math.abs(p.balance);
      curDate = p.date;
    }
  });

  const tail=diffDays(curDate, end);
  if(tail>0 && curBal!=null) acc += curBal*(rate/360)*tail;
  return acc;
}

function makeReportHeaderHTML(title){
  const cStr=classificationDate.value;
  const rStr=reportingDate.value;
  const bank = meta.bankName||"";
  const branch = meta.branchName||"";
  const customer = meta.customerName||"";
  const acc = meta.accountNumber||"";
  const sanc = meta.sanctionDate ? toISO(meta.sanctionDate) : "";
  const exp = meta.expiryDate ? toISO(meta.expiryDate) : "";

  return `
    <div id="reportHeader">
      <div class="hdr-bank">${escapeHtml(bank)}</div>
      <div class="hdr-branch">${escapeHtml(branch)}</div>
      <div class="hdr-title">${escapeHtml(title)}</div>
      <div class="hdr-meta">
        Customer: ${escapeHtml(customer)} | Account: ${escapeHtml(acc)}<br>
        Sanction Date: ${escapeHtml(sanc)} | Expiry Date: ${escapeHtml(exp)}<br>
        Classification Date: ${escapeHtml(cStr)} | Reporting Date: ${escapeHtml(rStr)}
      </div>
    </div>
  `;
}

function openPrintWindow(title, bodyHtml){
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${escapeHtml(title)}</title>
  <style>
    body{font-family:system-ui,sans-serif;margin:16px;color:#111827}
    table{width:100%;border-collapse:collapse;font-size:11px}
    th,td{border:1px solid #d1d5db;padding:3px 4px;vertical-align:top}
    th{background:#f3f4f6}
    #reportHeader{text-align:center;margin:0 0 8px;padding:4px 0 6px;border-bottom:1px solid #d1d5db}
    #reportHeader .hdr-bank{font-size:18px;font-weight:700}
    #reportHeader .hdr-branch{font-size:14px;font-weight:600}
    #reportHeader .hdr-title{font-size:14px;font-weight:700;color:#2563eb;margin-top:2px}
    #reportHeader .hdr-meta{font-size:11px;color:#4b5563;margin-top:2px}
    .injected-row{background:#fff7ed;font-weight:700}
  </style></head><body>
  ${bodyHtml}
  </body></html>`);
  w.document.close();
  w.focus();
  w.print();
}

// ================= CSV LOAD =================
csvFile.onchange=async e=>{
  fileError.textContent="";
  processError.textContent="";
  calcError.textContent="";

  processed=false;
  mappingCard.style.display="none";
  resultsCard.style.display="none";
  calcBtn.disabled=true;

  try{
    rawRows=await parseFileToRows(e.target.files[0]);
    detectMeta();
    detectHeader();
    detectVisible();
    buildTransactions();

    bankName.value=meta.bankName;
    branchName.value=meta.branchName;
    customerName.value=meta.customerName;
    accountNumber.value=meta.accountNumber;
    loanLimit.value=formatMoney(meta.loanLimit);
    openingBalance.value=formatMoney(meta.openingBalance);
    sanctionDate.value=meta.sanctionDate?.toISOString().slice(0,10)||"";
    expiryDate.value=meta.expiryDate?.toISOString().slice(0,10)||"";

    processBtn.disabled=false;
  }catch(err){
    fileError.textContent=err?.message || String(err);
  }
};

// ================= PROCESS STATEMENT =================
processBtn.onclick=()=>{
  processError.textContent="";

  if(!transactions.length) return (processError.textContent="No transactions loaded.");
  if(meta.openingBalance == null || !meta.expiryDate) return (processError.textContent="Opening Balance or Expiry Date not found in CSV.");

  const cStr=classificationDate.value;
  const rStr=reportingDate.value;
  if(!cStr||!rStr) return (processError.textContent="Classification and Reporting Date required");

  const cDate=new Date(cStr+"T00:00:00");
  const rDate=new Date(rStr+"T00:00:00");
  if(meta.expiryDate && cDate <= meta.expiryDate) return (processError.textContent="Classification Date must be after Expiry Date");
  if(rDate < cDate) return (processError.textContent="Reporting Date must be on/after Classification Date");

  ensureKeyDatesExist(meta.expiryDate, cDate);
  autoCategoryAll(meta.expiryDate, cDate);

  mappingCard.style.display="block";
  buildMappingUI();

  processed=true;
  calcBtn.disabled=false;
};

// ================= CALCULATE =================
calcBtn.onclick=()=>{
  calcError.textContent="";

  if(!processed) return (calcError.textContent="Please click Process Statement first.");
  if(meta.openingBalance == null || !meta.expiryDate) return (calcError.textContent="Opening Balance or Expiry Date not found in CSV.");

  const cStr=classificationDate.value;
  const rStr=reportingDate.value;
  if(!cStr||!rStr) return (calcError.textContent="Classification and Reporting Date required");

  const cDate=new Date(cStr+"T00:00:00");
  const rDate=new Date(rStr+"T00:00:00");
  if(meta.expiryDate && cDate <= meta.expiryDate) return (calcError.textContent="Classification Date must be after Expiry Date");

  const gRate=parseFloat(generalRate.value)/100;
  const sRate=parseFloat(specialRate.value)/100;
  if(isNaN(gRate)||isNaN(sRate)) return (calcError.textContent="General and Special Rate must be valid numbers");
  specialInterestRatePct = sRate*100;

  readCategoriesFromUI();

  const expDate=meta.expiryDate;
  const OB=meta.openingBalance;

  let Wexp=0, Dexp=0, Dafter=0;
  let Iin=0, Isma=0, Ias=0;
  let OC=0, LC=0;
  let lastDebitInt=null;

  transactions.forEach(t=>{
    const d=t.date;
    const cat=t.category;

    const upExp = d <= expDate;
    const btExpRep = d > expDate && d <= rDate;

    if(cat==="Withdrawal" && upExp) Wexp += (t.debit||0);
    if(cat==="Deposit" && upExp) Dexp += (t.credit||0);
    if(cat==="Deposit" && btExpRep) Dafter += (t.credit||0);

    if(cat==="Interest In period") Iin += (t.debit||0);
    if(cat==="Interest up to SMA") Isma += (t.debit||0);
    if(cat==="Interest after SMA") Ias += (t.debit||0);

    if(cat==="Other Cost") OC += (t.debit||0);
    if(cat==="Legal Cost") LC += (t.debit||0);

    if(String(t.text||"").includes("debit interest")){
      if(!lastDebitInt || d > lastDebitInt) lastDebitInt = d;
    }
  });

  // expiry principal
  const expiryPrincipal = OB + Dexp + Wexp;
  expiryPrincipalCached = expiryPrincipal;

  // Special Interest (Diminishing Principal Method)
  specialInterestRows=[];
  specialInterestTotal=0;

  let principalSI = expiryPrincipal;
  let curDate = cDate;

  const depEvents = transactions
    .filter(t => t.category==="Deposit" && t.date > cDate && t.date <= rDate)
    .map(t => ({date:t.date, amount:(t.credit||0), narration:(getNarration(t) || `Deposit on ${toISO(t.date)}`)}))
    .sort((a,b)=>a.date-b.date);

  depEvents.forEach(ev=>{
    const days = diffDays(curDate, ev.date);
    if(days>0){
      const interest = -Math.abs(principalSI) * (sRate/360) * days;
      specialInterestRows.push({from:new Date(curDate), to:new Date(ev.date), narration: ev.narration, deposit: ev.amount, principal: principalSI, days, interest});
      specialInterestTotal += interest;
    }
    principalSI = principalSI + ev.amount;
    curDate = ev.date;
  });

  const tailDays = diffDays(curDate, rDate);
  if(tailDays>0){
    const interest = -Math.abs(principalSI) * (sRate/360) * tailDays;
    specialInterestRows.push({from:new Date(curDate), to:new Date(rDate), narration:"No deposit", deposit:0, principal: principalSI, days:tailDays, interest});
    specialInterestTotal += interest;
  }

  const specialInterest = specialInterestTotal;

  // uncharged interest
  const startUnc = lastDebitInt || cDate;
  const uncPos = computeUnchargedInterest(gRate, startUnc, rDate);
  const uncharged = -Math.abs(uncPos);

  // A‚ÄìL summary logic
  const B = Iin;
  const C = Isma + Ias;
  const D = B + C;
  const E = uncharged;
  const F = OC;
  const G = LC;

  const H = expiryPrincipal + D + E + F + G;
  const I = Dafter;
  const J = H + I;
  const K = H - E + I;

  const payableGeneral = Iin + Isma;
  const L = specialInterest + Iin + Isma + F + G;

  const totalCOF = expiryPrincipal + payableGeneral + F + G + specialInterest;
  const haveToPayCOF = totalCOF + I;

  const rows=[
    {sl:"", title:"Loan Limit", val:meta.loanLimit||0, bold:true},
    {sl:"A", title:"Expiry Principal", val:expiryPrincipal, bold:true},
    {sl:"B", title:"Inperiod Interest", val:B, bold:false},
    {sl:"C", title:"After Period Interest", val:C, bold:false},
    {sl:"D", title:"Total Interest", val:D, bold:true},
    {sl:"E", title:"Uncharged Interest", val:E, bold:false},
    {sl:"F", title:"Other Cost", val:F, bold:false},
    {sl:"G", title:"Legal Cost", val:G, bold:false},
    {sl:"H", title:"Total Liabilities", val:H, bold:true},
    {sl:"I", title:"Deposit After Expiry", val:I, bold:false},
    {sl:"J", title:"Have to Pay", val:J, bold:true},
    {sl:"K", title:"Ledger Balance", val:K, bold:true},
    {sl:"", title:"Special Interest (Diminishing Principal Method)", val:specialInterest, bold:true},
    {sl:"L", title:"Cost of Fund", val:L, bold:true},
    {sl:"", title:"Total Payable under COF", val:totalCOF, bold:true},
    {sl:"", title:"Have to Pay under COF", val:haveToPayCOF, bold:true},
  ];

  const tbody=document.querySelector("#summaryTable tbody");
  tbody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    if(r.bold) tr.className="summary-bold";
    tr.innerHTML=`<td>${r.sl||""}</td><td>${r.title}</td><td style="text-align:right">${formatMoney(r.val)}</td>`;
    tbody.appendChild(tr);
  });

  details.innerHTML = `
    <table>
      <tr><th>Item</th><th>Amount</th><th>Note</th></tr>
      <tr><td>Withdrawal up to Expiry</td><td style="text-align:right">${formatMoney(Wexp)}</td><td>Category = Withdrawal, date ‚â§ Expiry</td></tr>
      <tr><td>Deposit up to Expiry</td><td style="text-align:right">${formatMoney(Dexp)}</td><td>Category = Deposit, date ‚â§ Expiry</td></tr>
      <tr><td>Deposit After Expiry</td><td style="text-align:right">${formatMoney(I)}</td><td>Category = Deposit, Expiry &lt; date ‚â§ Reporting</td></tr>
      <tr><td>Interest In Period</td><td style="text-align:right">${formatMoney(Iin)}</td><td>Mapped from Debit Interest (up to Expiry)</td></tr>
      <tr><td>Interest up to SMA</td><td style="text-align:right">${formatMoney(Isma)}</td><td>Mapped from Debit Interest (Expiry‚ÜíClassification)</td></tr>
      <tr><td>Interest after SMA</td><td style="text-align:right">${formatMoney(Ias)}</td><td>Mapped from Debit Interest (after Classification)</td></tr>
      <tr><td>Other Cost</td><td style="text-align:right">${formatMoney(OC)}</td><td>Category = Other Cost</td></tr>
      <tr><td>Legal Cost</td><td style="text-align:right">${formatMoney(LC)}</td><td>Category = Legal Cost</td></tr>
      <tr><td>Uncharged Interest</td><td style="text-align:right">${formatMoney(E)}</td><td>From last Debit Interest (or Classification) to Reporting</td></tr>
      <tr><td>Special Interest</td><td style="text-align:right">${formatMoney(specialInterest)}</td><td>Diminishing Principal Method, from Classification to Reporting</td></tr>
    </table>
  `;

  hBank.textContent = meta.bankName||"";
  hBranch.textContent = meta.branchName||"";
  hCustomer.textContent = meta.customerName||"";
  hAcc.textContent = meta.accountNumber||"";
  hClassDate.textContent = cStr||"";
  hReportDate.textContent = rStr||"";
  sigDate.textContent = nowLong();

  resultsCard.style.display="block";
  resultsCard.scrollIntoView({behavior:"smooth"});
};

previewBtn.onclick=()=>{
  if(resultsCard.style.display !== "block"){
    calcError.textContent = "Please Calculate & Preview first.";
    return;
  }
  resultsCard.scrollIntoView({behavior:"smooth"});
};

// ================= PDF: SUMMARY =================
pdfBtnMain.onclick=()=>{
  const el=document.getElementById("resultsCard");
  if(el.style.display!=="block") return alert("Please Calculate first.");
  openPrintWindow("COF Summary Report", el.outerHTML);
};

// ================= PDF: SPECIAL INTEREST SHEET =================
pdfBtnSpecial.onclick=()=>{
  if(!specialInterestRows.length) return alert("Please Calculate first.");

  const tpl=document.getElementById("specialInterestTemplate");
  const clone=tpl.content.cloneNode(true);
  const container=clone.querySelector("#specialInterestContainer");

  container.querySelector(".si-bank").textContent = meta.bankName||"";
  container.querySelector(".si-branch").textContent = meta.branchName||"";
  container.querySelector(".si-customer").textContent = meta.customerName||"";
  container.querySelector(".si-account").textContent = meta.accountNumber||"";

  const cStr=classificationDate.value;
  const rStr=reportingDate.value;
  container.querySelector(".si-class-date").textContent = cStr;
  container.querySelector(".si-report-date").textContent = rStr;
  container.querySelector(".si-rate").textContent = (specialInterestRatePct||0).toFixed(2);
  container.querySelector(".si-generated-at").textContent = nowLong();
  container.querySelector(".si-start").textContent = formatMoney(expiryPrincipalCached);

  const tbody=container.querySelector(".si-body");
  tbody.innerHTML="";
  specialInterestRows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td style="border:1px solid #d1d5db;padding:3px 4px">${toISO(r.from)} ‚Üí ${toISO(r.to)}</td>
      <td style="border:1px solid #d1d5db;padding:3px 4px">${escapeHtml(r.narration||"")}</td>
      <td style="border:1px solid #d1d5db;padding:3px 4px;text-align:right">${formatMoney(r.deposit)}</td>
      <td style="border:1px solid #d1d5db;padding:3px 4px;text-align:right">${formatMoney(r.principal)}</td>
      <td style="border:1px solid #d1d5db;padding:3px 4px;text-align:right">${r.days}</td>
      <td style="border:1px solid #d1d5db;padding:3px 4px;text-align:right">${formatMoney(r.interest)}</td>
    `;
    tbody.appendChild(tr);
  });

  container.querySelector(".si-total").textContent = formatMoney(specialInterestTotal);

  const wrapper=document.createElement("div");
  wrapper.appendChild(container);
  const html = wrapper.innerHTML; // template already contains the header
openPrintWindow("Special Interest (Diminishing Principal Method)", html);

};
// ================= PDF: TRANSACTION STATEMENT =================
pdfBtnStatement.onclick=()=>{
  if(!processed) return alert("Please click Process Statement first.");
  readCategoriesFromUI();

  const narCol = pickNarrationColumn();
  const rows = transactions.map((t,idx)=>({
    sl: idx+1,
    date: toISO(t.date),
    narration: (narCol>=0 ? String(t.raw?.[narCol]||"").trim() : ""),
    debit: t.debit || 0,
    credit: t.credit || 0,
    balance: (isNaN(t.balance) ? "" : t.balance),
    category: t.category || "",
    isInjected: !!t.isInjected
  }));

  let table = `
    <table>
      <thead>
        <tr>
          <th style="width:5%">SL</th>
          <th style="width:11%">Date</th>
          <th>Narration</th>
          <th style="width:12%">Debit</th>
          <th style="width:12%">Credit</th>
          <th style="width:14%">Balance</th>
          <th style="width:14%">Category</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr class="${r.isInjected?"injected-row":""}">
            <td>${r.sl}</td>
            <td>${escapeHtml(r.date)}</td>
            <td>${escapeHtml(r.narration)}</td>
            <td style="text-align:right">${formatMoney(r.debit)}</td>
            <td style="text-align:right">${formatMoney(r.credit)}</td>
            <td style="text-align:right">${r.balance===""?"":formatMoney(r.balance)}</td>
            <td>${escapeHtml(r.category)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  const html = makeReportHeaderHTML("Transaction Statement with Classification") + table + `<div style="margin-top:10px;font-size:11px;color:#4b5563">Generated: ${escapeHtml(nowLong())}</div>`;
  openPrintWindow("Transaction Statement with Classification", html);
};

// ================= CSV EXPORT =================
downloadCsvBtn.onclick=()=>{
  if(!transactions.length) return alert("No statement loaded.");
  readCategoriesFromUI();

  const out=[];
  const h = visibleColIndexes.map(i=>headerRow[i]);
  h.push("Category");
  out.push(h);

  transactions.forEach(t=>{
    const row = visibleColIndexes.map(i=>t.raw?.[i] ?? "");
    row.push(t.category || "");
    out.push(row);
  });

  let csv="";
  if(window.Papa && typeof Papa.unparse === 'function') csv = Papa.unparse(out);
  else csv = out.map(r=>r.map(v=>String(v??"").replace(/\n/g," ")).join(",")).join("\n");

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="classified_statement.csv";
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
